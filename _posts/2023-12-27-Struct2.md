---
layout: post
title: Structs2漏洞复现
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: shzqi
---

##  搭建环境

https://lanvnal.com/2020/12/15/struts2-lou-dong-fen-xi-huan-jing-da-jian/   推荐这篇文章亲测有效

## struts是什么

```java
官网上写的是：Apache Struts是一个开源的MVN框架，用于创建Java Web应用程序。它支持约定优于配置，可使用插件架构进行扩展，并附带支持REST、AJAX和JSON的插件。
```

本地配置的struts版本是

```java
<dependency>
      <groupId>org.apache.struts</groupId>
      <artifactId>struts2-core</artifactId>
      <version>2.0.8</version>
    </dependency>
    <dependency>
```

### s0001漏洞分析

漏洞效果：会直接执行我们的表达式跟以下流程

![image-20231227192208847](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227192208847.png)

首先就是我们的首页.jsp，跳转到/login页面

![image-20231227194646804](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227194646804.png)

通过查看struts.xml的配置可以发现，指向了LoginAction类

![image-20231227194703822](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227194703822.png)

```
LoginAction extends ActionSupport  继承了ActionSupport类，并且重写了execute方法
通过前面我们可以知道，下面三种结果一种也没调用到
```

![image-20231227195014458](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227195014458.png)

懵逼了，没懂就看到index.jsp用到了taglib自定义标签，但是也没啥内容，这里经过了一次报错把

`E:\tomcat\apache-tomcat-9.0.65\bin`中的jdwp语句删除即可

![image-20231227210722094](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227210722094.png)

这里首先会执行到`LoginAction#execute()`

![image-20231227210814243](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227210814243.png)

然后进入了getBean方法，可以发现stack是`OnglValueStack`

![image-20231227211113532](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227211113532.png)

最后调用`doEngTag`方法，页面就会回显（ `最后只能知道是用ongl进行解析的详细的流程没找到`）

![image-20231227211955921](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227211955921.png)

既然发现是用ongl进行表达式解析，直接断点下在`Ognl#parseExpression`

![image-20231227213414013](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227213414013.png)

发现主要的漏洞点是tag自定义的任意标签，然后调入end方法，传入参数

![image-20231227214401766](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227214401766.png)

最终在这里进行`ognl 表达式解析`

![image-20231227213938925](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231227213938925.png)
