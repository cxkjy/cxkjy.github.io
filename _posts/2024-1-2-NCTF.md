---
layout: post
title: Structs2漏洞复现
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: shzqi
---



## logging

> Hint 1: 可以换个角度 尝试如何让 Spring 控制台报错?
> Hint 2: 确实是 log4j 2 rce (CVE-2021-44228)
> Hint 3: fuzz (尝试将 payload 放入某个 HTTP Header)

反编译jar包啥都没有，有log4j依赖，结合提示就是让报错，然后存储在日志中

首先测试发现是可以通的直接拿工具了，JNDI-Injection-Exploit

![image-20240105164320802](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105164320802.png)

![image-20240105164504720](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105164504720.png)

## EvilMQ

```java
Hint 1: 请关注题目名称 “EvilMQ” 并结合最近的已知公开漏洞
Hint 2: 与 ActiveMQ (CVE-2023-46604) 类似 但是 Client 端 RCE 需要构造 Evil Server
```

 ActiveMQ (CVE-2023-46604) 那就先复现一下这个漏洞

```java
影响版本：
Apache ActiveMQ < 5.18.3
Apache ActiveMQ < 5.17.6
Apache ActiveMQ < 5.16.7
Apache ActiveMQ < 5.15.16
```

学到了github比对版本差异的一个小方法

在github url地址后面加一个，/compare进行比较

`base是之前的版本，compare是之后的`

![image-20240105181808805](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105181808805.png)

下面是实现的效果，感觉在通过漏洞修复去复现漏洞的时候蛮有用的

![image-20240105181902557](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105181902557.png)

这里发现了这样的一个改变，限制了必须是Throwable的子类

![image-20240105182753096](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105182753096.png)

以前也见过这样的漏洞就是为了防治实例化任意的类对象，看下面的代码，绿色的是新版本添加的，如果没有`validateIsThrowable`不就有任意实例化String有参构造方法了嘛？

（正好前几篇的postgrasql也是这样子造成的漏洞，进一步触发EL、然后fileoutput情况指定文件这种）

![image-20240105183016311](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105183016311.png)

所以我们可以确定，污点就是`BaseDataStreamMarshaller.java`这个类，（刚回去看了看postgresql那个CVE，真的是一模一样连漏洞出发点，修复方案都一样）

`org.springframework.context.support.ClassPathXmlApplicationContext`

```java
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">
<!--    普通方式创建类-->
   <bean id="exec" class="java.lang.ProcessBuilder" init-method="start">
        <constructor-arg>
          <list>
           
            <value>calc.exe</value>
          </list>
        </constructor-arg>
    </bean>
</beans>
```

直接实例化触发校验一下（。。。真的不会搞环境，搞了1个小时，最后直接导了个jar包）

发现`BaseDataStreamMarshaller是一个抽象类`，找他的子类，这里找的是ExceptionResponseMarshaller

![image-20240105193721382](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105193721382.png)

`createThrowable`是一个私有的方法

![image-20240105193951459](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105193951459.png)

```java
到这里我自己想的就是，逐层调用，直到一个我们能控制的页面，比如jsp、或者反序列化，传参点这种
```

继续网上找发现仍然不是public权限，是一个包权限

![image-20240105194531622](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105194531622.png)

接着就是我们上面的那个类的方法，`ExceptionResponseMarshaller#tightUnmarshal`，这样就成了public都是可以调用的，到这里已经可以手动触发漏洞，但是还差一点

![image-20240105194816638](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105194816638.png)

到这里卡住了，调用`tightUnmarshal`的方法实在太多了不知道用哪一个。。。（如果一个个实验的话感觉不太对)

![image-20240105195154972](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105195154972.png)

看了看师傅们写的文章大体看懂了先总结一下（明天在详细分析）

```java
doUnmarshal  就相当于一个反序列化
```

![image-20240105214127875](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214127875.png)

![image-20240105214218561](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214218561.png)

这个 dataType 其实对应的就是 Message 类内部的 `DATA_STRUCTURE_TYPE` 字段

但是默认的demo 中我们发送的是一个 ObjectMessage (ActiveMQObjectMessage) 对象, 它的 dataType 是 26

![image-20240105214340742](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214340742.png)

我的第一想法就是直接改成31不就行了嘛(这里还没懂，下面是佬们的想法)

```java
我一开始的思路是去修改 ObjectMessage 的 DATA_STRUCTURE_TYPE 字段, 把它改成 31 然后发送

后来想了一会发现不能这么搞, 因为对于不同的 Message 类型, 序列化器会单独进行处理, 比如调用 writeXXX 和 readXXX 的类型和次数都不一样
```

然后目光放到了传参这里，dataType是从dis中获得的，那么控制dis不就可以控制dataType了嘛~~~

![image-20240105214725528](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214725528.png)

就是在这里

![image-20240105214852297](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214852297.png)

![image-20240105215045552](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105215045552.png)





