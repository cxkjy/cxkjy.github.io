---
layout: post
title: tabbyçš„å®‰è£…åŠç®€å•ä½¿ç”¨
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: azeril.compu
---

```java
è¿™ä¸ªä¸œè¥¿å¤§æ¦‚æˆ‘å»å¹´å°±åœ¨å®‰è£…åªä¸è¿‡å› ä¸ºç§ç§è‹¦éš¾æœ€åæ”¾å¼ƒäº†ï¼Œç°åœ¨æƒ³æƒ³å…¶å®å½“æ—¶å·²ç»æˆåŠŸäº†å”‰ã€‚
javaè¿™ä¸œè¥¿çœŸçš„å­¦ä¸€æ®µæ—¶é—´å¾€åä¸€çœ‹è›®æœ‰è¶£çš„
```

`E:\Tabby\tt\tabby-master\build\libs`

`E:\Tabby\tabby1.2.0\tabby`  äºŒä¸ªä¸åŒçš„ç‰ˆæœ¬

```java
è¿™æ˜¯æˆ‘tabbyçš„å®‰è£…ä½ç½®ï¼Œç„¶ååªéœ€è¦æ›´æ¢jarsæ–‡ä»¶ä¸­çš„jaråŒ…å³å¯
```

![image-20231124195048917](..\img\final\image-20231124195048917.png)

`java -Xmx6g -jar tabby.jar` è¿è¡Œå‘½ä»¤å³å¯,ä»£ç è¿è¡Œå®Œè¿è¡Œneo4jæŸ¥æ‰¾å³å¯

https://github.com/wh1t3p1g/tabby/blob/master/doc/Tabby%20%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8C%97.md

### åœ¨é¡¹ç›®ä¸­å¦‚ä½•å¯¼å‡ºjaråŒ…ï¼ˆé€šè¿‡æ„å»ºå·¥ä»¶ï¼‰

æœ¬åœ°æ˜¯ideaä¸“ä¸šç‰ˆä¸å¯ç”¨ï¼Œéœ€è¦ç”¨ç¤¾åŒºç‰ˆ

![image-20231124200936587](..\img\final\image-20231124200936587.png)

ç„¶åé‡æ–°æ„å»ºå³å¯ï¼Œç„¶åæŠŠç”Ÿæˆçš„jaråŒ…æ‹–è¿›jarsç›®å½•å³å¯

![image-20231124200950049](..\img\final\image-20231124200950049.png)

## å‘½ä»¤

:sysinfo,å°†èƒ½çœ‹åˆ°æ•°æ®åº“çš„å­˜å‚¨ä¿¡æ¯

:schema

```java
match (source:Method {NAME:"execute"})
match (sink:Method {IS_SINK:true, NAME:"getInstance"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 20) yield path 
return * limit 20
```

`match()`è¡¨ç¤ºåŒ¹é…å“ªäº›èŠ‚ç‚¹ï¼Œç±»ä¼¼SQLä¸­çš„selectã€‚

åœ¨ `match (source:Method {NAME:"execute"})`è¿™ä¸€å¥ä¸­ï¼Œ`source`æ˜¯åˆ«åï¼Œ`Method`æ˜¯èŠ‚ç‚¹ç±»å‹ï¼Œ`{NAME:"execute"}`æ˜¯åŒ¹é…çš„èŠ‚ç‚¹å†…å®¹ã€‚è¿™äº›æ•°æ®æ¥è‡ªäºTabbyç”Ÿæˆçš„csvæ–‡ä»¶ã€‚

èŠ‚ç‚¹æ•°æ®ä¸€èˆ¬éƒ½æ˜¯ç±»JSONæ ¼å¼çš„ã€‚åœ¨Tabbyä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„èŠ‚ç‚¹ç±»å‹ï¼š`Method`å’Œ`Class`ã€‚

æŸ¥è¯¢`match (source:Method)return *`è¿”å›å…¨å›¾ç±»çš„è°ƒç”¨ï¼Œä½†ä¼šå¾ˆå¡ï¼ˆæ— ç”¨ï¼‰



æŸ¥è¯¢æ‰€æœ‰æ–¹æ³•åä¸º`excute`çš„è¯­å¥:`match(source:Method {NAME:"execute"}) return *`ã€‚

![image-20231124202605021](..\img\final\image-20231124202605021.png)

Neo4jå›¾æ•°æ®åº“è¿˜æœ‰ä¸€ä¸ªå¯æŸ¥è¯¢çš„æ•°æ®ï¼šå…³ç³»è¾¹ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æ¨¡æ¿ä¸­`match (sink:Method {IS_SINK:true, NAME:"getInstance"})<-[:CALL]-(m1:Method)`è¿™ä¸€å¥ã€‚åŒæ ·æ˜¯`match()`æ–¹æ³•ï¼Œåªä¸è¿‡åé¢å¤šäº†`<-[:CALL]-(m1:Method)`ã€‚è¿™ä¸ªæ˜¯Neo4jä¸­å…³ç³»æŸ¥è¯¢çš„è¯­æ³•ã€‚

Neo4jä¸­æœ‰ä¸‰ç§æŒ‡å‘ï¼š`() - [] -> ()`ã€`() <- [] - ()`å’Œ`() - [] - ()`ã€‚é¡¾åæ€ä¹‰ï¼Œå‰ä¸¤ç§å°±æ˜¯çœ‹ç®­å¤´æ–¹å‘è¡¨ç¤ºå¯¹åº”çš„å•é¡¹å…³ç³»ï¼›æœ€åä¸€ç§è¡¨ç¤ºåŒå‘å…³ç³»ã€‚

å·¦å³ä¸¤è¾¹è¡¨ç¤º**æŸ¥è¯¢çš„èŠ‚ç‚¹**ï¼Œåœ¨è¯¥ä¾‹ä¸­ï¼Œå·¦è¾¹`(sink:Method {IS_SINK:true, NAME:"getInstance"})`å°±æ˜¯æŠŠæ–¹æ³•åä¸º`getInstance`ã€å¹¶ä¸”é¢„è®¾è§„åˆ™åŒ¹é…æ˜¯SINKçš„èŠ‚ç‚¹æŸ¥å‡ºæ¥ï¼›å³è¾¹`(m1:Method)`è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰çš„æ–¹æ³•ï¼›ä¸­é—´è¡¨ç¤º**å…³ç³»**ã€‚è¿™é‡Œçš„å…³ç³»æ˜¯`[:CALL]`è°ƒç”¨å…³ç³»ï¼›ç®­å¤´æ–¹å‘æ˜¯`() <- [] - ()`ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„æŒ‡å‘æ˜¯ä»å³åˆ°å·¦ï¼›å…¨éƒ¨ç»“åˆèµ·æ¥çœ‹å°±æ˜¯ï¼š**åœ¨æ‰€æœ‰æ–¹æ³•ä¸­ï¼Œç­›é€‰`getInstance`æ–¹æ³•çš„è°ƒç”¨è€…**ã€‚



æ¨¡æ¿ç¬¬ä¸‰å¥æ˜¯`call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 20) yield path`ã€‚è¿™æ˜¯è°ƒç”¨äº†ä¹‹å‰ç»™Neo4jå®‰è£…çš„æ’ä»¶`apoc`ã€‚`apoc.algo.allSimplePaths`è¯­æ³•æ˜¯ï¼š

```
apoc.algo.allSimplePaths(startNode :: NODE?, endNode :: NODE?, relationshipTypesAndDirections :: STRING?, maxNodes :: INTEGER?) :: (path :: PATH?)
```

è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯è¿”å›`startNode`åˆ°`endNode`ä¹‹é—´çš„å…³ç³»è·¯å¾„ã€‚è¯¥å‡½æ•°æœ‰å››ä¸ªè¾“å…¥å‚æ•°ï¼š

- `startNode` - å¼€å§‹èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯Source
- `endNode` - ç»“æŸèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯Sink
- `relationshipTypesAndDirections` - Neo4jçš„å…³ç³»è¾¹ï¼Œç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä»¥è®¾ç½®ä¸ºå¤šä¸ªå…³ç³»ã€‚æŸ¥è¯¢æ—¶ä¼šæŒ‰ç…§è¿™ä¸ªå…³ç³»è¿›è¡Œè·¯å¾„å›¾çš„æŸ¥æ‰¾
- `maxNodes` - æœç´¢çš„æœ€å¤§èŠ‚ç‚¹æ•°ï¼Œä¹Ÿå°±æ˜¯è·¯å¾„æ·±åº¦ã€‚æ³¨æ„åƒä¸‡ä¸èƒ½è®¾å¤ªå¤§ï¼Œå°¤å…¶æ˜¯èŠ‚ç‚¹å¾ˆå¤šçš„æ—¶å€™ã€‚

åŒæ—¶è¿˜æœ‰ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼š

- `path` - æ²¡çœ‹åˆ°æ–‡æ¡£æœ‰ç‰¹åˆ«è¯´æ˜233ï¼Œçœ‹åˆ°[æ–‡æ¡£](https://neo4j.com/labs/apoc/4.0/algorithms/path-finding-procedures/)ä¸­ç»™çš„éƒ½æ˜¯`YIELD path, weight`ã€‚æ‹¿å°±ç…§ç€[æ–‡æ¡£](https://neo4j.com/labs/apoc/4.0/algorithms/path-finding-procedures/)æ¥å§

äº†è§£å®Œæ¯ä¸ªè¯­å¥çš„åŠŸèƒ½åï¼Œå†çœ‹å›æ¨¡æ¿å¯ä»¥çŸ¥é“ï¼šè¯¥æ¨¡æ¿å°†æ–¹æ³•åä¸º`execute`çš„èŠ‚ç‚¹ä½œä¸ºSourceï¼›å°†è°ƒç”¨æ–¹æ³•åä¸º`getInstance`ã€ä¸”åœ¨`/rules/knowledges.json`è®¾ç½®è¿‡è§„åˆ™çš„èŠ‚ç‚¹**è°ƒç”¨è€…**è®¾ç½®ä¸ºSinkï¼›æœ€åè°ƒç”¨`allSimplePaths`æœç´¢å…³ç³»è¾¹ä¸º`CALL`å’Œ`ALIAS`çš„è°ƒç”¨è·¯å¾„ï¼Œè¿”å›20ä¸ªç»“æœã€‚

```
match (source:Method {NAME:"execute"})
match (sink:Method {IS_SINK:true, NAME:"getInstance"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 20) yield path 
return * limit 20
```

ä½†è¿™ä¸ªæŸ¥è¯¢è¯­å¥åœ¨æˆ‘ä»¬çš„è¿™ä¸ªç¨‹åºé‡Œæ˜¯æŸ¥ä¸åˆ°ä¸œè¥¿çš„ï¼Œå› ä¸ºæ²¡æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•çš„é€šè·¯ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ è¿™æ ·çš„æŸ¥è¯¢è¯­å¥ï¼šæŸ¥çœ‹Tomcatä¸­`doFilter()`åˆ°`service()`çš„é€šè·¯æƒ…å†µã€‚

```
match (source:Method {NAME:"doFilter"})
match (sink:Method {NAME:"service"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 20) yield path 
return * limit 20
```

```java
match (source:Method {NAME:"readObject"})
match (sink:Method {NAME:"toString"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL", 20) yield path 
return * limit 20
```



## 	å…¥é—¨çš„demoï¼ˆçº¯æ–°æ‰‹å…¥é—¨ï¼Œå¯ä»¥è·³è¿‡ğŸ¤«ğŸ¤«ï¼‰

```java
match(source:Method) where source.NAME ="readObject" return source limit 10;
match (source:Method {NAME:"readObject"}) return source limit 10;
```

ä¸Šé¢çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ä¸Šé¢åªæ˜¯å•çº¯çš„æ‰¾æŒ‡å®šçš„æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªé€šè·¯

```java
match path=(source:Method)-[:CALL]->(sink:Method)
where source.NAME=~"get.+" and sink.NAME="readObject"
return path
```

çœ‹ç€åƒæ˜¯getterè°ƒç”¨åˆ°readObjectçš„ä¸€ä¸ªé€šè·¯æŸ¥æ‰¾ï¼Œ

```java
match path=(source:Method)-[:CALL]->(sink:Method)
where source.NAME =~ "get.+" and sink.NAME="readObject"
return path
```

å‘ç°åªæœ‰äº”ä¸ªèŠ‚ç‚¹ï¼Œç®€å•åˆ†æä¸€æ³¢	

![image-20231124230042489](..\img\final\image-20231124230042489.png)

å¥½ç¥å¥‡ï¼ŒSealedObject#getObjectæ–¹æ³•é‡Œé¢å°±æœ‰readObject

![image-20231124230246649](..\img\final\image-20231124230246649.png)

sun.awt.datatransfer#TransferableProxy

![image-20231124230701106](..\img\final\image-20231124230701106.png)

![image-20231124232255539](..\img\final\image-20231124232255539.png)

çœ‹äº†ä¸€ä¸‹å·¦è¾¹æ˜¯å³è¾¹æ¥å£çš„å®ç°ç±»ï¼Œ[:CALL]æ€ªä¸å¾—ç”¨CALLï¼Œå› ä¸ºå›¾ä¸­å°±æ˜¯è¿™æ ·å†™çš„

```java
match (source:Method)-[:CALL|ALIAS*..3]->(sink:Method)
```

å¦‚æœè¿™ä¸ªé“¾å­ä¸çŸ¥é“æœ‰å¤šé•¿ï¼Œå¯ä»¥ç”¨`*..3`è¿™ç§æ–¹å¼å¤§æ¦‚é™åˆ¶ä¸€ä¸‹é“¾çš„æœ€å¤§é•¿åº¦ã€‚

å†åˆ†æä¸€ä¸‹ALIASè¿›è¡Œä¸€ä¸ªåˆ†æï¼Œè¯å®ä¸€ä¸‹ä¸Šé¢çš„æƒ³æ³•ï¼Œè¯å®æˆåŠŸï¼Œæ˜¯æ¥å£æŒ‡å‘äº†å®ç°ç±»

![image-20231124232650396](..\img\final\image-20231124232650396.png)

## æ¸…åº“å‘½ä»¤

```java
MATCH(n) DETACH DELETE n
```

## tabbyå­ç±»æˆ–æ¥å£

```java
match (source:Method {NAME:"nextElement"})
                    <-[:HAS]-(cls:Class)-[:INTERFACE|EXTENDS*]
                    ->(cls1:Class {NAME:"java.util.Enumeration"})
match (source)-[:CALL]->(m1:Method)
```

sourceçš„å‡½æ•°æ˜¯nextElementå¹¶ä¸”å®ç°äº† java.util.Enumerationæ¥å£

## tabbyå®è·µå­¦ä¹ 

ä»java.util.HashMap#readObject------------->toStringæ–¹æ³•çš„é“¾å­ï¼Œä¸‹é¢æ˜¯é»‘åå• 

```java
match (source:Method {NAME:"readObject",CLASSNAME:"java.util.HashMap"})
match (sink:Method {NAME:"toString"})
with source,collect(sink) as sinks
call tabby.algo.findJavaGadget(source,sinks,12,false,false/true) yield path
where none(n in nodes(path) where n.CLASSNAME in ["javax.management.BadAttributeValueExpException","com.sun.jmx.snmp.SnmpEngineId","com.sun.xml.internal.ws.api.BindingID","javax.swing.text.html.HTML$UnknownTag"])
return path limit 1
```

è§„å®šäº†èµ·å§‹æºç‚¹ï¼Œæ±¡ç‚¹æ˜¯invokeæ–¹æ³•

```java

match (source:Method) where source.NAME in ["equals","hashCode","compareTo"] 
    
with collect(source) as sources
match (sink:Method {IS_SINK:true}) where sink.NAME =~ "invoke" and sink.VUL =~ "CODE" and sink.CLASSNAME =~ "java.lang.reflect.Method"
with sources, collect(sink) as sinks
call tabby.algo.allSimplePaths(sinks,sources, 15, false) yield path 
where none(n in nodes(path) where (n.CLASSNAME =~ "java.util.Iterator" or n.CLASSNAME =~ "java.util.Enumeration" or n.CLASSNAME =~ "java.util.Map" or n.CLASSNAME =~ "java.util.List" or n.CLASSNAME=~"jdk.nashorn.internal.ir.UnaryNode" or n.CLASSNAME=~"com.sun.jndi.ldap.ClientId" or n.CLASSNAME=~"org.apache.catalina.webresources.TrackedInputStream"))
return path limit 1
    ç”±äºç‰ˆæœ¬çš„å·®å¼‚ï¼Œä¸Šé¢çš„éœ€è¦è½¬æ¢æˆä¸‹é¢è¿™æ ·çš„æ ¼å¼
match (source:Method {NAME:"readObject"})
match (sink:Method {NAME:"toString"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL", 20) yield path 
return * limit 20
```

1.ç›®æ ‡æ–¹æ³•éœ€è¦ä¸ºpublic å’Œ staticçš„
2.sinkå¯ä»¥ä¸ºä»£ç æ‰§è¡Œï¼Œå†™æ–‡ä»¶ï¼Œè¿œç¨‹ç±»åŠ è½½ç­‰

```java
match (m1.Method) where m1.VUL="CODE" and m1.IS_STATIC=true and m1.IS_PUBLIC=true
return m1 limit 50
```

VULå°±ç›¸å½“äºæ¼æ´çš„æ„æ€ï¼Œæ­¤å¤„æ—¶ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå°±æ˜¯CODE

![image-20231206115003901](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231206115003901.png)

#### æ— å‚æ•°getteræ–¹æ³•è°ƒç”¨lookup

```java
match path=(m1:Method)-[:CALL*..10]->(m2:Method {IS_SINK:true}) where m1.NAME =~ "get.*" and m1.PARAMETER_SIZE=0 and m2.VUL="JNDI" and m2.NAME="lookup"
return path limit 2
```



### Method



```java
CLASSNAME: java.lang.Class
HAS_DEFAULT_CONSTRUCTOR: false    æœ‰æ— é»˜è®¤æ„é€ æ–¹æ³•
HAS_PARAMETERS: true              æ„é€ æ–¹æ³•ä¸­æœ‰å‚æ•°
IS_ABSTRACT: false                æ˜¯å¦æ˜¯æŠ½è±¡ ç±»
IS_ACTION_CONTAINS_SWAP: false     
IS_GETTER: false  æ˜¯å¦æ˜¯getteræ–¹æ³•
IS_PUBLIC: true
IS_SETTER: false
IS_SINK: true
IS_SOURCE: false
NAME: invoke
NAME0: sun.reflect.misc.MethodUtil.invoke
PARAMETER_SIZE: 3  
SIGNATURE: <java.lang.Class: java.lang.Class forName(java.lang.String,boolean,java.lang.ClassLoader)>
SUB_SIGNATURE: java.lang.Class forName(java.lang.String,boolean,java.lang.ClassLoader)
ä¸Šé¢å°±æ˜¯è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹é‚£äº›ä¸œè¥¿
VUL: CODE  æ¼æ´ç±»å‹ï¼Œæ¯”å¦‚jndiå°±æœ‰JNDIè¿™ç§
```

#### CALL

```java
INVOKER_TYPE: InterfaceInvoke  æ²¡å•¥ç”¨ï¼Œå› ä¸ºæˆ‘çœ‹CALLçš„éƒ½æ˜¯è¿™ä¸ª
REAL_CALL_TYPE: com.alibaba.fastjson2.reader.ObjectReader   è¢«è°ƒç”¨ç±»çš„ç±»å‹ï¼Œæ¯”å¦‚ getter-->readobjecté‚£ä¹ˆè¿™å°±æ˜¯readobjectçš„ç±»å‹
```

é€šè¿‡ä¸Šé¢äºŒç§è§„åˆ™ï¼Œæˆ‘ä»¬ä¸å°±å¯ä»¥æƒ³è°ƒç”¨ä»€ä¹ˆå°±è°ƒç”¨ä»€ä¹ˆ

å‚è€ƒæ–‡çŒ®ï¼šhttps://mp.weixin.qq.com/s/u7RuSmBHy76R7_PqL8WJww
