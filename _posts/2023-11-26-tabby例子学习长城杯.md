---
layout: post
title: hashmap反序列化#equals
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: 
---





### 前言

```java
最近发现自己对打CTF的热情逐渐减少了（可能是自己大三了唉老了），但却对课本越来越感兴趣了，但对我的java热情也极具增高，尤其是最近多了tabby这个爱妃高兴了好几天了，接下来就学学如何使用她
```

### 正文

😍✌真好附件直接给出了，不用费工夫去找附件了。

备用：[b4bycoffee_f18028284cae793d0b1da80146f01bd0.zip](https://l3yx.github.io/resource/b4bycoffee_f18028284cae793d0b1da80146f01bd0.zip)

```java
rome 1.7
Springboot
jackson
```

考察的rome反序列化，rome经典打法就是直接 signObject二次反序列化

![image-20231126180340425](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126180340425.png)

#### Hashmap+Rome

```java
HashMap::readObject->hash->key.hashcode
ObjectBean::hashCode
       EqualsBean::beanHashCode
                     ObjectBean::toString()
                            ToStringBean::toString() 
                                   ToStringBean::toString()方法中的 invoke执行
```

#### 二次反序列化

 ```java
 getObject:177, SignedObject (java.security)
 invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
 invoke:62, NativeMethodAccessorImpl (sun.reflect)
 invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
 invoke:498, Method (java.lang.reflect)
 beanEquals:146, EqualsBean (com.sun.syndication.feed.impl)
 equals:103, EqualsBean (com.sun.syndication.feed.impl)
 equals:495, AbstractMap (java.util)
 reconstitutionPut:1241, Hashtable (java.util)
 readObject:1215, Hashtable (java.util)
 ```



### 我就说好熟悉，果不其然前几天刚遇到，我丢这出题只把kryo序列化改成了普通的序列化！！！

![image-20231126182642622](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126182642622.png)

上次的题是 kryo+rome二次反序列化做的，这道题多了一个黑名单的限制

![image-20231126182906479](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126182906479.png)

对比而言卡的是二次反序列化后面的类，二次反序列化还是可以正常执行的

### `此时疑问：二次反序列化的链子还会被拦截嘛`

试了这种resolveClass是会被拦截的

![image-20231126193430531](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126193430531.png)

那就是改这个二次反序列化后的结果，都禁了。。。

```java
HashMap::readObject->hash->key.hashcode
ObjectBean::hashCode
       EqualsBean::beanHashCode
                     ObjectBean::toString()
                            ToStringBean::toString() 
                                   ToStringBean::toString()方法中的 invoke执行
```

找了一下hessian原生jdk链子缺少依赖也打不通

## 没思路了看看其他给出的类 

给了一个CoffeeBean类实现序列化 接口，并且有toString方法可以执行任何代码，所以出口肯定是调用CoffeeBean#toString方法，并且反射修改ClassByte的值

```java
public class CoffeeBean extends ClassLoader implements Serializable {
    private String name = "Coffee bean";
    private byte[] ClassByte;

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override // java.lang.Object
    public String toString() {
        try {
            new CoffeeBean().defineClass(null, this.ClassByte, 0, this.ClassByte.length).newInstance();
            return "A cup of Coffee --";
        } catch (IllegalAccessException var6) {
            var6.printStackTrace();
            return "A cup of Coffee --";
        } catch (InstantiationException var5) {
            var5.printStackTrace();
            return "A cup of Coffee --";
        }
    }
}
```

```java
HashMap::readObject->hash->key.hashcode
EqualsBean::hashCode//也没了
       EqualsBean::beanHashCode  //到这里都没被过滤
           
           
           
                     ObjectBean::toString()  //下面全过滤了
                            ToStringBean::toString() 
                                   ToStringBean::toString()方法中的 invoke执行
```

？？？这不是直接通了嘛这条链子

```java
HashMap#readObject
    EqualsBean#hashCode
       EqualsBean#beanHashCode
            CoffeeBean#toString
无语。。。烂题
```

![image-20231126201132614](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126201132614.png)
